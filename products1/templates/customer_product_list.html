<div id="edgeband-filters" class="mb-3">
  <div class="row g-2">

    <div class="col-md-4">
      <label class="form-label">Brand</label>
      <select id="filter-edgeband-brand" class="form-select">
        <option value="">All Brands</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Depth (mm)</label>
      <select id="filter-edgeband-depth" class="form-select">
        <option value="">All Depths</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Thickness (mm)</label>
      <select id="filter-edgeband-thickness" class="form-select">
        <option value="">All Thickness</option>
      </select>
    </div>

  </div>
</div>

<table class="table table-sm table-bordered">
  <thead class="table-light">
    <tr>
      <th>Brand</th>
      <th>Depth</th>
      <th>Thickness</th>
      <th>Min Price</th>
      <th>Whitelist</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody id="edgeband-body"></tbody>
</table>

<div class="mt-3">
  <strong>Whitelist:</strong>
  <div id="edgeband-whitelist"></div>
</div>

<div class="mt-2">
  <strong>Default:</strong>
  <div id="edgeband-default"></div>
</div>
<script>
    console.clear();
console.log("âœ… EDGEBAND JS EXECUTING");

let EDGEBANDS = [];
let NAMES = [];
let MERGED = [];

let WHITELIST = new Set();
let DEFAULT_ID = null;

const selBrand = document.getElementById("filter-edgeband-brand");
const selDepth = document.getElementById("filter-edgeband-depth");
const selThickness = document.getElementById("filter-edgeband-thickness");

const tbody = document.getElementById("edgeband-body");
const whitelistBox = document.getElementById("edgeband-whitelist");
const defaultBox = document.getElementById("edgeband-default");

function resetSelect(sel, label) {
  sel.innerHTML = `<option value="">${label}</option>`;
}

function fillSelect(sel, items, valueKey, labelFn) {
  const current = sel.value;
  resetSelect(sel, sel.options[0].textContent);

  const seen = new Set();
  items.forEach(i => {
    const val = String(i[valueKey]);
    if (seen.has(val)) return;
    seen.add(val);

    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = labelFn(i);
    sel.appendChild(opt);
  });

  if ([...sel.options].some(o => o.value === current)) {
    sel.value = current;
  }
}

async function loadData() {
  const [ebRes, nameRes] = await Promise.all([
    fetch("/material/v1/edgebands/").then(r => r.json()),
    fetch("/material/v1/edgeband-names/").then(r => r.json())
  ]);

  EDGEBANDS = ebRes.results || [];
  NAMES = nameRes.results || [];

  MERGED = EDGEBANDS.map(e => {
    const name = NAMES.find(n => n.id === e.edgeband_name);
    return {
      ...e,
      brand: name?.brand,
      brand_name: name?.brand_name,
      depth: name?.depth
    };
  });

  console.log("ðŸ“¦ MERGED DATA", MERGED);
  initFilters();
  applyFilters();
}

function initFilters() {
  selBrand.onchange = applyFilters;
  selDepth.onchange = applyFilters;
  selThickness.onchange = applyFilters;
}

function applyFilters() {
  const b = selBrand.value || null;
  const d = selDepth.value || null;
  const t = selThickness.value || null;

  console.log("ðŸŽ¯ FILTER STATE", { b, d, t });

  const filtered = MERGED.filter(x => {
    if (b && String(x.brand) !== b) return false;
    if (d && String(x.depth) !== d) return false;
    if (t && String(x.thickness) !== t) return false;
    return true;
  });

  fillSelect(selBrand, filtered, "brand", x => x.brand_name);
  fillSelect(selDepth, filtered, "depth", x => `${x.depth} mm`);
  fillSelect(selThickness, filtered, "thickness", x => `${x.thickness} mm`);

  renderTable(filtered);
}

function renderTable(rows) {
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.brand_name}</td>
      <td>${r.depth} mm</td>
      <td>${r.thickness} mm</td>
      <td>${r.min_price}</td>
      <td><input type="checkbox" ${WHITELIST.has(r.id) ? "checked" : ""} onclick="toggleWB(${r.id})"></td>
      <td><input type="radio" name="ed_default" ${DEFAULT_ID === r.id ? "checked" : ""} onclick="setDef(${r.id})"></td>
    `;
    tbody.appendChild(tr);
  });

  console.log("ðŸ“Š TABLE ROWS", rows.length);
}

window.toggleWB = id => {
  WHITELIST.has(id) ? WHITELIST.delete(id) : WHITELIST.add(id);
  if (!WHITELIST.has(DEFAULT_ID)) DEFAULT_ID = null;
  updatePreview();
};

window.setDef = id => {
  if (!WHITELIST.has(id)) return;
  DEFAULT_ID = id;
  updatePreview();
};

function updatePreview() {
  whitelistBox.innerHTML = [...WHITELIST].join(", ");
  defaultBox.innerHTML = DEFAULT_ID || "â€”";
  console.log("ðŸ“¤ PAYLOAD", {
    whitelist_edgebands: [...WHITELIST],
    default_edgeband: DEFAULT_ID
  });
}

loadData();

</script>