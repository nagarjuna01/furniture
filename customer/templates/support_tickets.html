{% extends 'base.html' %}
{% block title %}Support Tickets{% endblock %}

{% block content %}
<div x-data="ticketManager()" x-init="fetchTickets()">
    <div class="d-flex justify-content-between align-items-center">
        <h3>Support Tickets</h3>
        <button class="btn btn-primary my-2" @click="openModal()">Add Ticket</button>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th><th>Customer</th><th>Subject</th><th>Description</th><th>Status</th><th>Priority</th><th>Assigned</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="t in tickets" :key="t.id">
                <tr>
                    <td x-text="t.id"></td>
                    <td x-text="t.customer || '-'"></td>
                    <td x-text="t.subject"></td>
                    <td x-text="t.description || '-'"></td>
                    <td>
                        <span class="badge" :class="statusBadge(t.status)" x-text="t.status"></span>
                    </td>
                    <td>
                        <span class="badge" :class="priorityBadge(t.priority)" x-text="t.priority"></span>
                    </td>
                    <td x-text="t.assigned_to || '-'"></td>
                    <td>
                        <button class="btn btn-sm btn-warning" @click="editTicket(t)">Edit</button>
                        <button class="btn btn-sm btn-danger" @click="deleteTicket(t.id)">Delete</button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <div class="modal fade" id="ticketModal" tabindex="-1" x-ref="modal">
        <div class="modal-dialog">
            <form @submit.prevent="saveTicket()" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="formData.id ? 'Edit Ticket #' + formData.id : 'Create Support Ticket'"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="small fw-bold">Customer ID</label><input type="number" x-model="formData.customer" class="form-control" required></div>
                    <div class="mb-3"><label class="small fw-bold">Subject</label><input type="text" x-model="formData.subject" class="form-control" required></div>
                    <div class="mb-3"><label class="small fw-bold">Description</label><textarea x-model="formData.description" class="form-control" rows="3"></textarea></div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label class="small fw-bold">Status</label>
                            <select x-model="formData.status" class="form-select">
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="small fw-bold">Priority</label>
                            <select x-model="formData.priority" class="form-select">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3"><label class="small fw-bold">Assigned To (User ID)</label><input type="number" x-model="formData.assigned_to" class="form-control"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" x-text="formData.id ? 'Update Ticket' : 'Save Ticket'"></button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('ticketManager', () => ({
        tickets: [],
        formData: {
            id: null,
            customer: '',
            subject: '',
            description: '',
            status: 'open',
            priority: 'medium',
            assigned_to: ''
        },
        bsModal: null,

        init() {
            this.bsModal = new bootstrap.Modal(this.$refs.modal);
        },

        async fetchTickets() {
            const res = await fetch('/customers/v1/support-tickets/');
            this.tickets = await res.json();
        },

        openModal(data = null) {
            if (data) {
                this.formData = { ...data };
            } else {
                this.formData = { id: null, customer: '', subject: '', description: '', status: 'open', priority: 'medium', assigned_to: '' };
            }
            this.bsModal.show();
        },

        async saveTicket() {
            const id = this.formData.id;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/customers/v1/support-tickets/${id}/` : '/customers/v1/support-tickets/';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    body: JSON.stringify(this.formData)
                });

                if (res.ok) {
                    window.showToast('Ticket saved successfully', 'success');
                    this.bsModal.hide();
                    this.fetchTickets();
                } else {
                    const error = await res.text();
                    window.showToast(error, 'error');
                }
            } catch (err) {
                window.showToast('Network error', 'error');
            }
        },

        editTicket(ticket) {
            this.openModal(ticket);
        },

        async deleteTicket(id) {
            if (!confirm('Delete this ticket?')) return;
            
            const res = await fetch(`/customers/v1/support-tickets/${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': window.CSRF_TOKEN }
            });

            if (res.ok) {
                window.showToast('Ticket deleted', 'success');
                this.fetchTickets();
            }
        },

        // UI Helpers
        statusBadge(status) {
            return {
                'bg-info': status === 'open',
                'bg-warning': status === 'in_progress',
                'bg-success': status === 'resolved',
                'bg-secondary': status === 'closed'
            }
        },

        priorityBadge(priority) {
            return {
                'bg-danger': priority === 'high',
                'bg-primary': priority === 'medium',
                'bg-dark': priority === 'low'
            }
        }
    }));
});
</script>
{% endblock %}