{% extends 'base_crm.html' %}
{% block title %}Opportunities{% endblock %}

{% block content %}
<h3>Opportunities</h3>
<button class="btn btn-primary my-2" data-bs-toggle="modal" data-bs-target="#opportunityModal">Add Opportunity</button>

<table class="table table-bordered" id="opportunities-table">
    <thead>
        <tr>
            <th>ID</th><th>Name</th><th>Lead</th><th>Customer</th><th>Stage</th><th>Expected Close</th><th>Amount</th><th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal for Create/Edit -->
<div class="modal fade" id="opportunityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="opportunity-form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Opportunity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <input type="hidden" id="opportunity-id">
        <div class="mb-3"><label>Name</label><input type="text" id="name" class="form-control" required></div>
        <div class="mb-3"><label>Lead ID</label><input type="number" id="lead" class="form-control"></div>
        <div class="mb-3"><label>Customer ID</label><input type="number" id="customer" class="form-control"></div>
        <div class="mb-3">
            <label>Stage</label>
            <select id="stage" class="form-select">
                <option value="prospecting">Prospecting</option>
                <option value="qualification">Qualification</option>
                <option value="proposal">Proposal</option>
                <option value="negotiation">Negotiation</option>
                <option value="closed_won">Closed Won</option>
                <option value="closed_lost">Closed Lost</option>
            </select>
        </div>
        <div class="mb-3"><label>Expected Close Date</label><input type="date" id="expected_close_date" class="form-control"></div>
        <div class="mb-3"><label>Amount</label><input type="number" step="0.01" id="amount" class="form-control"></div>
        <div class="mb-3"><label>Probability (%)</label><input type="number" step="0.01" id="probability" class="form-control" value="0"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function fetchOpportunities() {
    $.get('/customerCRM/api/opportunities/', function(data){
        let rows = '';
        data.forEach(o => {
            rows += `<tr>
                <td>${o.id}</td>
                <td>${o.name}</td>
                <td>${o.lead || '-'}</td>
                <td>${o.customer || '-'}</td>
                <td>${o.stage}</td>
                <td>${o.expected_close_date || '-'}</td>
                <td>${o.amount || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-opportunity" data-id="${o.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-opportunity" data-id="${o.id}">Delete</button>
                </td>
            </tr>`;
        });
        $('#opportunities-table tbody').html(rows);
    });
}

$(document).ready(function(){
    fetchOpportunities();

    $('#opportunity-form').submit(function(e){
        e.preventDefault();
        let id = $('#opportunity-id').val();
        let method = id ? 'PUT' : 'POST';
        let url = id ? `/customerCRM/api/opportunities/${id}/` : '/customerCRM/api/opportunities/';
        $.ajax({
            type: method,
            url: url,
            headers: {'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()},
            data: {
                name: $('#name').val(),
                lead: $('#lead').val(),
                customer: $('#customer').val(),
                stage: $('#stage').val(),
                expected_close_date: $('#expected_close_date').val(),
                amount: $('#amount').val(),
                probability: $('#probability').val()
            },
            success: function(){
                toastr.success('Saved successfully');
                $('#opportunityModal').modal('hide');
                fetchOpportunities();
                $('#opportunity-form')[0].reset();
                $('#opportunity-id').val('');
            },
            error: function(xhr){ toastr.error(xhr.responseText); }
        });
    });

    $(document).on('click', '.edit-opportunity', function(){
        let id = $(this).data('id');
        $.get(`/customerCRM/api/opportunities/${id}/`, function(o){
            $('#opportunity-id').val(o.id);
            $('#name').val(o.name);
            $('#lead').val(o.lead);
            $('#customer').val(o.customer);
            $('#stage').val(o.stage);
            $('#expected_close_date').val(o.expected_close_date);
            $('#amount').val(o.amount);
            $('#probability').val(o.probability);
            $('#opportunityModal').modal('show');
        });
    });

    $(document).on('click', '.delete-opportunity', function(){
        if(!confirm('Delete this opportunity?')) return;
        let id = $(this).data('id');
        $.ajax({
            type: 'DELETE',
            url: `/customerCRM/api/opportunities/${id}/`,
            headers: {'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()},
            success: function(){ toastr.success('Deleted'); fetchOpportunities(); },
            error: function(xhr){ toastr.error(xhr.responseText); }
        });
    });
});
</script>
{% endblock %}
