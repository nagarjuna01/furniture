<div class="container-fluid" id="quote-app" 
     x-data="quoteWorkspace()" 
     data-quote-id="{{ quote_id }}">

  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0 text-primary fw-bold" x-text="'Quote #' + quote.quote_number">Quote #---</h4>
        <div class="d-flex align-items-center gap-2 mt-1">
          <span class="badge" 
                :class="quote.status === 'draft' ? 'bg-warning' : 'bg-success'"
                x-text="quote.status.toUpperCase()"></span>
        </div>
      </div>
      
      <div class="d-flex align-items-center gap-2 p-2 bg-light rounded border">
        <div class="small text-muted">Target Zone:</div>
        <div class="badge" 
             :class="activeSolution ? 'bg-primary' : 'bg-danger'" 
             x-text="activeSolutionName"></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
      <div class="card mt-3 bg-dark text-white border-0 shadow-sm">
        <div class="card-body">
            <label class="small text-uppercase opacity-75">Grand Total (Inc. Tax)</label>
            <h3 class="mb-0 fw-bold" x-text="new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(quote.total_sp)">$0.00</h3>
        </div>
      </div>
      
      <div class="card mt-3 border-0 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-white">
          <span class="fw-bold">Project Zones</span>
          <button class="btn btn-sm btn-primary rounded-circle" @click="openAddSolutionModal()">+</button>
        </div>
        <div class="list-group list-group-flush">
            <template x-for="sol in quote.solutions" :key="sol.id">
                <button class="list-group-item list-group-item-action d-flex justify-content-between"
                        :class="activeSolution?.id === sol.id ? 'active' : ''"
                        @click="activeSolution = sol">
                    <span x-text="sol.name"></span>
                    <span class="badge bg-light text-dark" x-text="sol.products.length"></span>
                </button>
            </template>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div id="solution-canvas">
          <template x-if="!activeSolution">
              <div class="card border-0 shadow-sm">
                  <div class="card-body text-center py-5">
                      <i class="fas fa-drafting-compass fa-3x text-light mb-3"></i>
                      <h5 class="text-muted">Select a Project Zone to begin configuring DNA</h5>
                  </div>
              </div>
          </template>
          
          <template x-if="activeSolution">
              <div class="card border-0 shadow-sm">
                  <div class="card-header bg-white d-flex justify-content-between">
                      <h5 x-text="activeSolution.name"></h5>
                      <button class="btn btn-sm btn-dark" @click="openAddProductModal()">Add Product</button>
                  </div>
                  <div class="card-body">
                      <div class="border rounded bg-light" style="height: 400px;"></div>
                  </div>
              </div>
          </template>
      </div>
    </div>
  </div> 
</div>

// static/js/quote_workspace.js
document.addEventListener('alpine:init', () => {
    Alpine.data('quoteWorkspace', () => ({
        quoteId: document.getElementById('quote-app').dataset.quoteId,
        quote: { client: {}, solutions: [], grand_total: 0, status: 'loading' },
        activeSolution: null,
        loading: true,

        async init() {
            await this.fetchQuote();
            this.loading = false;
        },

        async fetchQuote() {
            const res = await fetch(`/quoting/api/quotes/${this.quoteId}/`);
            this.quote = await res.json();
        },

        get activeSolutionName() {
            return this.activeSolution ? this.activeSolution.name : 'NO ZONE SELECTED';
        },

        async addSolution(name) {
            const res = await fetch(`/quoting/api/solutions/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ quote: this.quoteId, name: name })
            });
            if (res.ok) await this.fetchQuote();
        }
    }));
});
// Add inside Alpine.data('quoteWorkspace', ...)
registry: {
    mode: 'modular', // 'modular' or 'standard'
    search: '',
    filters: { l1: '', l2: '', l3: '', l4: '' },
    items: [], // Raw items from API
    
    get filteredItems() {
        return this.items.filter(item => {
            const matchesMode = item.type === this.mode;
            const matchesL1 = !this.filters.l1 || item.category === this.filters.l1;
            const matchesSearch = !this.search || 
                item.name.toLowerCase().includes(this.search.toLowerCase()) ||
                item.code.toLowerCase().includes(this.search.toLowerCase());
            return matchesMode && matchesL1 && matchesSearch;
        });
    },

    selectProduct(product) {
        // Trigger the LBH Configurator
        this.$dispatch('product-selected', product);
    }
}
// static/js/quote_pipeline.js
document.addEventListener('alpine:init', () => {
    Alpine.data('quotePipeline', () => ({
        quotes: [],
        search: '',
        statusFilter: '',
        loading: true,

        async init() {
            await this.fetchQuotes();
            this.loading = false;
        },

        async fetchQuotes() {
            // This hits your DRF ViewSet
            const url = `/quoting/api/quotes/?search=${this.search}&status=${this.statusFilter}`;
            const res = await fetch(url);
            this.quotes = await res.json();
        },

        // Reactive Stats
        get stats() {
            return {
                drafts: this.quotes.filter(q => q.status === 'draft').length,
                approved: this.quotes.filter(q => q.status === 'approved').length,
                locked: this.quotes.filter(q => q.status === 'locked').length,
                revenue: this.quotes.reduce((sum, q) => sum + parseFloat(q.total_sp || 0), 0)
            };
        }
    }));
});
// Add to your Alpine workspace store
partOverride: {
    isOpen: false,
    data: {
        id: null,
        material_id: null,
        quantity: 0,
        rate: 0
    },

    loadPart(part) {
        this.data = { ...part };
        this.isOpen = true;
        // Trigger Select2 update if necessary
        $('#override-material').val(part.material_id).trigger('change');
    },

    async save() {
        const res = await fetch(`/api/parts/${this.data.id}/override/`, {
            method: 'PATCH',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                material: this.data.material_id,
                quantity: this.data.quantity,
                rate_override: this.data.rate,
                is_manual: true // Critical flag
            })
        });

        if (res.ok) {
            // Re-fetch quote to update Grand Total
            Alpine.store('quoteApp').fetchQuote();
            this.isOpen = false;
        }
    }
}
// Add to your Alpine data object
hardwareOverride: {
    isOpen: false,
    current: { id: null, qty: 0, rate: 0, name: '' },

    open(hw) {
        this.current = { 
            id: hw.id, 
            qty: hw.quantity, 
            rate: hw.rate_override || hw.base_rate,
            name: hw.name 
        };
        this.isOpen = true;
    },

    async save() {
        const payload = {
            quantity: this.current.qty,
            rate_override: this.current.rate,
            is_manual: true
        };
        
        const res = await fetch(`/quoting/api/hardware/${this.current.id}/`, {
            method: 'PATCH',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            this.isOpen = false;
            // Global refresh to update the "Exhaust" (Grand Total)
            this.fetchQuote(); 
        }
    }
}
// Inside your Alpine data object
bulk: {
    selectedIds: [],
    
    toggle(id) {
        if (this.selectedIds.includes(id)) {
            this.selectedIds = this.selectedIds.filter(i => i !== id);
        } else {
            this.selectedIds.push(id);
        }
    },

    async runAction(actionType) {
        // actionType: 'expand', 'freeze', or 'recalc'
        const res = await fetch(`/quoting/api/products/bulk-action/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({
                ids: this.selectedIds,
                action: actionType
            })
        });
        
        if (res.ok) {
            this.selectedIds = []; // Clear selection
            this.$dispatch('refresh-quote'); // Update the Exhaust
        }
    }
}
// Add to quoteWorkspace
compareRevision(revId) {
    const currentData = this.quote;
    const oldData = this.revisions.find(r => r.id === revId);
    
    // Simple logic to find price delta
    const delta = currentData.total_sp - oldData.total_sp;
    
    return {
        diff: delta,
        status: delta > 0 ? 'Price Increased' : 'Price Decreased',
        color: delta > 0 ? 'text-danger' : 'text-success'
    };
}