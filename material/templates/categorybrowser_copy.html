{% extends 'base_b.html'%}
{% block content %}

<style>
  .table-responsive {
  overflow-x: auto;   /* allow scrolling if table too wide */
}

#woodensTable th,
#woodensTable td {
  white-space: normal;
  word-break: break-word;
  font-size: 0.875rem;
  padding: 0.5rem;
  text-align: center;
  vertical-align: middle;
}

/* Fixed numeric columns */
#woodensTable th:nth-child(6),
#woodensTable td:nth-child(6), /* Length */
#woodensTable th:nth-child(7),
#woodensTable td:nth-child(7), /* Width */
#woodensTable th:nth-child(8),
#woodensTable td:nth-child(8)  /* Thickness */ {
  width: 70px;
  min-width: 70px;
  white-space: nowrap;
  text-align: right;   /* better for numbers */
}

</style>
<div class="container mt-4">
  <ul class="nav nav-tabs" id="materialTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="wooden-tab" data-bs-toggle="tab" data-bs-target="#wooden" type="button">Panels</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button">Categories</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="category-type-tab" data-bs-toggle="tab" data-bs-target="#category-type" type="button">Category Types</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="category-model-tab" data-bs-toggle="tab" data-bs-target="#category-model" type="button">Category Models</button>
    </li>
    
  </ul>

  <div class="tab-content mt-3">
    <!-- Categories Tab -->
    <div class="tab-pane fade" id="category">
      <div class="mb-2">
        <button class="btn btn-primary btn-sm" id="addCategoryBtn">Add Category</button>
        <input type="text" id="categorySearch" placeholder="Search Categories..." class="form-control form-control-sm d-inline-block w-auto ms-2">
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="categoriesTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-outline-secondary" id="categoryPrev">Prev</button>
        <span id="categoryCount"></span>
        <button class="btn btn-sm btn-outline-secondary" id="categoryNext">Next</button>
      </div>
    </div>

    <!-- Category Types Tab -->
    <div class="tab-pane fade" id="category-type">
      <div class="mb-2">
        <button class="btn btn-primary btn-sm" id="addCategoryTypeBtn">Add Category Type</button>
        <input type="text" id="categoryTypeSearch" placeholder="Search Types..." class="form-control form-control-sm d-inline-block w-auto ms-2">
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="categoryTypesTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-outline-secondary" id="categoryTypePrev">Prev</button>
        <span id="categoryTypeCount"></span>
        <button class="btn btn-sm btn-outline-secondary" id="categoryTypeNext">Next</button>
      </div>
    </div>

    <!-- Category Models Tab -->
    <div class="tab-pane fade" id="category-model">
      <div class="mb-2">
        <button class="btn btn-primary btn-sm" id="addCategoryModelBtn">Add Category Model</button>
        <input type="text" id="categoryModelSearch" placeholder="Search Models..." class="form-control form-control-sm d-inline-block w-auto ms-2">
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="categoryModelsTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Category Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-outline-secondary" id="categoryModelPrev">Prev</button>
        <span id="categoryModelCount"></span>
        <button class="btn btn-sm btn-outline-secondary" id="categoryModelNext">Next</button>
      </div>
    </div>

    <!-- WoodEn Tab -->
    <div class="tab-pane fade show active" id="wooden">
      <div class="mb-2">
        <button class="btn btn-outline-danger btn-sm ms-2" id="resetWoodenFilters">Reset Filters</button>
        <button class="btn btn-primary btn-sm" id="addWoodenBtn">Add Panel</button>
        </div>
      <div class="row mb-3">
  
  <div class="table-responsive">
  <table class="table table-bordered table-hover align-middle" id="woodensTable">
    <thead class="table-light">
      <tr>
        <th>Name<br>
          <input type="text" id="filterName" class="form-control form-control-sm" placeholder="Search">
        </th>
        <th>Category<br>
          <select id="filterCategory" class="form-select form-select-sm">
            <option value="">All</option>
          </select>
        </th>
        <th>Type<br>
          <select id="filterType" class="form-select form-select-sm"
                  disabled
                  data-bs-toggle="tooltip"
                  title="Select a Category first to view available Types">
            <option value="">All</option>
          </select>
        </th>
        <th>Model<br>
          <select id="filterModel" class="form-select form-select-sm"
                  disabled
                  data-bs-toggle="tooltip"
                  title="Select a Type first to view available Models">
            <option value="">All</option>
          </select>
        </th>
        <th>Brand<br>
          <select id="filterBrand" class="form-select form-select-sm">
            <option value="">All</option>
          </select>
        </th>
        <th>Length(mm)</th>
        <th>Width(mm)</th>
        <th>Thickness(mm)</th>
        <th>Purchase Price (Panel / Sqft)</th>
        <th>Selling Price (Panel / Sqft)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


      <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-outline-secondary" id="woodenPrev">Prev</button>
        <span id="woodenCount"></span>
        <button class="btn btn-sm btn-outline-secondary" id="woodenNext">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Modals for CRUD -->
<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="categoryForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categoryId">
        <div class="mb-2">
          <label>Name</label>
          <input type="text" id="categoryName" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Category Type Modal -->
<div class="modal fade" id="categoryTypeModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="categoryTypeForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryTypeModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categoryTypeId">
        <div class="mb-2">
          <label>Name</label>
          <input type="text" id="categoryTypeName" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Category</label>
          <select id="categoryTypeCategoryId" class="form-select" required></select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Category Model Modal -->
<div class="modal fade" id="categoryModelModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="categoryModelForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModelModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categoryModelId">
        <div class="mb-2">
            <label>Category</label>
            <select id="categoryModelCategoryId" class="form-select" required></select>
          </div>

          <div class="mb-2">
            <label>Category Type</label>
            <select id="categoryModelTypeId" class="form-select" required disabled></select>
          </div>
        
        <div class="mb-2">
          <label>Name</label>
          <input type="text" id="categoryModelName" class="form-control" required>
        </div>
        
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Wood Material Modal -->
<div class="modal fade" id="woodenModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <form id="woodenForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="woodenModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body row g-2">
        <input type="hidden" id="woodenId">

        <!-- Basic -->
        <div class="col-md-3">
          <label class="form-label">Name</label>
          <input type="text" id="woodenName" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Category</label>
          <select id="woodenCategoryId" class="form-select" required></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Category Type</label>
          <select id="woodenTypeId" class="form-select"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Category Model</label>
          <select id="woodenModelId" class="form-select"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Brand</label>
          <select id="woodenBrandId" class="form-select"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Grain</label>
          <select id="woodenGrain" class="form-select">
            <option value="NONE">None</option>
            <option value="HORIZONTAL">Horizontal</option>
            <option value="VERTICAL">Vertical</option>
          </select>
        </div>

        <!-- Dimensions -->
        <div class="col-md-2">
          <label class="form-label">Length</label>
          <input type="number" step="0.001" id="woodenLength" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Length Unit</label>
          <select id="woodenLengthUnit" class="form-select" required></select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Width</label>
          <input type="number" step="0.001" id="woodenWidth" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Width Unit</label>
          <select id="woodenWidthUnit" class="form-select" required></select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Thickness</label>
          <input type="number" step="0.001" id="woodenThickness" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Thickness Unit</label>
          <select id="woodenThicknessUnit" class="form-select" required></select>
        </div>

        <!-- Pricing -->
        <div class="col-md-3">
          <label class="form-label">Cost Price</label>
          <input type="number" step="0.01" id="woodenCostPrice" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Cost Unit</label>
          <select id="woodenCostUnit" class="form-select" required></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Sell Price</label>
          <input type="number" step="0.01" id="woodenSellPrice" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Sell Unit</label>
          <select id="woodenSellUnit" class="form-select" required></select>
        </div>

        <!-- Meta -->
        <div class="col-md-3">
          <label class="form-label">Color</label>
          <input type="text" id="woodenColor" class="form-control">
        </div>

        <div class="col-md-3 d-flex align-items-center mt-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="woodenIsSheet">
            <label class="form-check-label">Is Sheet</label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
<!-- Bootstrap JS Bundle -->
{% block extra_js %}
<script>
// ===== API Endpoints =====
const API = {
  categories: "/material/v1/categories/",
  categoryTypes: "/material/v1/category-types/",
  categoryModels: "/material/v1/category-models/",
  woodens: "/material/v1/woodens/",
  brands: "/material/v1/brands/",
  measurementUnits: "/material/v1/measurement-units/",
  billingUnits: "/material/v1/billing-units/"
};

// ===== Helper Functions =====
function handleApiError(err) {
    console.error(err);

    let msg = "Unexpected error";

    if (err.responseJSON) {
        // Handle non-field errors
        if (err.responseJSON.non_field_errors) {
            msg = err.responseJSON.non_field_errors.join("\n");
        } else {
            // Collect field-specific errors
            msg = Object.entries(err.responseJSON)
                        .map(([k,v]) => `${k}: ${v.join ? v.join(", ") : v}`)
                        .join("\n");
        }
    } else if (err.responseText) {
        msg = err.responseText;
    }

    // Replace alert() with your toast function
    showToast(msg, "error");  // assumes showToast(message, type)
}
function toArrayOrResults(res){
    if(Array.isArray(res)) return { results: res, count: res.length, next: null, previous: null };
    if(res && Array.isArray(res.results)) return res;
    return { results: [], count: 0, next: null, previous: null };
}

// ===== Debounce =====
function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// ====== GLOBAL DROPDOWN LOADERS ======
function loadBrands($el){
  $.get(API.brands, function(data){
    const rows = data.results || data;
    $el.html('<option value="">All Brands</option>');
    rows.forEach(b=> $el.append(`<option value="${b.id}">${b.name}</option>`));
  });
}

function loadMeasurementUnits($el, selectedValue = null) {
    return $.get(API.measurementUnits, function(res) {
        const rows = res.results || res;
        $el.html('<option value="">Unit</option>');
        rows.forEach(u => {
            $el.append(`<option value="${u.id}">${u.name} (${u.code})</option>`);
        });
        if (selectedValue) $el.val(selectedValue);
    }).fail(handleApiError);
}

function loadBillingUnits($el, selectedValue = null) {
    return $.get(API.billingUnits, function(res) {
        const rows = res.results || res;
        $el.html('<option value="">Unit</option>');
        rows.forEach(u => {
            $el.append(`<option value="${u.id}">${u.name}</option>`);
        });
        if (selectedValue) $el.val(selectedValue);
    }).fail(handleApiError);
}

function loadCategoriesOptions() {
    return $.get(API.categories, function(data) {
        const rows = data.results || data;
        let headerOptions = '<option value="">All</option>';
        let modalOptions = '<option value="">--Select Category--</option>';
        rows.forEach(c => {
            headerOptions += `<option value="${c.id}">${c.name}</option>`;
            modalOptions += `<option value="${c.id}">${c.name}</option>`;
        });
        $("#filterCategory").html(headerOptions);
        $("#woodenCategoryId").html(modalOptions);
    });
}

function loadCategoryModelCategories(){
    $.get(API.categories, function(res){
        const options = res.results.map(c =>
            `<option value="${c.id}">${c.name}</option>`
        ).join("");

        $("#categoryModelCategoryId")
            .html(`<option value="">Select Category</option>` + options);
    });
}
$("#categoryModelCategoryId").on("change", function(){
    const catId = $(this).val();

    $("#categoryModelTypeId")
        .prop("disabled", true)
        .html(`<option value="">Select Type</option>`);

    if(!catId) return;

    $.get(API.categoryTypes, { category: catId }, function(res){
        const options = res.results.map(t =>
            `<option value="${t.id}">${t.name}</option>`
        ).join("");

        $("#categoryModelTypeId")
            .prop("disabled", false)
            .append(options);
    });
});


// ======== CATEGORIES CRUD =========
function loadCategories(url){
  const search = $("#categorySearch").val() || "";
    const fetchUrl = url || (API.categories + (search ? `?search=${search}` : ""));
    $.get(fetchUrl, function(res){
        const data = toArrayOrResults(res);
        const rows = (data.results || []).map(c => `
            <tr data-id="${c.id}">
                <td>${c.name}</td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-warning me-1 btn-edit-cat">Edit</button>
                    <button class="btn btn-sm btn-danger btn-del-cat">Delete</button>
                </td>
            </tr>
        `).join("");
        $("#categoriesTable tbody").html(rows);
        $("#categoriesPrev").prop("disabled", !data.previous).off("click").on("click", ()=> loadCategories(data.previous));
        $("#categoriesNext").prop("disabled", !data.next).off("click").on("click", ()=> loadCategories(data.next));
        $("#categoriesCount").text(`${data.count} items`);
    }).fail(handleApiError);
}

// Category form submit
$("#categoryForm").on("submit", function(e){
    e.preventDefault();
    const id = $("#categoryId").val();
    const name = $("#categoryName").val().trim();
    if(!name){ alert("Name required"); return; }

    $.get(API.categories, { search: name }, function(res){
        const duplicate = res.results.find(c => c.name.toLowerCase() === name.toLowerCase() && c.id != id);
        if(duplicate){ showToast("Category already exists", "error"); $("#categoryModal").modal("hide"); return; }

        const payload = { name };
        const req = id
          ? $.ajax({ url: API.categories+id+"/", type:"PUT", data:JSON.stringify(payload), contentType:"application/json", headers: { "X-CSRFToken": window.CSRF_TOKEN } })
          : $.ajax({ url: API.categories, type:"POST", data:JSON.stringify(payload), contentType:"application/json", headers: { "X-CSRFToken": window.CSRF_TOKEN } });

        req.done(()=> { $("#categoryModal").modal("hide"); loadCategories(); }).fail(handleApiError);
    }).fail(handleApiError);
});

// Edit & Delete
$("#categoriesTable").on("click", ".btn-edit-cat", function(){
    const id = $(this).closest("tr").data("id");
    $.get(API.categories+id+"/", function(c){
        $("#categoryId").val(c.id);
        $("#categoryName").val(c.name);
        $("#categoryModalTitle").text("Edit Category");
        $("#categoryModal").modal("show");
    }).fail(handleApiError);
});
$("#categoriesTable").on("click", ".btn-del-cat", function(){
    if(!confirm("Delete this category?")) return;
    const id = $(this).closest("tr").data("id");
    $.ajax({ url: API.categories+id+"/", type:"DELETE" }).done(()=> loadCategories()).fail(handleApiError);
});
$("#categorySearch").on("input", debounce(()=> loadCategories(), 400));
$("#addCategoryBtn").click(()=> { $("#categoryModalTitle").text("Add Category"); $("#categoryForm")[0].reset(); $("#categoryId").val(""); $("#categoryModal").modal("show"); });

// ======== CATEGORY TYPES CRUD =========
function loadCategoryTypes(url){
    const search = $("#categoryTypeSearch").val() || "";
    const fetchUrl = url || (API.categoryTypes + (search ? `?search=${search}` : ""));
    $.get(fetchUrl, function(res){
        const data = toArrayOrResults(res);
        const rows = (data.results || []).map(t => `
            <tr data-id="${t.id}">
                <td>${t.name}</td>
                <td>${t.category_label || '-'}</td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-warning me-1 btn-edit-type">Edit</button>
                    <button class="btn btn-sm btn-danger btn-del-type">Delete</button>
                </td>
            </tr>
        `).join("");
        $("#categoryTypesTable tbody").html(rows);
        $("#categoryTypesPrev").prop("disabled", !data.previous).off("click").on("click", ()=> loadCategoryTypes(data.previous));
        $("#categoryTypesNext").prop("disabled", !data.next).off("click").on("click", ()=> loadCategoryTypes(data.next));
        $("#categoryTypesCount").text(`${data.count} items`);
    }).fail(handleApiError);
}

// CategoryType form submit
$("#categoryTypeForm").on("submit", function(e){
    e.preventDefault();
    const id = $("#categoryTypeId").val();
    const payload = {
        name: $("#categoryTypeName").val(),
        category: $("#categoryTypeCategoryId").val()
    };
    const req = id
      ? $.ajax({ url: API.categoryTypes+id+"/", type:"PUT", data:JSON.stringify(payload), contentType:"application/json", headers:{ "X-CSRFToken": window.CSRF_TOKEN } })
      : $.ajax({ url: API.categoryTypes, type:"POST", data:JSON.stringify(payload), contentType:"application/json", headers:{ "X-CSRFToken": window.CSRF_TOKEN } });
    req.done(()=> { $("#categoryTypeModal").modal("hide"); loadCategoryTypes(); }).fail(handleApiError);
});

// Edit & Delete
$("#categoryTypesTable").on("click", ".btn-edit-type", function(){
    const id = $(this).closest("tr").data("id");
    $.get(API.categoryTypes+id+"/", function(t){
        $("#categoryTypeId").val(t.id);
        $("#categoryTypeName").val(t.name);
        $("#categoryTypeCategoryId").val(t.category?.id ?? "");
        $("#categoryTypeModalTitle").text("Edit Category Type");
        $("#categoryTypeModal").modal("show");
    }).fail(handleApiError);
});
$("#categoryTypesTable").on("click", ".btn-del-type", function(){
    if(!confirm("Delete this type?")) return;
    const id = $(this).closest("tr").data("id");
    $.ajax({ url: API.categoryTypes+id+"/", type:"DELETE",headers:{ "X-CSRFToken": window.CSRF_TOKEN } }).done(()=> loadCategoryTypes()).fail(handleApiError);
});
$("#categoryTypeSearch").on("input", debounce(()=> loadCategoryTypes(), 400));
$("#addCategoryTypeBtn").click(()=> { $("#categoryTypeModalTitle").text("Add Category Type"); $("#categoryTypeForm")[0].reset(); $("#categoryTypeId").val(""); loadCategoriesOptions(); $("#categoryTypeModal").modal("show"); });


// ======== CATEGORY MODELS CRUD =========
function loadCategoryModels(url){
    const search = $("#categoryModelSearch").val() || "";
    const fetchUrl = url || (API.categoryModels + (search ? `?search=${search}` : ""));
    $.get(fetchUrl, function(res){
        const data = toArrayOrResults(res);
        const rows = (data.results || []).map(m => `
            <tr data-id="${m.id}">
                <td>${m.name}</td>
                <td>${m.model_category_label || '-'}</td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-warning me-1 btn-edit-model">Edit</button>
                    <button class="btn btn-sm btn-danger btn-del-model">Delete</button>
                </td>
            </tr>
        `).join("");
        $("#categoryModelsTable tbody").html(rows);
        $("#categoryModelsPrev").prop("disabled", !data.previous).off("click").on("click", ()=> loadCategoryModels(data.previous));
        $("#categoryModelsNext").prop("disabled", !data.next).off("click").on("click", ()=> loadCategoryModels(data.next));
        $("#categoryModelsCount").text(`${data.count} items`);
    }).fail(handleApiError);
}

// CategoryModel form submit
$("#categoryModelForm").on("submit", function(e){
    e.preventDefault();
    const id = $("#categoryModelId").val();
    const payload = {
        name: $("#categoryModelName").val(),
        model_category: $("#categoryModelTypeId").val()
    };
    const req = id
      ? $.ajax({ url: API.categoryModels+id+"/", type:"PUT", data:JSON.stringify(payload), contentType:"application/json", headers:{ "X-CSRFToken": window.CSRF_TOKEN } })
      : $.ajax({ url: API.categoryModels, type:"POST", data:JSON.stringify(payload), contentType:"application/json", headers:{ "X-CSRFToken": window.CSRF_TOKEN } });
    req.done(()=> { $("#categoryModelModal").modal("hide"); loadCategoryModels(); }).fail(handleApiError);
});

// Edit & Delete
$("#categoryModelsTable").on("click", ".btn-edit-model", function(){
    const id = $(this).closest("tr").data("id");

    $.get(API.categoryModels + id + "/", function(m){

        $("#categoryModelId").val(m.id);
        $("#categoryModelName").val(m.name);

        loadCategoryModelCategories();

        // Wait for categories to load
        setTimeout(() => {
            const categoryId = m.model_category.category.id;

            $("#categoryModelCategoryId")
                .val(categoryId)
                .trigger("change");

            // Wait for types
            setTimeout(() => {
                $("#categoryModelTypeId").val(m.model_category.id);
            }, 300);
        }, 300);

        $("#categoryModelModalTitle").text("Edit Category Model");
        $("#categoryModelModal").modal("show");
    });
});

$("#categoryModelsTable").on("click", ".btn-del-model", function(){
    if(!confirm("Delete this model?")) return;
    const id = $(this).closest("tr").data("id");
    $.ajax({ url: API.categoryModels+id+"/", type:"DELETE" ,headers:{ "X-CSRFToken": window.CSRF_TOKEN }}).done(()=> loadCategoryModels()).fail(handleApiError);
});
$("#categoryModelSearch").on("input", debounce(()=> loadCategoryModels(), 400));
$("#addCategoryModelBtn").click(() => {    $("#categoryModelForm")[0].reset();    $("#categoryModelId").val("");    $("#categoryModelModalTitle").text("Add Category Model");
    loadCategoryModelCategories();
    $("#categoryModelTypeId").prop("disabled", true);    $("#categoryModelModal").modal("show");});

function bindTypeModelDropdown($type, $model) {
    $type.on("change", function () {
        const typeId = $(this).val();

        $model
            .prop("disabled", true)
            .html('<option value="">Select Model</option>');

        if (!typeId) return;

        $.get(API.categoryModels, { model_category: typeId })
            .done(res => {
                (res.results || res).forEach(m =>
                    $model.append(`<option value="${m.id}">${m.name}</option>`)
                );
                $model.prop("disabled", false);
            })
            .fail(handleApiError);
    });
}
bindTypeModelDropdown(
    $("#categoryModelTypeId"),
    $("#categoryModelModelId")
);
$("#resetWoodenFilters").on("click", function() {
    // 1. Clear text inputs
    $("#filterName, #woodenSearch").val("");

    // 2. Reset dropdowns to default
    $("#filterCategory, #filterBrand").val("");

    // 3. Clear and disable dependent dropdowns
    $("#filterType, #filterModel")
        .val("")
        .prop("disabled", true)
        .html('<option value="">All</option>');

    // 4. Reload the table
    loadWoodens();
});
// ======== WOODENS CRUD =========

function bindCategoryTypeModel($category, $type, $model, options = {}) {
    const mode = options.mode || "modal";
    const onChange = options.onChange;

    function triggerReload() {
        if (mode === "filter" && typeof onChange === "function") {
            console.log("üîÅ Filter changed ‚Üí reload table");
            onChange();
        }
    }

    $category.off("change.categoryTypeModel");
    $type.off("change.categoryTypeModel");
    $model.off("change.categoryTypeModel");

    $category.on("change.categoryTypeModel", function () {
        const categoryId = $(this).val();

        $type.val("").prop("disabled", true)
             .html('<option value="">Select Type</option>');

        $model.val("").prop("disabled", true)
              .html('<option value="">Select Model</option>');

        // ‚úÖ reload ONLY for category filter
        if (mode === "filter") triggerReload();

        if (!categoryId) return;

        $.get(API.categoryTypes, { category: categoryId })
            .done(res => {
                (res.results || res).forEach(t =>
                    $type.append(`<option value="${t.id}">${t.name}</option>`)
                );
                $type.prop("disabled", false);
            })
            .fail(handleApiError);
    });

    $type.on("change.categoryTypeModel", function () {
        const typeId = $(this).val();

        $model.val("").prop("disabled", true)
              .html('<option value="">Select Model</option>');

        // ‚úÖ reload ONLY when type selected
        if (mode === "filter" && typeId) triggerReload();

        if (!typeId) return;

        $.get(API.categoryModels, { model_category: typeId })
            .done(res => {
                (res.results || res).forEach(m =>
                    $model.append(`<option value="${m.id}">${m.name}</option>`)
                );
                $model.prop("disabled", false);
            })
            .fail(handleApiError);
    });

    // ‚úÖ model always reloads
    $model.on("change.categoryTypeModel", triggerReload);
}

/* =========================================================
   FILTER CASCADE (TABLE)
========================================================= */
bindCategoryTypeModel(
    $("#filterCategory"),
    $("#filterType"),
    $("#filterModel"),
    {
        mode: "filter",
        onChange: () => loadWoodens()
    }
);

/* =========================================================
   MODAL CASCADE (ADD / EDIT)
========================================================= */
bindCategoryTypeModel(
    $("#woodenCategoryId"),
    $("#woodenTypeId"),
    $("#woodenModelId"),
    { mode: "modal" }
);

 function buildWoodenFilterUrl(baseUrl) {
    const params = new URLSearchParams();
    const name = $("#filterName").val()?.trim();
    const material_grp = $("#filterCategory").val();
    const material_type = $("#filterType").val();
    const material_model = $("#filterModel").val();
    const brand = $("#filterBrand").val();
    
    if(name) params.append("search", name);
    if(material_grp) params.append("material_grp", material_grp);
    if(material_type) params.append("material_type", material_type);
    if(material_model) params.append("material_model", material_model);
    if(brand) params.append("brand", brand);
    return params.toString()
        ? `${baseUrl}?${params}`
        : baseUrl;
}
console.log("üîó Fetch URL:", buildWoodenFilterUrl(API.woodens));
function loadWoodens(url) {
  console.log("loadWoodens called with:", url);
  const fetchUrl = url || buildWoodenFilterUrl(API.woodens);
  console.log("fetchUrl ->", fetchUrl);


  $.get(fetchUrl, function (res) {
    const data = res.results ? res : { results: res };

    const rows = data.results.length
      ? data.results.map(w => `
          <tr data-id="${w.id}">
            <td>${w.name || '-'}</td>
            <td>${w.material_grp_label || '-'}</td>
            <td>${w.material_type_label || '-'}</td>
            <td>${w.material_model_label || '-'}</td>
            <td>${w.brand_label || '-'}</td>
            <td>${w.length_mm || '-'}</td>
            <td>${w.width_mm || '-'}</td>
            <td>${w.thickness_mm || '-'}</td>
            <td>${w.cost_price_panel ?? '-'}/${w.cost_price_sft ?? '-'}</td>
            <td>${w.sell_price_panel ?? '-'}/${w.sell_price_sft ?? '-'}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-warning me-1 btn-edit-wood">Edit</button>
              <button class="btn btn-sm btn-danger btn-del-wood">Delete</button>
            </td>
          </tr>
        `).join("")
      : `<tr><td colspan="11" class="text-center">No records found</td></tr>`;

    $("#woodensTable tbody").html(rows);

    $("#woodensPrev")
      .prop("disabled", !data.previous)
      .off("click")
      .on("click", () => loadWoodens(data.previous));

    $("#woodensNext")
      .prop("disabled", !data.next)
      .off("click")
      .on("click", () => loadWoodens(data.next));

    $("#woodensCount").text(`${data.count ?? data.results.length} items`);
  }).fail(handleApiError);
}

// Cascading Dropdowns for Filters and Modals
    bindCategoryTypeModel(
    $("#filterCategory"),
    $("#filterType"),
    $("#filterModel"),
    {
        mode: "filter",
        onChange: () => loadWoodens()
    }
);
    bindCategoryTypeModel(
    $("#woodenCategoryId"),
    $("#woodenTypeId"),
    $("#woodenModelId"),
    {
        mode: "modal"
    }
);


    // --- Search/Filter Listeners ---
    $("#categorySearch").on("input", debounce(() => loadCategories(), 400));
    $("#categoryTypeSearch").on("input", debounce(() => loadCategoryTypes(), 400));
    $("#categoryModelSearch").on("input", debounce(() => loadCategoryModels(), 400));
    $("#filterName").on("input", debounce(() => loadWoodens(), 400));
    $("#filterBrand").on("change", function() {
    const url = buildWoodenFilterUrl(API.woodens);
    loadWoodens(url);
});

    
   
    $("#resetWoodenFilters").on("click", function() {
        $("#filterName, #filterBrand").val("");
        $("#filterCategory").val("").trigger("change");
        
    });
// Add WoodEn button opens modal
$("#addWoodenBtn").click(()=>{
    $("#woodenForm")[0].reset();
    $("#woodenId").val("");
    loadCategoriesOptions();
    
    loadBrands($("#woodenBrandId"));
    loadMeasurementUnits($("#woodenLengthUnit"));
    loadMeasurementUnits($("#woodenWidthUnit"));
    loadMeasurementUnits($("#woodenThicknessUnit"));
    loadBillingUnits($("#woodenCostUnit"));
    loadBillingUnits($("#woodenSellUnit"));
    $("#woodenModalTitle").text("Add Panel");
    $("#woodenModal").modal("show");
});

// Submit
$("#woodenForm").on("submit", function(e){
    e.preventDefault();
    const id = $("#woodenId").val();
    const payload = {
        name: $("#woodenName").val(),
        material_grp: $("#woodenCategoryId").val() || null,
        material_type: $("#woodenTypeId").val() || null,
        material_model: $("#woodenModelId").val() || null,
        brand: $("#woodenBrandId").val() || null,
        length_value: $("#woodenLength").val(),
        length_unit: $("#woodenLengthUnit").val(),
        width_value: $("#woodenWidth").val(),
        width_unit: $("#woodenWidthUnit").val(),
        thickness_value: $("#woodenThickness").val(),
        thickness_unit: $("#woodenThicknessUnit").val(),
        cost_price: $("#woodenCostPrice").val(),
        cost_unit: $("#woodenCostUnit").val(),
        sell_price: $("#woodenSellPrice").val(),
        sell_unit: $("#woodenSellUnit").val(),
        grain: $("#woodenGrain").val(),
        color: $("#woodenColor").val(),
        is_sheet: $("#woodenIsSheet").is(":checked")
    };
    const req = id
      ? $.ajax({ url: API.woodens+id+"/", type:"PUT", data:JSON.stringify(payload), contentType:"application/json", headers:{ "X-CSRFToken": window.CSRF_TOKEN } })
      : $.ajax({ url: API.woodens, type:"POST", data:JSON.stringify(payload), contentType:"application/json", headers:{ "X-CSRFToken": window.CSRF_TOKEN } });
    req.done(()=> { $("#woodenModal").modal("hide"); loadWoodens(); }).fail(handleApiError);
});
/**
 * Fetches types based on a category and optionally selects a value
 */
function loadTypesByCategory(categoryId, $typeDropdown, selectedId = null) {
    $typeDropdown.prop("disabled", true).html('<option value="">Loading...</option>');
    
    return $.get(API.categoryTypes, { category: categoryId })
        .done(res => {
            const data = res.results || res;
            let options = '<option value="">Select Type</option>';
            data.forEach(t => {
                const selected = (t.id == selectedId) ? 'selected' : '';
                options += `<option value="${t.id}" ${selected}>${t.name}</option>`;
            });
            $typeDropdown.html(options).prop("disabled", false);
        })
        .fail(handleApiError);
}

/**
 * Fetches models based on a type and optionally selects a value
 */
function loadModelsByType(typeId, $modelDropdown, selectedId = null) {
    $modelDropdown.prop("disabled", true).html('<option value="">Loading...</option>');

    return $.get(API.categoryModels, { model_category: typeId })
        .done(res => {
            const data = res.results || res;
            let options = '<option value="">Select Model</option>';
            data.forEach(m => {
                const selected = (m.id == selectedId) ? 'selected' : '';
                options += `<option value="${m.id}" ${selected}>${m.name}</option>`;
            });
            $modelDropdown.html(options).prop("disabled", false);
        })
        .fail(handleApiError);
}

$(document).on("click", ".btn-edit-wood", function() {
    const id = $(this).closest("tr").data("id");
    $.when(
        loadBrands($("#woodenBrandId")), loadMeasurementUnits($("#woodenLengthUnit")),
        loadMeasurementUnits($("#woodenWidthUnit")), loadMeasurementUnits($("#woodenThicknessUnit")),
        loadBillingUnits($("#woodenCostUnit")), loadBillingUnits($("#woodenSellUnit"))
    ).done(() => {
        $.get(`${API.woodens}${id}/`, function(w) {
            $("#woodenId").val(w.id);
            $("#woodenName").val(w.name);
            $("#woodenCategoryId").val(w.material_grp);
            $("#woodenBrandId").val(w.brand);
            loadTypesByCategory(w.material_grp, $("#woodenTypeId"), w.material_type).done(() => {
                if (w.material_type) loadModelsByType(w.material_type, $("#woodenModelId"), w.material_model);
            });
            $("#woodenLength").val(w.length_value); $("#woodenLengthUnit").val(w.length_unit);
            $("#woodenWidth").val(w.width_value); $("#woodenWidthUnit").val(w.width_unit);
            $("#woodenThickness").val(w.thickness_value); $("#woodenThicknessUnit").val(w.thickness_unit);
            $("#woodenCostPrice").val(w.cost_price); $("#woodenCostUnit").val(w.cost_unit);
            $("#woodenSellPrice").val(w.sell_price); $("#woodenSellUnit").val(w.sell_unit);
            $("#woodenIsSheet").prop("checked", w.is_sheet);
            $("#woodenModalTitle").text("Edit Panel"); $("#woodenModal").modal("show");
        });
    });
});

$("#woodensTable").on("click", ".btn-del-wood", function(){
    if(!confirm("Delete this WoodEn?")) return;
    const id = $(this).closest("tr").data("id");
    $.ajax({ 
        url: API.woodens + id + "/", 
        type: "DELETE",
        headers: { "X-CSRFToken": window.CSRF_TOKEN } // Added for security
    }).done(() => loadWoodens()).fail(handleApiError);
});

// ===== INITIAL LOAD =====
$(document).ready(function(){
    loadCategories();
    loadCategoryTypes();
    loadCategoryModels();
    loadWoodens();
    loadCategoriesOptions();
    
    loadBrands($("#filterBrand"));
});
</script>
{% endblock %}
