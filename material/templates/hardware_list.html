{% extends "base.html" %}

{% block title %}Hardware Inventory{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h4>Hardware Inventory</h4>
        <button class="btn btn-primary" id="addHardwareBtn"
                data-bs-toggle="modal"
                data-bs-target="#hardwareModal">
            + Add Hardware
        </button>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <input
                type="text"
                id="hardwareSearch"
                class="form-control form-control-sm"
                placeholder="Search hardware, brand, group‚Ä¶">
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Group</th>
                    <th>Name</th>
                    <th>Brand</th>
                    <th>Purchase</th>
                    <th>Selling</th>
                    <th>Unit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="hardwareTableBody"></tbody>
        </table>
    </div>

    <nav>
        <ul class="pagination pagination-sm justify-content-center"
            id="paginationControls"></ul>
    </nav>
</div>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="hardwareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="hardwareForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hardwareModalLabel">Add Hardware</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="hardwareId">

                <!-- GROUP + NAME -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Hardware Group</label>
                        <div class="input-group">
                            <select id="h_group" class="form-select" required></select>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="showNewGroupInput">Add Hardware Group</button>
                        </div>
                        <div id="newGroupWrapper" class="mt-2 d-none">
                            <input id="newGroupName" class="form-control mb-1"
                                   placeholder="Group name">
                            <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-primary"
                                        id="addNewGroupBtn">Add</button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        id="cancelNewGroupBtn">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Hardware Name</label>
                        <input id="h_name" class="form-control" required>
                    </div>
                </div>

                <!-- BRAND + UNIT -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Brand</label>
                        <div class="input-group">
                            <select id="brand" class="form-select"></select>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="showNewBrandInput">Add Brand</button>
                        </div>
                        <div id="newBrandWrapper" class="mt-2 d-none">
                            <input id="newBrandName" class="form-control mb-1"
                                   placeholder="Brand name">
                            <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-primary"
                                        id="addNewBrandBtn">Add</button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        id="cancelNewBrandBtn">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Billing Unit</label>
                        <div class="input-group">
                            <select id="billing_unit" class="form-select" required></select>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="showNewBillingUnitInput">Add Billing Unit</button>
                        </div>

                        <div id="newBillingUnitWrapper" class="mt-2 d-none">
                            <input id="newBillingUnitName" class="form-control mb-1" placeholder="Unit name">
                            <input id="newBillingUnitCode" class="form-control mb-1" placeholder="Code">
                            <input id="newBillingUnitFactor" type="number" step="0.0001" class="form-control mb-2" placeholder="Factor">

                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary" id="addNewBillingUnitBtn">Add</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="cancelNewBillingUnitBtn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRICES -->
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Purchase Price</label>
                        <input id="p_price" type="number" step="0.01"
                               class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Selling Price</label>
                        <input id="s_price" type="number" step="0.01"
                               class="form-control" required>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success" type="submit">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- ================= UNDO TOAST ================= -->
<div id="undoToast" class="toast position-fixed bottom-0 end-0 m-3" data-bs-delay="5000">
    <div class="toast-body d-flex justify-content-between align-items-center">
        <span>Hardware deleted</span>
        <button class="btn btn-sm btn-warning" id="undoDeleteBtn">Undo</button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(function () {

    const HARDWARE_API = '/material/v1/hardware/';
    const GROUP_API = '/material/v1/hardware-groups/';
    const BRAND_API = '/material/v1/brands/';
    const BILLING_UNIT_API = '/material/v1/billing-units/';

    let editingId = null;
    let currentPageUrl = HARDWARE_API;
    let lastDeleted = null;
    let undoTimer = null;

    /* =================== SELECT2 =================== */
    $('#h_group, #brand, #billing_unit').select2({
        dropdownParent: $('#hardwareModal'),
        width: '100%'
    });

    /* =================== ERROR HELPER =================== */
    function extractErrorMessage(xhr) {
        try {
            const res = JSON.parse(xhr.responseText);
            if (res.name?.length) return res.name[0];
            if (res.detail) return res.detail;
        } catch {}
        return 'Operation failed';
    }

    /* =================== LOAD DROPDOWNS =================== */
    function loadGroups(selected=null){
        return $.get(GROUP_API).done(res=>{
            const s=$('#h_group').empty().append('<option></option>');
            (res.results||res).forEach(g=>{
                s.append(`<option value="${g.id}">${g.name}</option>`);
            });
            if(selected) s.val(String(selected)).trigger('change');
        });
    }
    function loadBrands(selected=null){
        return $.get(BRAND_API).done(res=>{
            const s=$('#brand').empty().append('<option></option>');
            (res.results||res).forEach(b=>{
                s.append(`<option value="${b.id}">${b.name}</option>`);
            });
            if(selected) s.val(String(selected)).trigger('change');
        });
    }
    function loadBillingUnits(selected=null){
        return $.get(BILLING_UNIT_API).done(res=>{
            const s=$('#billing_unit').empty().append('<option></option>');
            (res.results||res).forEach(u=>{
                s.append(`<option value="${u.id}">${u.name}</option>`);
            });
            if(selected) s.val(String(selected)).trigger('change');
        });
    }

    /* =================== OPTIMISTIC CREATE HELPER =================== */
    function optimisticCreate({ api, name, select, extraData = {}, wrapper, input, button }) {
        const tempId = `tmp-${Date.now()}`;
        const opt = new Option(`${name} (saving‚Ä¶)`, tempId, true, true);
        select.append(opt).trigger('change');
        button.prop('disabled', true);
        input.removeClass('is-invalid').next('.invalid-feedback').remove();

        $.ajax({
            url: api,
            method: 'POST',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN },
            contentType: 'application/json',
            data: JSON.stringify({ name, ...extraData })
        })
        .done(res => {
            select.find(`option[value="${tempId}"]`).remove();
            select.append(new Option(res.name, res.id, true, true)).trigger('change');
            wrapper.addClass('d-none');
            input.val('');
        })
        .fail(xhr => {
            select.find(`option[value="${tempId}"]`).remove().trigger('change');
            const msg = extractErrorMessage(xhr);
            input.addClass('is-invalid')
                 .after(`<div class="invalid-feedback">${msg}</div>`);
        })
        .always(()=>button.prop('disabled', false));
    }

    /* =================== ADD NEW GROUP / BRAND / UNIT =================== */
    $('#showNewGroupInput').click(()=>$('#newGroupWrapper').removeClass('d-none'));
    $('#cancelNewGroupBtn').click(()=>$('#newGroupWrapper').addClass('d-none'));
    $('#addNewGroupBtn').click(function(){
        const input = $('#newGroupName');
        const name = input.val().trim();
        if(!name) return input.addClass('is-invalid');
        optimisticCreate({ api: GROUP_API, name, select: $('#h_group'), wrapper: $('#newGroupWrapper'), input, button: $(this) });
    });

    $('#showNewBrandInput').click(()=>$('#newBrandWrapper').removeClass('d-none'));
    $('#cancelNewBrandBtn').click(()=>$('#newBrandWrapper').addClass('d-none'));
    $('#addNewBrandBtn').click(function(){
        const input = $('#newBrandName');
        const name = input.val().trim();
        if(!name) return input.addClass('is-invalid');
        optimisticCreate({ api: BRAND_API, name, select: $('#brand'), wrapper: $('#newBrandWrapper'), input, button: $(this) });
    });

    $('#showNewBillingUnitInput').click(()=>$('#newBillingUnitWrapper').removeClass('d-none'));
    $('#cancelNewBillingUnitBtn').click(()=>$('#newBillingUnitWrapper').addClass('d-none'));
    $('#addNewBillingUnitBtn').click(function(){
        const name = $('#newBillingUnitName').val().trim();
        const code = $('#newBillingUnitCode').val().trim();
        const factor = $('#newBillingUnitFactor').val();
        if(!name || !code || !factor) return alert('All fields required');
        optimisticCreate({ api: BILLING_UNIT_API, name, extraData: { code, factor }, select: $('#billing_unit'), wrapper: $('#newBillingUnitWrapper'), input: $('#newBillingUnitName'), button: $(this) });
    });

    /* =================== LOAD HARDWARE =================== */
    function loadHardware(url = HARDWARE_API) {
        currentPageUrl = url;
        $.get(url).done(res => {
            const tbody = $('#hardwareTableBody').empty();
            (res.results||[]).forEach(h=>{
                tbody.append(`
                    <tr data-id="${h.id}">
                        <td>${h.h_group_label||'-'}</td>
                        <td>${h.h_name}</td>
                        <td>${h.brand_label||'-'}</td>
                        <td>${Number(h.cost_price).toFixed(2)}</td>
                        <td>${Number(h.sell_price).toFixed(2)}</td>
                        <td>${h.billing_unit_code||'-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit-btn">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger delete-btn">üóëÔ∏è</button>
                        </td>
                    </tr>
                `);
            });
            renderPagination(res);
        });
    }

    /* =================== EDIT =================== */
    $('#hardwareTableBody').on('click', '.edit-btn', function () {
        const id = $(this).closest('tr').data('id');
        editingId = id;

        $.get(`${HARDWARE_API}${id}/`).done(h=>{
            $('#hardwareModalLabel').text('Edit Hardware');
            $('#h_name').val(h.h_name);
            $('#p_price').val(h.cost_price);
            $('#s_price').val(h.sell_price);
            $.when(loadGroups(h.h_group), loadBrands(h.brand), loadBillingUnits(h.billing_unit))
             .done(()=>$('#hardwareModal').modal('show'));
        });
    });

    /* =================== DELETE + UNDO =================== */
    $('#hardwareTableBody').on('click', '.delete-btn', function () {
        const row = $(this).closest('tr');
        const id = row.data('id');
        if(!confirm('Deactivate this hardware item?')) return;

        lastDeleted = { id };
        clearTimeout(undoTimer);
        row.fadeOut(200);

        $.ajax({
            url: `${HARDWARE_API}${id}/`,
            method: 'PATCH',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN },
            contentType: 'application/json',
            data: JSON.stringify({ is_active: false })
        }).done(()=>{
            showUndoToast();
            undoTimer = setTimeout(()=>lastDeleted=null, 5000);
        }).fail(()=>{ row.show(); lastDeleted=null; alert('Delete failed'); });
    });

    $('#undoDeleteBtn').click(function () {
        if(!lastDeleted) return;
        $.ajax({
            url: `${HARDWARE_API}${lastDeleted.id}/`,
            method: 'PATCH',
            headers: { 'X-CSRFToken': window.CSRF_TOKEN },
            contentType: 'application/json',
            data: JSON.stringify({ is_active: true })
        }).done(()=>{ loadHardware(currentPageUrl); lastDeleted=null; hideUndoToast(); })
          .fail(()=>alert('Undo failed'));
    });

    function showUndoToast() {
        const toastEl = document.getElementById('undoToast');
        const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
        toast.show();
    }
    function hideUndoToast() {
        const toastEl = document.getElementById('undoToast');
        const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
        toast.hide();
    }

    /* =================== SAVE HARDWARE =================== */
    $('#hardwareForm').submit(function(e){
        e.preventDefault();
        const payload = {
            h_group: Number($('#h_group').val()),
            h_name: $('#h_name').val(),
            brand: Number($('#brand').val()||null),
            billing_unit: Number($('#billing_unit').val()),
            cost_price: $('#p_price').val(),
            sell_price: $('#s_price').val()
        };
        $.ajax({
            url: editingId ? `${HARDWARE_API}${editingId}/` : HARDWARE_API,
            method: editingId ? 'PUT' : 'POST',
            headers:{'X-CSRFToken':window.CSRF_TOKEN},
            contentType:'application/json',
            data: JSON.stringify(payload)
        }).done(()=>{
            $('#hardwareModal').modal('hide');
            loadHardware(currentPageUrl);
            editingId=null;
        });
    });

    /* =================== SEARCH =================== */
    let searchTimer=null;
    $('#hardwareSearch').on('input', function(){
        clearTimeout(searchTimer);
        searchTimer=setTimeout(()=>{
            const q=$(this).val().trim();
            const url=q?`${HARDWARE_API}?search=${encodeURIComponent(q)}`:HARDWARE_API;
            loadHardware(url);
        }, 300);
    });

    /* =================== FILTERS =================== */
    $('#h_group,#brand').on('change', function(){
        const params = new URLSearchParams();
        if($('#h_group').val()) params.append('h_group', $('#h_group').val());
        if($('#brand').val()) params.append('brand', $('#brand').val());
        loadHardware(`${HARDWARE_API}?${params.toString()}`);
    });

    /* =================== PAGINATION =================== */
    function renderPagination(res){
        const p=$('#paginationControls').empty();
        if(res.previous) p.append(`<li class="page-item"><a class="page-link" href="#" data-url="${res.previous}">Prev</a></li>`);
        if(res.next) p.append(`<li class="page-item"><a class="page-link" href="#" data-url="${res.next}">Next</a></li>`);
    }
    $('#paginationControls').on('click','a',function(e){
        e.preventDefault();
        loadHardware($(this).data('url'));
    });

    /* =================== MODAL RESET =================== */
    $('#hardwareModal').on('hidden.bs.modal', function(){
        editingId=null;
        $('#hardwareForm')[0].reset();
        $('#h_group,#brand,#billing_unit').val(null).trigger('change');
        $('#newGroupWrapper,#newBrandWrapper,#newBillingUnitWrapper').addClass('d-none');
        $(this).find('.is-invalid').removeClass('is-invalid').next('.invalid-feedback').remove();
        $('#hardwareModalLabel').text('Add Hardware');
    });

    /* =================== INIT =================== */
    loadGroups();
    loadBrands();
    loadBillingUnits();
    loadHardware();

});
</script>
{% endblock %}
