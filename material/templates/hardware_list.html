{% extends "base_b.html" %}

{% block title %}Hardware Inventory{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h4>Hardware Inventory</h4>
        <button class="btn btn-primary" id="addHardwareBtn"
                data-bs-toggle="modal"
                data-bs-target="#hardwareModal">
            + Add Hardware
        </button>
    </div>
<div class="row mb-3">
    <div class="col-md-4">
        <input
            type="text"
            id="hardwareSearch"
            class="form-control form-control-sm"
            placeholder="Search hardware, brand, group‚Ä¶">
    </div>
</div>
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Group</th>
                    <th>Name</th>
                    <th>Brand</th>
                    <th>Purchase</th>
                    <th>Selling</th>
                    <th>Unit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="hardwareTableBody"></tbody>
        </table>
    </div>

    <nav>
        <ul class="pagination pagination-sm justify-content-center"
            id="paginationControls"></ul>
    </nav>
</div>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="hardwareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="hardwareForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hardwareModalLabel">Add Hardware</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="hardwareId">

                <!-- GROUP + NAME -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Hardware Group</label>
                        <div class="input-group">
                            <select id="h_group" class="form-select" required></select>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="showNewGroupInput">Add Hardware Group</button>
                        </div>
                        <div id="newGroupWrapper" class="mt-2 d-none">
                            <input id="newGroupName" class="form-control mb-1"
                                   placeholder="Group name">
                            <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-primary"
                                        id="addNewGroupBtn">Add</button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        id="cancelNewGroupBtn">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Hardware Name</label>
                        <input id="h_name" class="form-control" required>
                    </div>
                </div>

                <!-- BRAND + UNIT -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Brand</label>
                        <div class="input-group">
                            <select id="brand" class="form-select"></select>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="showNewBrandInput">Add Brand</button>
                        </div>
                        <div id="newBrandWrapper" class="mt-2 d-none">
                            <input id="newBrandName" class="form-control mb-1"
                                   placeholder="Brand name">
                            <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-primary"
                                        id="addNewBrandBtn">Add</button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        id="cancelNewBrandBtn">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
    <label class="form-label">Billing Unit</label>
    <div class="input-group">
        <select id="billing_unit" class="form-select" required></select>
        <button type="button"
                class="btn btn-outline-secondary"
                id="showNewBillingUnitInput">add billing unit</button>
    </div>

    <div id="newBillingUnitWrapper" class="mt-2 d-none">
        <input id="newBillingUnitName"
               class="form-control mb-1"
               placeholder="Unit name (e.g. Meter)">
        <input id="newBillingUnitCode"
               class="form-control mb-1"
               placeholder="Code (e.g. m)">
        <input id="newBillingUnitFactor"
               type="number"
               step="0.0001"
               class="form-control mb-2"
               placeholder="Factor (e.g. 1.0)">

        <div class="d-flex gap-2">
            <button type="button"
                    class="btn btn-sm btn-primary"
                    id="addNewBillingUnitBtn">
                Add
            </button>
            <button type="button"
                    class="btn btn-sm btn-secondary"
                    id="cancelNewBillingUnitBtn">
                Cancel
            </button>
        </div>
    </div>
</div>
                </div>

                <!-- PRICES -->
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Purchase Price</label>
                        <input id="p_price" type="number" step="0.01"
                               class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Selling Price</label>
                        <input id="s_price" type="number" step="0.01"
                               class="form-control" required>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success" type="submit">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(function () {

    const HARDWARE_API = '/material/v1/hardware/';
    const GROUP_API = '/material/v1/hardware-groups/';
    const BRAND_API = '/material/v1/brands/';
    const BILLING_UNIT_API = '/material/v1/billing-units/';

    let editingId = null;
    let currentPageUrl = HARDWARE_API;

    /* =================== SELECT2 =================== */
    $('#h_group, #brand, #billing_unit').select2({
        dropdownParent: $('#hardwareModal'),
        width: '100%'
    });

    /* =================== LOAD TABLE =================== */
    function loadHardware(url = HARDWARE_API) {
        currentPageUrl = url;
        console.log('üîó Fetch hardware:', url);

        $.get(url).done(res => {
            const tbody = $('#hardwareTableBody').empty();

            (res.results || []).forEach(h => {
                tbody.append(`
                    <tr data-id="${h.id}">
                        <td>${h.h_group_label || '-'}</td>
                        <td>${h.h_name}</td>
                        <td>${h.brand_label || '-'}</td>
                        <td>${Number(h.cost_price).toFixed(2)}</td>
                        <td>${Number(h.sell_price).toFixed(2)}</td>
                        <td>${h.billing_unit_code || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit-btn">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger delete-btn">üóëÔ∏è</button>
                        </td>
                    </tr>
                `);
            });

            renderPagination(res);
        });
    }

    /* =================== PAGINATION =================== */
    function renderPagination(res){
        const p = $('#paginationControls').empty();

        if(res.previous){
            p.append(`
                <li class="page-item">
                    <a class="page-link" data-url="${res.previous}">Prev</a>
                </li>
            `);
        }
        if(res.next){
            p.append(`
                <li class="page-item">
                    <a class="page-link" data-url="${res.next}">Next</a>
                </li>
            `);
        }
    }

    $('#paginationControls').on('click', 'a', function(e){
        e.preventDefault();
        loadHardware($(this).data('url'));
    });

    /* =================== DROPDOWNS =================== */
    function loadGroups(selected=null){
        return $.get(GROUP_API).done(res=>{
            const s=$('#h_group').empty().append('<option></option>');
            (res.results||res).forEach(g=>{
                s.append(`<option value="${g.id}">${g.name}</option>`);
            });
            if(selected) s.val(String(selected)).trigger('change');
        });
    }

    function loadBrands(selected=null){
        return $.get(BRAND_API).done(res=>{
            const s=$('#brand').empty().append('<option></option>');
            (res.results||res).forEach(b=>{
                s.append(`<option value="${b.id}">${b.name}</option>`);
            });
            if(selected) s.val(String(selected)).trigger('change');
        });
    }

    function loadBillingUnits(selected=null){
        return $.get(BILLING_UNIT_API).done(res=>{
            const s=$('#billing_unit').empty().append('<option></option>');
            (res.results||res).forEach(u=>{
                s.append(`<option value="${u.id}">${u.name}</option>`);
            });
            if(selected) s.val(String(selected)).trigger('change');
        });
    }

    let searchTimer = null;

$('#hardwareSearch').on('input', function () {
    clearTimeout(searchTimer);

    searchTimer = setTimeout(() => {
        const q = $(this).val().trim();

        const url = q
            ? `${HARDWARE_API}?search=${encodeURIComponent(q)}`
            : HARDWARE_API;

        loadHardware(url);
    }, 300);
});

    /* =================== ADD HARDWARE =================== */
    $('#addHardwareBtn').click(()=>{
        editingId = null;
        $('#hardwareForm')[0].reset();
        $('#h_group,#brand,#billing_unit').val(null).trigger('change');
        $('#hardwareModalLabel').text('Add Hardware');
    });

    /* =================== EDIT =================== */
    $('#hardwareTableBody').on('click','.edit-btn',function(){
        const id = $(this).closest('tr').data('id');
        editingId = id;

        $.get(`${HARDWARE_API}${id}/`).done(h=>{
            $('#hardwareModalLabel').text('Edit Hardware');

            $('#h_name').val(h.h_name);
            $('#p_price').val(h.cost_price);
            $('#s_price').val(h.sell_price);

            $.when(
                loadGroups(h.h_group),
                loadBrands(h.brand),
                loadBillingUnits(h.billing_unit)
            ).done(()=>{
                $('#hardwareModal').modal('show');
            });
        });
    });

    /* =================== DELETE (SOFT) =================== */
    $('#hardwareTableBody').on('click','.delete-btn',function(){
        const id = $(this).closest('tr').data('id');
        if(!confirm('Deactivate this hardware item?')) return;

        $.ajax({
            url: `${HARDWARE_API}${id}/`,
            method: 'PATCH',
            headers:{'X-CSRFToken':window.CSRF_TOKEN},
            contentType:'application/json',
            data: JSON.stringify({is_active:false})
        }).done(()=>loadHardware(currentPageUrl));
    });

    /* =================== SAVE =================== */
    $('#hardwareForm').submit(function(e){
        e.preventDefault();

        const payload = {
            h_group: Number($('#h_group').val()),
            h_name: $('#h_name').val(),
            brand: Number($('#brand').val() || null),
            billing_unit: Number($('#billing_unit').val()),
            cost_price: $('#p_price').val(),
            sell_price: $('#s_price').val()
        };

        const url = editingId ? `${HARDWARE_API}${editingId}/` : HARDWARE_API;
        const method = editingId ? 'PUT' : 'POST';

        $.ajax({
            url, method,
            contentType:'application/json',
            headers:{'X-CSRFToken':window.CSRF_TOKEN},
            data: JSON.stringify(payload)
        }).done(()=>{
            $('#hardwareModal').modal('hide');
            loadHardware(currentPageUrl);
            editingId = null;
        });
    });

    /* =================== SERVER FILTERING =================== */
    $('#h_group, #brand').on('change', function(){
        const params = new URLSearchParams();
        if($('#h_group').val()) params.append('h_group', $('#h_group').val());
        if($('#brand').val()) params.append('brand', $('#brand').val());

        loadHardware(`${HARDWARE_API}?${params.toString()}`);
    });

    /* =================== CLIENT FILTER =================== */
    $('#h_name').on('input', function(){
        const v = $(this).val().toLowerCase();
        $('#hardwareTableBody tr').each(function(){
            $(this).toggle($(this).text().toLowerCase().includes(v));
        });
    });

    /* =================== AI PRICE SUGGESTION =================== */
    $('#p_price').on('input', function(){
        const cost = Number($(this).val() || 0);

        // BASIC ‚Üí 30% margin
        const suggested = (cost * 1.3).toFixed(2);

        // Pro-ready hook
        $('#s_price').attr('placeholder', `AI Suggestion: ${suggested}`);
    });

    /* =================== INIT =================== */
    loadGroups();
    loadBrands();
    loadBillingUnits();
    loadHardware();

});
</script>
{% endblock %}
