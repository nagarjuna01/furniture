{% extends "base.html" %}

{% block title %}Brand Console {% endblock %}

{% block content %}
<div class="container-fluid mt-4" x-data="brandManager()" x-init="fetchBrands()">

    <!-- Header + Add Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">Brand Console </h3>
        <button class="btn btn-primary" @click="openCreate()">
            <i class="fas fa-plus"></i> Add Brand
        </button>
    </div>

    <!-- Search Bar -->
    <div class="mb-4">
        <input type="text"
               class="form-control"
               placeholder="Search brands..."
               x-model.debounce.400ms="search"
               @input="fetchBrands">
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center text-muted py-5">Loading brands...</div>

    <!-- No Brands Placeholder -->
    <div x-show="!loading && brands.length === 0" class="text-center text-muted mt-5">
        <i class="fas fa-box-open fa-3x mb-2"></i>
        <p class="lead">No brands found. Click "Add Brand" to create one.</p>
    </div>

    <!-- Brand Cards -->
    <div class="row">
        <template x-for="brand in brands" :key="brand.id">
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column justify-content-between">
                        <div>
                            <h5 class="fw-bold" x-text="brand.name"></h5>
                            <p class="text-muted" x-text="brand.description || ''"></p>
                            <template x-if="isSuperuser">
                                <small class="text-muted">
                                    Tenant: <span x-text="brand.tenant_name"></span>
                                </small>
                            </template>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button class="btn btn-outline-primary btn-sm" @click="openEdit(brand)">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @click="deleteBrand(brand.id)">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal for Create/Edit Brand -->
    <div class="modal fade" id="brandModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="editing ? 'Edit Brand' : 'Add Brand'"></h5>
                    <button type="button" class="btn-close" @click="hideModal()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Brand Name</label>
                        <input type="text" class="form-control" x-model="form.name" placeholder="Enter brand name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brand Description</label>
                        <textarea class="form-control" rows="3" x-model="form.description" placeholder="Enter description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" @click="saveBrand()">
                        <i class="fas fa-save"></i> <span x-text="editing ? 'Update Brand' : 'Save Brand'"></span>
                    </button>
                    <button class="btn btn-secondary" @click="hideModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
        <template x-for="(toast, index) in toasts" :key="index">
            <div class="toast align-items-center text-bg-white border-0 mb-2 shadow-sm"
                 :class="{
                     'text-bg-success': toast.type === 'success',
                     'text-bg-danger': toast.type === 'danger',
                     'text-bg-warning': toast.type === 'warning',
                     'text-bg-info': toast.type === 'info'
                 }"
                 role="alert"
                 x-init="$nextTick(() => setTimeout(() => removeToast(index), 3000))">
                <div class="d-flex">
                    <div class="toast-body" x-text="toast.message"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" @click="removeToast(index)"></button>
                </div>
            </div>
        </template>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
function brandManager() {
    return {
        brands: [],
        search: '',
        loading: false,
        editing: false,
        currentId: null,
        form: { name: '', description: '' },
        toasts: [],
        isSuperuser: window.CURRENT_USER_IS_SUPERUSER,

        async fetchBrands() {
    this.loading = true;
    const url = this.search
        ? `/material/v1/brands/?search=${this.search}`
        : '/material/v1/brands/';

    console.log("Fetching brands from:", url);

    try {
        const res = await fetch(url);
        const data = await res.json();
        console.log("Response data:", data);
        this.brands = data.results ?? data;
        console.log("Brands array:", this.brands);
    } catch (err) {
        console.error("Fetch error:", err);
        this.showToast('Failed to load brands', 'danger');
    } finally {
        this.loading = false;
    }
},


        openCreate() {
            this.resetForm();
            this.showModal();
        },

        openEdit(brand) {
            this.editing = true;
            this.currentId = brand.id;
            this.form.name = brand.name;
            this.form.description = brand.description || '';
            this.showModal();
        },

        async saveBrand() {
            if (!this.form.name.trim()) {
                this.showToast("Brand name is required", "warning");
                return;
            }

            const url = this.editing
                ? `/material/v1/brands/${this.currentId}/`
                : '/material/v1/brands/';
            const method = this.editing ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    body: JSON.stringify(this.form)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw err;
                }

                this.showToast(this.editing ? "Brand updated" : "Brand created", "success");
                this.fetchBrands();
                this.hideModal();
            } catch (err) {
                const msg = err?.name?.[0] || err?.detail || "Failed to save brand";
                this.showToast(msg, "danger");
            }
        },

        async deleteBrand(id) {
            if (!confirm("Are you sure you want to delete this brand?")) return;

            try {
                await fetch(`/material/v1/brands/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': window.CSRF_TOKEN }
                });
                this.showToast("Brand deleted!", "success");
                this.fetchBrands();
            } catch {
                this.showToast("Failed to delete brand.", "danger");
            }
        },

        resetForm() {
            this.editing = false;
            this.currentId = null;
            this.form = { name: '', description: '' };
        },

        showModal() {
            new bootstrap.Modal(document.getElementById('brandModal')).show();
        },

        hideModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('brandModal'));
            if (modal) modal.hide();
            this.resetForm();
        },

        showToast(message, type = "info") {
            this.toasts.push({ message, type });
        },

        removeToast(index) {
            this.toasts.splice(index, 1);
        }
    }
}
</script>
{% endblock %}
