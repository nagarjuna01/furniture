{% extends "base_b.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">EdgeBand Management</h1>

    <!-- Tabs -->
<ul class="nav nav-tabs" id="edgebandTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="eb-tab" data-bs-toggle="tab" data-bs-target="#edgebandsTab">EdgeBands</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="ebn-tab" data-bs-toggle="tab" data-bs-target="#edgebandNamesTab">EdgeBand Names</button>
  </li>
</ul>

<div class="tab-content mt-3">

  <!-- EdgeBands Tab -->
  <div class="tab-pane fade show active" id="edgebandsTab">
    <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#edgebandModal">Add EdgeBand</button>
    <div class="table-responsive">
      <table class="table table-bordered" id="edgebandsTable">
        <thead>
          <tr>
            <th>Display Name</th>
            <th>Thickness</th>
            <th>Brand</th>
            <th>Purchase</th>
            <th>Sale</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- EdgeBand Names Tab -->
  <div class="tab-pane fade" id="edgebandNamesTab">
    <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#edgebandNameModal">Add Name</button>
    <div class="table-responsive">
      <table class="table table-bordered" id="edgebandNamesTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Depth (mm)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- EdgeBand Modal -->
<div class="modal fade" id="edgebandModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="edgebandForm">
        <div class="modal-header">
          <h5 class="modal-title" id="edgebandModalTitle">Add EdgeBand</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edgebandId">
          <div class="mb-3">
            <label for="edgeband_name_id" class="form-label">EdgeBand Name</label>
            <select id="edgeband_name_id" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label for="e_thickness" class="form-label">Thickness</label>
            <input type="number" id="e_thickness" class="form-control" step="0.01" required>
          </div>
          <div class="mb-3">
            <label for="brand_id" class="form-label">Brand</label>
            <select id="brand_id" class="form-select"></select>
          </div>
          <div class="mb-3">
            <label for="p_price" class="form-label">Purchase Price</label>
            <input type="number" id="p_price" class="form-control" step="0.01">
          </div>
          <div class="mb-3">
            <label for="s_price" class="form-label">Sale Price</label>
            <input type="number" id="s_price" class="form-control" step="0.01">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- EdgeBandName Modal -->
<div class="modal fade" id="edgebandNameModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="edgebandNameForm">
        <div class="modal-header">
          <h5 class="modal-title" id="edgebandNameModalTitle">Add EdgeBand Name</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edgebandNameId">
          <div class="mb-3">
            <label for="depth" class="form-label">Depth (mm)</label>
            <input type="number" id="depth" class="form-control" step="0.01" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(function(){
  const API = {
    edgebands: '/material/v1/edgebands/',
    edgebandNames: '/material/v1/edgeband-names/',
    brands: '/material/v1/brands/'
  };

  const csrf = $('meta[name="csrf-token"]').attr('content');

  // --- Load Selects ---
  function loadBrands() {
    return $.get(API.brands).done(data => {
      const sel = $("#brand_id").empty().append('<option value="">Select Brand</option>');
      (data.results || data).forEach(b=> sel.append(`<option value="${b.id}">${b.name}</option>`));
    });
  }

  function loadEdgebandNames() {
    return $.get(API.edgebandNames).done(data => {
      const sel = $("#edgeband_name_id").empty().append('<option value="">Select Name</option>');
      (data.results || data).forEach(n=> sel.append(`<option value="${n.id}">${n.name}</option>`));
      const tbody = $("#edgebandNamesTable tbody").empty();
      (data.results || data).forEach(n=>{
        tbody.append(`<tr data-id="${n.id}">
          <td>${n.name}</td>
          <td>${n.depth}</td>
          <td>
            <button class="btn btn-sm btn-warning edit-ebn">Edit</button>
            <button class="btn btn-sm btn-danger del-ebn">Delete</button>
          </td>
        </tr>`);
      });
    });
  }

  // --- Load EdgeBands Table ---
  function loadEdgeBands() {
    $.get(API.edgebands).done(res=>{
      const tbody = $("#edgebandsTable tbody").empty();
      (res.results || res).forEach(e=>{
        tbody.append(`<tr data-id="${e.id}">
          <td>${e.display_name}</td>
          <td>${e.e_thickness}</td>
          <td>${e.brand ? e.brand.name : "-"}</td>
          <td>${e.p_price}</td>
          <td>${e.s_price}</td>
          <td>
            <button class="btn btn-sm btn-warning edit-eb">Edit</button>
            <button class="btn btn-sm btn-danger del-eb">Delete</button>
          </td>
        </tr>`);
      });
    });
  }

  // --- Create / Update EdgeBand ---
  $("#edgebandForm").submit(function(e){
    e.preventDefault();
    const id = $("#edgebandId").val();
    const payload = {
      edgeband_name_id: Number($("#edgeband_name_id").val()),
      e_thickness: $("#e_thickness").val(),
      brand_id: $("#brand_id").val() ? Number($("#brand_id").val()) : null,
      p_price: $("#p_price").val() || 0,
      s_price: $("#s_price").val() || 0
    };
    $.ajax({
      url: id ? API.edgebands + id + "/" : API.edgebands,
      type: id ? "PUT" : "POST",
      headers: {'X-CSRFToken': csrf},
      contentType: "application/json",
      data: JSON.stringify(payload)
    }).done(()=>{
      $("#edgebandModal").modal("hide");
      loadEdgeBands();
    }).fail(xhr=> alert(xhr.responseText));
  });

  // --- Edit EdgeBand ---
  $("#edgebandsTable").on("click", ".edit-eb", function(){
    const tr = $(this).closest("tr");
    const id = tr.data("id");
    $.get(API.edgebands + id + "/").done(e=>{
      $("#edgebandId").val(e.id);
      $("#e_thickness").val(e.e_thickness);
      $("#p_price").val(e.p_price);
      $("#s_price").val(e.s_price);
      loadBrands();
      loadEdgebandNames().then(()=> $("#brand_id").val(e.brand ? e.brand.id : ""), $("#edgeband_name_id").val(e.edgeband_name.id));
      $("#edgebandModal").modal("show");
    });
  });

  // --- Delete EdgeBand ---
  $("#edgebandsTable").on("click", ".del-eb", function(){
    const id = $(this).closest("tr").data("id");
    if(confirm("Delete this EdgeBand?")){
      $.ajax({
        url: API.edgebands + id + "/",
        type: "DELETE",
        headers: {'X-CSRFToken': csrf}
      }).done(()=> loadEdgeBands());
    }
  });

  // --- Create / Update EdgeBandName ---
  $("#edgebandNameForm").submit(function(e){
    e.preventDefault();
    const id = $("#edgebandNameId").val();
    const payload = {depth: $("#depth").val()};
    $.ajax({
      url: id ? API.edgebandNames + id + "/" : API.edgebandNames,
      type: id ? "PUT" : "POST",
      headers: {'X-CSRFToken': csrf},
      contentType: "application/json",
      data: JSON.stringify(payload)
    }).done(()=>{
      $("#edgebandNameModal").modal("hide");
      $("#edgebandNameForm")[0].reset();
      loadEdgebandNames();
      loadEdgebandNames(); // refresh options in EdgeBand modal
    });
  });

  // --- Edit EdgeBandName ---
  $("#edgebandNamesTable").on("click", ".edit-ebn", function(){
    const tr = $(this).closest("tr");
    const id = tr.data("id");
    $.get(API.edgebandNames + id + "/").done(n=>{
      $("#edgebandNameId").val(n.id);
      $("#depth").val(n.depth);
      $("#edgebandNameModal").modal("show");
    });
  });

  // --- Delete EdgeBandName ---
  $("#edgebandNamesTable").on("click", ".del-ebn", function(){
    const id = $(this).closest("tr").data("id");
    if(confirm("Delete this EdgeBand Name?")){
      $.ajax({
        url: API.edgebandNames + id + "/",
        type: "DELETE",
        headers: {'X-CSRFToken': csrf}
      }).done(()=>{
        loadEdgebandNames();
      });
    }
  });

  // --- Initial load ---
  loadBrands();
  loadEdgebandNames();
  loadEdgeBands();
});

</script>
{% endblock %}
