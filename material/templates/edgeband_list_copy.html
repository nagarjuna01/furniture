{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-3">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">EdgeBand Management</h4>
    <div>
      <button class="btn btn-outline-secondary me-2"
              data-bs-toggle="modal"
              data-bs-target="#edgebandNameModal">
        Manage EdgeBand Names
      </button>

      <button class="btn btn-primary"
              id="addEdgebandBtn">
        Add EdgeBand
      </button>
    </div>
  </div>

  <!-- SEARCH -->
  <input id="searchInput"
         class="form-control mb-3"
         placeholder="Search by edgeband name">

  <!-- TABLE -->
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="edgebandsTable">
      <thead class="table-light">
        <tr>
          <th>EdgeBand</th>
          <th>Thickness</th>
          <th>Cost</th>
          <th>Selling</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <div class="d-flex justify-content-between">
    <button class="btn btn-outline-secondary btn-sm" id="edgebands-prev">Prev</button>
    <button class="btn btn-outline-secondary btn-sm" id="edgebands-next">Next</button>
  </div>

</div>

<!-- ===================================================== -->
<!-- EDGEBAND MODAL -->
<!-- ===================================================== -->
<div class="modal fade" id="edgebandModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <form id="edgebandForm">
        <div class="modal-header">
          <h5 class="modal-title" id="edgebandModalTitle">Add EdgeBand</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="edgebandId">

          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">EdgeBand Name</label>
              <select id="edgeband_name_id" class="form-select" required></select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Thickness</label>
              <input id="e_thickness" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Cost Price</label>
              <input id="p_price" type="number" step="0.01" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Selling Price</label>
              <input id="s_price" type="number" step="0.01" class="form-control" required>
            </div>

            <div class="col-12">
              <small class="text-muted">
                Minimum allowed price:
                <strong id="minPricePreview">-</strong>
              </small>
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Save</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- ===================================================== -->
<!-- EDGEBAND NAME MODAL -->
<!-- ===================================================== -->
<div class="modal fade" id="edgebandNameModal" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">EdgeBand Names</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- ADD / EDIT -->
        <form id="edgebandNameForm" class="mb-3">
          <input type="hidden" id="edgebandNameId">

          <div class="row g-2">
            <div class="col-6">
              <select id="ebn_brand_id" class="form-select" required></select>
            </div>
            <div class="col-4">
              <input id="depth"
                     type="number"
                     step="0.01"
                     class="form-control"
                     placeholder="Depth (mm)"
                     required>
            </div>
            <div class="col-2 d-grid">
              <button class="btn btn-success">Save</button>
            </div>
          </div>
        </form>

        <!-- LIST -->
        <table class="table table-sm table-hover" id="edgebandNamesTable">
          <thead>
            <tr>
              <th>Name</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="ebn-prev">Prev</button>
          <button class="btn btn-sm btn-outline-secondary" id="ebn-next">Next</button>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// window.CURRENT_USER_IS_SUPERUSER = {{request.user.is_superuser|yesno:"true,false" }};
</script>

<script>
$(function(){

const API = {
  edgebands: "/material/v1/edgebands/",
  edgebandNames: "/material/v1/edgeband-names/",
  brands: "/material/v1/brands/"
};

let edgebandsPage=1, ebNext=null, ebPrev=null;
let ebnPage=1, ebnNext=null, ebnPrev=null;
let currentEdgebandId=null;

/* ================= HELPERS ================= */
function toast(msg){ alert(msg); }

/* ===================== SELECT2 ===================== */
function initSelect2(){

  // EdgeBand Name (main modal)
  $("#edgeband_name_id").select2({
    theme: "bootstrap-5",
    placeholder: "Select EdgeBand",
    allowClear: true,
    dropdownParent: $("#edgebandModal"),
    width: "100"
  });

  // Brand (EdgeBand Name modal)
  $("#ebn_brand_id").select2({
    theme: "bootstrap-5",
    placeholder: "Select Brand",
    allowClear: true,
    dropdownParent: $("#edgebandNameModal"),
    width: "100"
  });
}


/* ================= LOADERS ================= */
function loadBrands(){
  return $.get(API.brands).done(r=>{
    const sel=$("#ebn_brand_id");

    sel.empty().append(`<option></option>`);
    r.results.forEach(b=>{
      sel.append(`<option value="${b.id}">${b.name}</option>`);
    });

    sel.trigger("change.select2");
  });
}


function loadEdgebandNames(page=1){
  return $.get(API.edgebandNames+`?page=${page}`).done(r=>{
    const sel = $("#edgeband_name_id");

    sel.empty().append(`<option></option>`); // placeholder support
    $("#edgebandNamesTable tbody").empty();

    r.results.forEach(n=>{
      sel.append(`<option value="${n.id}">${n.name}</option>`);
      $("#edgebandNamesTable tbody").append(`
        <tr data-id="${n.id}">
          <td>${n.name}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-warning edit-ebn">‚úè</button>
            <button class="btn btn-sm btn-danger del-ebn">üóë</button>
          </td>
        </tr>
      `);
    });

    // refresh Select2
    sel.trigger("change.select2");

    ebnNext=r.next;
    ebnPrev=r.previous;
    ebnPage=page;
  });
}

function loadEdgeBands(params = {}) {
  const query = new URLSearchParams();

  // pagination
  query.append("page", params.page || 1);

  // search
  const search = $("#searchInput").val();
  if (search) query.append("search", search);

  // filters
  if (params.edgeband_name) query.append("edgeband_name", params.edgeband_name);
  if (params.thickness) query.append("thickness", params.thickness);
  if (params.is_active !== undefined) query.append("is_active", params.is_active);

  const url = `${API.edgebands}?${query.toString()}`;
  console.log("üîó Fetch URL:", url);

  $.get(url).done(r => {
    const tb = $("#edgebandsTable tbody").empty();

    r.results.forEach(e => {
      // Determine status
      const statusLabel = e.is_active ? "Active" : "Inactive";
      const statusClass = e.is_active ? "text-success" : "text-secondary";
      const btnLabel = e.is_active ? "Deactivate" : "Activate";
      const btnClass = e.is_active ? "btn-danger" : "btn-success";

      tb.append(`
        <tr data-id="${e.id}" data-active="${e.is_active}">
    <td>${e.edgeband_name_label}</td>
    <td>${e.thickness || "-"}</td>
    <td>${e.cost_price}</td>
    <td>${e.sell_price}</td>
    <td class="${statusClass}">${statusLabel}</td>
    <td>
      <button class="btn btn-sm btn-warning edit-eb">Edit</button>
      <button class="btn btn-sm ${btnClass} toggle-eb">${btnLabel}</button>
    </td>
  </tr>
      `);
    });

    ebNext = r.next;
    ebPrev = r.previous;
    edgebandsPage = params.page || 1;
  }).fail(err => console.error(err));
}

// toggle button
$("#edgebandsTable").on("click", ".toggle-eb", function () {
  const $row = $(this).closest("tr");
  const id = $row.data("id");
  const currentState = $row.find("td:nth-child(5)").text() === "Active";

  $.ajax({
    url: `${API.edgebands}${id}/`,
    type: "PATCH",
    contentType: "application/json",
    data: JSON.stringify({ is_active: !currentState }),
    headers: { "X-CSRFToken": window.CSRF_TOKEN }
  })
  .done(() => loadEdgeBands({ page: edgebandsPage }))
  .fail(err => console.error(err));
});

// search debounce
$("#searchInput").on("input", debounce(() => loadEdgeBands({ page: 1 }), 400));

function debounce(fn, delay = 400) {
  let t;
  return function (...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
}

/* ================= PRICING ================= */
$("#p_price").on("input",()=>{
  const v=parseFloat($("#p_price").val()||0);
  $("#minPricePreview").text((v*1.2).toFixed(2));
});

/* ================= EDGEBAND CRUD ================= */
$("#addEdgebandBtn").click(()=>{
  currentEdgebandId=null;
  $("#edgebandForm")[0].reset();
  $("#edgebandModalTitle").text("Add EdgeBand");
  $("#edgebandModal").modal("show");
});

$("#edgebandForm").submit(function(e){
  e.preventDefault();

  const payload={
    edgeband_name:Number($("#edgeband_name_id").val()),
    thickness:$("#e_thickness").val(),
    cost_price:$("#p_price").val(),
    sell_price:$("#s_price").val()
  };

  const url=currentEdgebandId?API.edgebands+currentEdgebandId+"/":API.edgebands;
  const method=currentEdgebandId?"PUT":"POST";

  $.ajax({url,method,headers:{'X-CSRFToken':CSRF_TOKEN},
          contentType:"application/json",data:JSON.stringify(payload)})
    .done(()=>{ $("#edgebandModal").modal("hide"); loadEdgeBands(edgebandsPage); });
});

$("#saveAsNewBtn").click(()=>{
  currentEdgebandId=null;
  $("#edgebandForm").submit();
});

$("#edgebandsTable").on("click",".edit-eb",function(){
  const id=$(this).closest("tr").data("id");
  currentEdgebandId=id;

  $.get(API.edgebands+id+"/").done(e=>{
    $("#edgebandModalTitle").text("Edit EdgeBand");
    $("#p_price").val(e.cost_price);
    $("#s_price").val(e.sell_price);
    $("#e_thickness").val(e.thickness);

    loadEdgebandNames().then(()=>{
      $("#edgeband_name_id").val(e.edgeband_name).trigger("change");
      $("#edgebandModal").modal("show");
    });
  });
});

$("#edgebandsTable").on("click", ".del-eb", function(){
  const $row = $(this).closest("tr");
  const id = $row.data("id");
  const currentlyActive = $row.find("td.status").text() === "Active";
  const action = currentlyActive ? "Deactivate" : "Activate";

  if(!confirm(`${action} this EdgeBand?`)) return;

  $.ajax({
    url: API.edgebands + id + "/",
    method: "PATCH",
    headers: { 'X-CSRFToken': CSRF_TOKEN },
    contentType: "application/json",
    data: JSON.stringify({ is_active: !currentlyActive })
  }).done(() => loadEdgeBands(edgebandsPage))
    .fail(err => console.error(err));
});


/* ================= EDGEBAND NAME CRUD ================= */
$("#edgebandNameForm").submit(function(e){
  e.preventDefault();
  const id=$("#edgebandNameId").val();

  const payload={
    brand:Number($("#ebn_brand_id").val()),
    depth:$("#depth").val()
  };

  $.ajax({
    url:id?API.edgebandNames+id+"/":API.edgebandNames,
    method:id?"PUT":"POST",
    headers:{'X-CSRFToken':CSRF_TOKEN},
    contentType:"application/json",
    data:JSON.stringify(payload)
  })
  .done(()=>{
    $("#edgebandNameForm")[0].reset();
    $("#edgebandNameId").val("");
    loadEdgebandNames(ebnPage);
  })
  .fail(r=>toast(r.responseJSON?.detail||"Cannot delete / save"));
});

$("#edgebandNamesTable").on("click",".edit-ebn",function(){
  const id=$(this).closest("tr").data("id");
  $.get(API.edgebandNames+id+"/").done(n=>{
    $("#edgebandNameId").val(n.id);
    $("#depth").val(n.depth);
    $("#ebn_brand_id").val(n.brand).trigger("change");
  });
});

$("#edgebandNamesTable").on("click",".del-ebn",function(){
  const id=$(this).closest("tr").data("id");
  if(!confirm("Delete this EdgeBand Name?")) return;

  $.ajax({
    url:API.edgebandNames+id+"/",
    method:"DELETE",
    headers:{'X-CSRFToken':CSRF_TOKEN}
  })
  .done(()=>loadEdgebandNames(ebnPage))
  .fail(()=>toast("Cannot delete: used by EdgeBands"));
});

/* ================= INIT ================= */
loadBrands();
loadEdgebandNames();
loadEdgeBands();
initSelect2();
});
</script>
{% endblock %}
