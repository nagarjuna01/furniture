{% extends 'base.html'%}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #sidebar {
            position: fixed;
            top: 56px;  /* Adjust this value to match your navbar height */
            left: 0;
            height: calc(100vh - 56px);  /* Subtract the navbar height to prevent overlap */
            width: 250px;
            background-color: #f8f9fa;
            padding-top: 20px;
            overflow-y: auto;
            z-index: 100;  /* Ensure the sidebar is behind the navbar */
        }

        /* Main Content */
        #main-content {
            margin-left: 260px;
            padding: 20px;
        }

        /* Sidebar header */
        #sidebar h4 {
            padding-left: 15px;
            margin-bottom: 20px;
        }

        /* Responsive layout */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
                margin-bottom: 20px;
            }

            #main-content {
                margin-left: 0;
            }
        }

        /* Modal Custom Styling */
        .modal-header {
            background-color: #f1f1f1;
        }
        .modal-footer {
            justify-content: space-between;
        }
    </style>
</head>

<body>

<!-- Sidebar -->
<div id="sidebar" class="col-md-3">
    
    <button id="add-group-btn" class="btn btn-success">Add Hardware Type</button>
    <br/>
    <br/>
    <h6>Select Hardware Type </h6>
    
    <ul id="hardware-group-list" class="list-group">
        <!-- Hardware groups will be dynamically inserted here -->
    </ul>
    
</div>

<!-- Modal for Add/Edit Hardware Group -->
<div class="modal fade" id="hardwareGroupModal" tabindex="-1" role="dialog" aria-labelledby="hardwareGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hardwareGroupModalLabel">Add/Edit Hardware Type</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="hardware-group-form">
                    <input type="hidden" id="hardware-group-id">
                    <div class="form-group">
                        <label for="name">Group Name</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <button type="submit" class="btn btn-success">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Main content area -->
<div id="main-content" class="col-md-9">
    
    <div id="hardware-list-container">
        <!-- Hardware details will be dynamically inserted here -->
    </div>
    <button id="add-hardware-btn" class="btn btn-primary mt-3" style="display:none;">Add Hardware</button> <!-- Initially hidden -->
</div>

<!-- Modal for Add/Edit hardware -->
<div class="modal" id="hardware-modal" tabindex="-1" aria-labelledby="hardwareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hardwareModalLabel">Add/Edit Hardware</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="hardware-form">
                    <div class="mb-3">
                        <label for="h_name" class="form-label">Hardware Name</label>
                        <input type="text" class="form-control" id="h_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="brand" class="form-label">Brand</label>
                        <select class="form-select" id="brand" required>
                            <option value="">Select Brand</option>
                            <!-- Brands will be dynamically populated here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="unit" class="form-label">Unit</label>
                        <select class="form-control" id="unit" required>
                            <option value="each" selected>Each</option>
                            <option value="set">Set</option>
                            <option value="nos">Nos</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="p_price" class="form-label">Purchase Price</label>
                        <input type="number" class="form-control" id="p_price" required>
                    </div>
                    <div class="mb-3">
                        <label for="s_price" class="form-label">Selling Price</label>
                        <input type="number" class="form-control" id="s_price" required>
                    </div>
                    <input type="hidden" id="hardware-id"> <!-- Hidden field to store hardware id for editing -->
                    <input type="hidden" id="group-id"> <!-- Hidden field for group ID -->
                    <button type="submit" class="btn btn-primary">Save Hardware</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // CSRF token setup for AJAX requests
    function getCSRFToken() {
        return $('meta[name="csrf-token"]').attr('content');
    }

    $.ajaxSetup({
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    });

    $(document).ready(function() {
        const apiUrl = '/material/hardware-groups/';  // Endpoint for hardware groups
        const hardwareUrl = '/material/hardware/';  // Endpoint for hardware items
        const brandUrl = '/material/brands/';  // Brand API endpoint
        $('#add-group-btn').on('click', function() {
            $('#hardware-group-id').val(''); // Reset hidden group ID field
            $('#name').val(''); // Clear the input field
            $('#hardwareGroupModalLabel').text('Add Hardware Group'); // Set modal title
            $('#hardwareGroupModal').modal('show'); // Show the modal
        });
        // Handle form submission for adding/editing hardware groups
        $('#hardware-group-form').on('submit', function(e) {
            e.preventDefault();
            const id = $('#hardware-group-id').val();
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiUrl}${id}/` : apiUrl;

            const groupData = {
                name: $('#name').val()
            };

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(groupData),
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                success: function() {
                    fetchHardwareGroups();
                    $('#hardwareGroupModal').modal('hide');
                    $('#hardware-group-form')[0].reset();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error saving hardware group:', textStatus, errorThrown);
                }
            });
        });

        // Edit hardware group function
        window.editHardwareGroup = function(id) {
            $.ajax({
                url: `${apiUrl}${id}/`,
                method: 'GET',
                success: function(group) {
                    $('#hardware-group-id').val(group.id);
                    $('#name').val(group.name);
                    $('#hardwareGroupModal').modal('show');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching hardware group for edit:', textStatus, errorThrown);
                }
            });
        };

        window.deleteHardwareGroup = function(id) {
            if (confirm('Are you sure you want to delete this group?')) {
                $.ajax({
                    url: `${apiUrl}${id}/`,
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()  // Add CSRF token here explicitly
                    },
                    success: function() {
                        fetchHardwareGroups();  // Refresh the list of hardware groups
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error deleting hardware group:', textStatus, errorThrown);
                        alert('Failed to delete hardware group. Please try again.');
                    }
                });
            }
        };

        // Fetch and display hardware groups
        function fetchHardwareGroups() {
            $.ajax({
                url: apiUrl,
                method: 'GET',
                success: function(data) {
                    const groups = data.results || [];
                    const groupList = $('#hardware-group-list');
                    groupList.empty();  // Clear previous list

                    groups.forEach(group => {
                        groupList.append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="#" onclick="viewHardwareGroup(${group.id})" style="text-decoration: none; color: inherit;">
                                    <span>${group.name}</span>
                                </a>
                                <div>
                                    <button class="btn btn-warning btn-sm" onclick="editHardwareGroup(${group.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteHardwareGroup(${group.id})">Delete</button>
                                </div>
                            </li>
                        `);
                    });
                },
                error: function() {
                    alert('Error fetching hardware groups.');
                }
            });
        }

        // Fetch and display brands for the brand dropdown
        function fetchBrands() {
            $.ajax({
                url: brandUrl,
                method: 'GET',
                success: function(data) {
                    const brands = data.results || [];
                    const brandSelect = $('#brand');
                    brandSelect.empty();  // Clear existing options
                    brandSelect.append('<option value="">Select Brand</option>');

                    brands.forEach(brand => {
                        brandSelect.append(`<option value="${brand.id}">${brand.name}</option>`);
                    });
                },
                error: function() {
                    alert('Error fetching brands.');
                }
            });
        }

        // View hardware group details
        window.viewHardwareGroup = function(groupId) {
            $.ajax({
                url: `${hardwareUrl}?group_id=${groupId}`,
                method: 'GET',
                success: function(data) {
                    const hardwareList = data.results || [];
                    $('#hardware-list-container').html('<h5>Hardware Details</h5>');
                    const table = $('<table class="table table-striped"><thead><tr><th>Name</th><th>Brand</th><th>Unit</th><th>Price</th><th>Actions</th></tr></thead><tbody></tbody></table>');
                    const tbody = table.find('tbody');

                    hardwareList.forEach(hardware => {
                        tbody.append(`
                            <tr>
                                <td>${hardware.h_name}</td>
                                <td>${hardware.brand ? hardware.brand.name : 'No brand'}</td>
                                <td>${hardware.unit}</td>
                                <td>${hardware.p_price}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="editHardware(${hardware.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteHardware(${hardware.id})">Delete</button>
                                </td>
                            </tr>
                        `);
                    });
                    $('#add-hardware-btn').show().attr('data-group-id', groupId); // Save the groupId to button data
                    $('#hardware-list-container').append(table);

                    
                    
                },
                error: function() {
                    alert('Error fetching hardware data.');
                }
            });
        };

        // Show the modal when clicking on the "Add Hardware" button
        $('#add-hardware-btn').click(function() {
            const groupId = $(this).attr('data-group-id');
            $('#group-id').val(groupId); // Set the group ID in the hidden input
            $('#hardware-form')[0].reset(); // Reset the form
            $('#hardware-modal').modal('show'); // Show the modal
        });

        function saveHardware(event) {
            event.preventDefault();
        
            const id = $('#hardware-id').val();
            const groupId = $('#group-id').val();  // Ensure this is being captured correctly
        
            // Validate that a group is selected
            if (!groupId) {
                alert('Hardware group is required.');
                return;
            }
        
            const data = {
                h_name: $('#h_name').val(),
                brand: $('#brand').val(),  // Use the selected brand ID
                unit: $('#unit').val(),
                p_price: $('#p_price').val(),
                s_price: $('#s_price').val(),
                h_group: groupId,  // Change 'group' to 'h_group' here
            };
        
            let method = 'POST';
            let url = hardwareUrl;
        
            if (id) {
                method = 'PUT';
                url = `${hardwareUrl}${id}/`;  // Edit existing hardware
            }
        
            $.ajax({
                url: url,
                method: method,
                data: data,
                success: function() {
                    $('#hardware-modal').modal('hide');
                    fetchHardwareGroups();  // Reload the list after adding/editing
                    viewHardwareGroup(groupId);  // Refresh hardware list for this group
                    $('#hardware-form')[0].reset(); // Reset form
                    $('#hardware-id').val(''); // Clear the hidden ID
                },
                error: function() {
                    alert('Error saving hardware.');
                }
            });
        }

        // Edit hardware
        window.editHardware = function(hardwareId) {
            $.ajax({
                url: `${hardwareUrl}${hardwareId}/`,
                method: 'GET',
                success: function(data) {
                    const hardware = data;
                    $('#h_name').val(hardware.h_name);
                    $('#brand').val(hardware.brand);
                    $('#unit').val(hardware.unit);
                    $('#p_price').val(hardware.p_price);
                    $('#s_price').val(hardware.s_price);
                    $('#hardware-id').val(hardware.id);  // Set the ID in the hidden field
                    $('#group-id').val(hardware.h_group.id);  // h_group ID (group's ID)
                    $('#hardware-modal').modal('show');  // Open the modal
                },
                error: function() {
                    alert('Error fetching hardware details.');
                }
            });
        };

        // Delete hardware
        window.deleteHardware = function(hardwareId) {
            if (confirm('Are you sure you want to delete this hardware?')) {
                $.ajax({
                    url: `${hardwareUrl}${hardwareId}/`,
                    method: 'DELETE',
                    success: function() {
                        viewHardwareGroup(groupId);  // Refresh hardware list for this group
                    },
                    error: function() {
                        alert('Error deleting hardware.');
                    }
                });
            }
        };

        // Handle form submission
        $('#hardware-form').submit(saveHardware);

        // Fetch hardware groups and brands on page load
        fetchHardwareGroups();
        fetchBrands();
    });
</script>

</body>
{% endblock %}
