{% extends "base_b.html" %}
{% load static %}

{% block title %}Wooden Products - Furniture Store{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Wooden Products</h1>
    {% include "material/subnav.html" %}  {# Sub-navbar placed below heading #}

    <div class="card card-body mb-4 sticky-top" style="top: 0; z-index: 1020;"> {# sticky-top for fixed position on scroll #}
        <form id="filter-form" class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="brand-filter" class="visually-hidden">Brand:</label>
                <select id="brand-filter" name="brand" class="form-select">
                    <option value="">All Brands</option>
                    {# Options will be populated by JavaScript #}
                </select>
            </div>

            <div class="col-auto">
                <label for="material-group-filter" class="visually-hidden">Material Group:</label>
                <select id="material-group-filter" name="material_grp" class="form-select">
                    <option value="">All Material Groups</option>
                    {# Options will be populated by JavaScript #}
                </select>
            </div>

            <div class="col-auto">
                <label for="material-type-filter" class="visually-hidden">Material Type:</label>
                <select id="material-type-filter" name="material_type" class="form-select" disabled>
                    <option value="">All Material Types</option>
                    {# Options will be populated by JavaScript #}
                </select>
            </div>

            <div class="col-auto">
                <label for="material-model-filter" class="visually-hidden">Material Model:</label>
                <select id="material-model-filter" name="material_model" class="form-select" disabled>
                    <option value="">All Material Models</option>
                    {# Options will be populated by JavaScript #}
                </select>
            </div>

            <div class="col-auto">
                <label for="thickness-filter" class="visually-hidden">Thickness:</label>
                <input type="text" id="thickness-filter" name="thickness" placeholder="Thickness (e.g., 18)" class="form-control">
            </div>

            <div class="col-auto">
                <label class="visually-hidden">Price Range ($):</label>
                <div class="input-group">
                    <input type="number" id="min-sell-price-filter" name="min_sell_price" placeholder="Min Price" class="form-control">
                    <input type="number" id="max-sell-price-filter" name="max_sell_price" placeholder="Max Price" class="form-control">
                </div>
            </div>

            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
            <div class="col-auto">
                <button type="button" id="clear-filters-btn" class="btn btn-secondary">Clear</button>
            </div>
        </form>
    </div>

    <div class="d-flex justify-content-end mb-4">
        <button onclick="openProductModal()" class="btn btn-success">Add New Product</button>
    </div>

    <div class="mb-4">
        <div id="loading-message" class="text-center text-muted py-3">Loading products...</div>
        <div id="error-message" class="alert alert-danger hidden" role="alert">
            <strong>Error!</strong>
            <span id="error-text"></span>
        </div>
        <div id="wooden-products-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {# Product cards will be rendered here by JavaScript #}
        </div>
    </div>
</div>

<div class="modal fade" id="product-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="product-form" class="row g-3">
                    <input type="hidden" id="product-id">

                    <div class="col-md-4">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" id="name" name="name" required class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label for="modal-brand" class="form-label">Brand</label>
                        <select id="modal-brand" name="brand" required class="form-select">
                            {# Options will be populated by JavaScript #}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="modal-material_grp" class="form-label">Material Group</label>
                        <select id="modal-material_grp" name="material_grp" required class="form-select">
                            {# Options will be populated by JavaScript #}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="modal-material_type" class="form-label">Material Type</label>
                        <select id="modal-material_type" name="material_type" required class="form-select">
                            {# Options will be populated by JavaScript #}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="modal-material_model" class="form-label">Material Model (Optional)</label>
                        <select id="modal-material_model" name="material_model" class="form-select">
                            <option value="">None</option>
                            {# Options will be populated by JavaScript #}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="color" class="form-label">Color</label>
                        <input type="text" id="color" name="color" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label for="length" class="form-label">Length</label>
                        <div class="input-group">
                            <input type="number" id="length" name="length" step="0.01" required class="form-control">
                            <select id="length_unit" name="length_unit" class="form-select">
                                <option value="mm">mm</option>
                                <option value="cm">cm</option>
                                <option value="m">m</option>
                                <option value="inch">inch</option>
                                <option value="ft">ft</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="width" class="form-label">Width</label>
                        <div class="input-group">
                            <input type="number" id="width" name="width" step="0.01" required class="form-control">
                            <select id="width_unit" name="width_unit" class="form-select">
                                <option value="mm">mm</option>
                                <option value="cm">cm</option>
                                <option value="m">m</option>
                                <option value="inch">inch</option>
                                <option value="ft">ft</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="thickness" class="form-label">Thickness</label>
                        <div class="input-group">
                            <input type="number" id="thickness" name="thickness" step="0.01" required class="form-control">
                            <select id="thickness_unit" name="thickness_unit" class="form-select">
                                <option value="mm">mm</option>
                                <option value="cm">cm</option>
                                <option value="m">m</option>
                                <option value="inch">inch</option>
                                <option value="ft">ft</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="cost_price" class="form-label">Cost Price</label>
                        <input type="number" id="cost_price" name="cost_price" step="0.01" required class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="costprice_type" class="form-label">Cost Price Type</label>
                        <select id="costprice_type" name="costprice_type" required class="form-select">
                            <option value="panel">Panel Price</option>
                            <option value="sft">Price Per Sqft</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="sell_price" class="form-label">Sell Price</label>
                        <input type="number" id="sell_price" name="sell_price" step="0.01" required class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="sellprice_type" class="form-label">Sell Price Type</label>
                        <select id="sellprice_type" name="sellprice_type" required class="form-select">
                            <option value="panel">Panel Price</option>
                            <option value="sft">Price Per Sqft</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="grain" class="form-label">Grain Direction</label>
                        <select id="grain" name="grain" required class="form-select">
                            <option value="2">Vertical</option>
                            <option value="0">Horizontal</option>
                            <option value="1">None</option>
                        </select>
                    </div>

                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // --- DOM Element Constants ---
    const productsContainer = document.getElementById('wooden-products-container');
    const loadingMessage = document.getElementById('loading-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const filterForm = document.getElementById('filter-form');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');

    // Filter Bar Elements
    const brandFilter = document.getElementById('brand-filter');
    const materialGroupFilter = document.getElementById('material-group-filter');
    const materialTypeFilter = document.getElementById('material-type-filter');
    const materialModelFilter = document.getElementById('material-model-filter');
    const thicknessFilter = document.getElementById('thickness-filter');
    const minSellPriceFilter = document.getElementById('min-sell-price-filter');
    const maxSellPriceFilter = document.getElementById('max-sell-price-filter');

    // Modal elements (Get Bootstrap Modal instance)
    const productModalElement = document.getElementById('product-modal');
    // Using Bootstrap's JS API to control the modal
    const productModal = new bootstrap.Modal(productModalElement);
    const modalTitle = document.getElementById('modal-title');
    const productForm = document.getElementById('product-form');
    const productIdInput = document.getElementById('product-id');

    // Modal form fields
    const nameInput = document.getElementById('name');
    const modalBrandSelect = document.getElementById('modal-brand');
    const modalMaterialGrpSelect = document.getElementById('modal-material_grp');
    const modalMaterialTypeSelect = document.getElementById('modal-material_type');
    const modalMaterialModelSelect = document.getElementById('modal-material_model');
    const colorInput = document.getElementById('color');
    const lengthInput = document.getElementById('length');
    const lengthUnitSelect = document.getElementById('length_unit');
    const widthInput = document.getElementById('width');
    const widthUnitSelect = document.getElementById('width_unit');
    const thicknessInput = document.getElementById('thickness');
    const thicknessUnitSelect = document.getElementById('thickness_unit');
    const costPriceInput = document.getElementById('cost_price');
    const costPriceTypeSelect = document.getElementById('costprice_type');
    const sellPriceInput = document.getElementById('sell_price');
    const sellPriceTypeSelect = document.getElementById('sellprice_type');
    const grainSelect = document.getElementById('grain');

    // --- API URLs ---
    const API_URL = 'http://127.0.0.1:8000/material/v1/woodens/';
    const BRANDS_API_URL = 'http://127.0.0.1:8000/material/v1/brands/';
    const CATEGORIES_API_URL = 'http://127.0.0.1:8000/material/v1/categories/'; // This is Material Groups
    const CATEGORY_TYPES_API_URL = 'http://127.0.0.1:8000/material/v1/category-types/'; // This is Material Types
    const CATEGORY_MODELS_API_URL = 'http://127.0.0.1:8000/material/v1/category-models/'; // This is Material Models

    // --- Helper Functions ---

    function getCsrfToken() {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        return csrfMeta ? csrfMeta.getAttribute('content') : '';
    }

    async function fetchData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.results || data; // Assuming your DRF returns data in 'results' for list views
        } catch (error) {
            console.error("Error fetching data from:", url, error);
            return [];
        }
    }

    // Helper function to populate a select element
    function populateSelect(selectElement, options, defaultText, initialValue = '', includeNoneOption = false) {
        selectElement.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultText;
        if (!includeNoneOption) { // For "Select..." options that aren't valid filters
            defaultOption.selected = true;
            defaultOption.disabled = true;
        }
        selectElement.appendChild(defaultOption);

        let valueSet = false; // To track if initialValue was matched

        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.id;
            opt.textContent = option.name;
            selectElement.appendChild(opt);

            if (String(option.id) === String(initialValue)) {
                opt.selected = true;
                valueSet = true;
            }
        });

        // If an initialValue was provided but not found in options, reset to default
        if (!valueSet && initialValue) {
            selectElement.value = '';
        }

        // Enable/disable based on options availability
        selectElement.disabled = (options.length === 0 && !includeNoneOption);
    }

    // --- Filter Bar Dependent Dropdown Logic ---

    // Function to load Material Types for the filter bar
    async function loadFilterBarMaterialTypes(selectedGroupId, initialTypeId = null) {
        const url = selectedGroupId ? `${CATEGORY_TYPES_API_URL}?category=${selectedGroupId}` : null;
        const types = url ? await fetchData(url) : [];
        populateSelect(materialTypeFilter, types, 'All Material Types', initialTypeId, true);

        // After populating types, trigger loading models for the selected type in the filter bar
        const currentSelectedTypeId = materialTypeFilter.value;
        await loadFilterBarMaterialModels(currentSelectedTypeId, initialTypeId ? initialTypeId : null);
    }

    // Function to load Material Models for the filter bar
    async function loadFilterBarMaterialModels(selectedTypeId, initialModelId = null) {
        const url = selectedTypeId ? `${CATEGORY_MODELS_API_URL}?model_category=${selectedTypeId}` : null;
        const models = url ? await fetchData(url) : [];
        populateSelect(materialModelFilter, models, 'All Material Models', initialModelId, true);
    }

    // Event listeners for filter bar dropdowns
    materialGroupFilter.addEventListener('change', async () => {
        const selectedGroupId = materialGroupFilter.value;
        await loadFilterBarMaterialTypes(selectedGroupId);
    });

    materialTypeFilter.addEventListener('change', async () => {
        const selectedTypeId = materialTypeFilter.value;
        await loadFilterBarMaterialModels(selectedTypeId);
    });

    // --- Modal Dependent Dropdown Logic ---

    async function loadModalMaterialTypes(selectedGroupId, initialTypeId = null) {
        const url = selectedGroupId ? `${CATEGORY_TYPES_API_URL}?category=${selectedGroupId}` : null;
        const types = url ? await fetchData(url) : [];
        populateSelect(modalMaterialTypeSelect, types, 'Select Material Type', initialTypeId);

        const currentSelectedTypeId = modalMaterialTypeSelect.value;
        await loadModalMaterialModels(currentSelectedTypeId, initialTypeId ? initialTypeId : null);
    }

    async function loadModalMaterialModels(selectedTypeId, initialModelId = null) {
        const url = selectedTypeId ? `${CATEGORY_MODELS_API_URL}?model_category=${selectedTypeId}` : null;
        const models = url ? await fetchData(url) : [];
        populateSelect(modalMaterialModelSelect, models, 'None', initialModelId, true);
    }

    modalMaterialGrpSelect.addEventListener('change', async () => {
        const selectedGroupId = modalMaterialGrpSelect.value;
        await loadModalMaterialTypes(selectedGroupId);
    });

    modalMaterialTypeSelect.addEventListener('change', async () => {
        const selectedTypeId = modalMaterialTypeSelect.value;
        await loadModalMaterialModels(selectedTypeId);
    });

    // --- Main Functions (Product Display & CRUD) ---

    async function fetchAndRenderProducts(filters = {}) {
        loadingMessage.classList.remove('d-none'); // Bootstrap: use d-none for hidden
        productsContainer.innerHTML = '';
        errorMessage.classList.add('d-none'); // Bootstrap: use d-none for hidden

        let queryString = new URLSearchParams(filters).toString();
        let fetchUrl = `${API_URL}?${queryString}`;

        try {
            const data = await fetchData(fetchUrl);
            loadingMessage.classList.add('d-none');
            let productsToDisplay = data || [];

            if (productsToDisplay.length === 0) {
                productsContainer.innerHTML = '<p class="text-center text-muted col-12">No wooden products found matching your criteria.</p>';
                return;
            }

            productsToDisplay.forEach(product => {
                const productCard = `
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">${product.name || 'N/A'}</h5>
                                <p class="card-text mb-1"><strong>Brand:</strong> ${product.brand ? product.brand.name : 'N/A'}</p>
                                <p class="card-text mb-1"><strong>Material Group:</strong> ${product.material_grp ? product.material_grp.name : 'N/A'}</p>
                                <p class="card-text mb-1"><strong>Material Type:</strong> ${product.material_type ? product.material_type.name : 'N/A'}</p>
                                ${product.material_model ? `<p class="card-text mb-1"><strong>Model:</strong> ${product.material_model.name}</p>` : ''}
                                <p class="card-text mb-1"><strong>Dimensions:</strong> ${product.length || 'N/A'}${product.length_unit} x ${product.width || 'N/A'}${product.width_unit} x ${product.thickness || 'N/A'}${product.thickness_unit}</p>
                                <p class="card-text mb-1"><strong>Color:</strong> ${product.color || 'N/A'}</p>
                                <hr class="my-3">
                                <h4 class="text-primary fw-bold">
                                    Price: $${product.sell_price || 'N/A'}
                                    <span class="text-muted fs-6">(${product.sellprice_type === 'sft' ? 'per Sqft' : 'Panel Price'})</span>
                                </h4>
                                ${product.s_price_sft ? `<p class="text-muted fs-6">($${product.s_price_sft} per Sqft)</p>` : ''}
                            </div>
                            <div class="card-footer d-flex justify-content-end">
                                <button onclick="window.editProduct(${product.id})" class="btn btn-sm btn-info me-2">Edit</button>
                                <button onclick="window.deleteProduct(${product.id})" class="btn btn-sm btn-danger">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                productsContainer.innerHTML += productCard;
            });
        } catch (error) {
            console.error('Error fetching wooden products:', error);
            loadingMessage.classList.add('d-none');
            errorMessage.classList.remove('d-none');
            errorText.textContent = `Could not load wooden products: ${error.message}. Please try again later.`;
        }
    }

    // Function to populate filter dropdowns (filter bar)
    async function populateFilters() {
        try {
            // Fetch Brands for filter bar
            const brands = await fetchData(BRANDS_API_URL);
            populateSelect(brandFilter, brands, 'All Brands', '', true);

            // Fetch Material Groups (Categories) for filter bar
            const categories = await fetchData(CATEGORIES_API_URL);
            populateSelect(materialGroupFilter, categories, 'All Material Groups', '', true);

            // Initial load for dependent filter bar filters
            await loadFilterBarMaterialTypes(null); // Load all types initially (if API supports it)
            await loadFilterBarMaterialModels(null); // Load all models initially (if API supports it)

        } catch (error) {
            console.error('Error populating filter bar filters:', error);
        }
    }

    // Event listener for filter form submission (filter bar)
    filterForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const filters = {};

        // Collect values from all filter bar elements
        if (brandFilter.value) {
            filters.brand = brandFilter.value;
        }
        if (materialGroupFilter.value) {
            filters.material_grp = materialGroupFilter.value;
        }
        if (materialTypeFilter.value) {
            filters.material_type = materialTypeFilter.value;
        }
        if (materialModelFilter.value) {
            filters.material_model = materialModelFilter.value;
        }
        if (thicknessFilter.value) {
            filters.thickness = thicknessFilter.value;
        }
        if (minSellPriceFilter.value) {
            filters.min_sell_price = parseFloat(minSellPriceFilter.value);
        }
        if (maxSellPriceFilter.value) {
            filters.max_sell_price = parseFloat(maxSellPriceFilter.value);
        }

        fetchAndRenderProducts(filters);
    });

    // Event listener for clearing filters (filter bar)
    clearFiltersBtn.addEventListener('click', async function() {
        filterForm.reset();
        // Re-populate dependent dropdowns to their default 'All' state
        await populateFilters(); // Re-fetch initial options for all filters
        fetchAndRenderProducts({}); // Clear product filters
    });

    // --- Product Modal Logic ---

    // Function to open the product modal
    window.openProductModal = async function(productId = null) {
        productForm.reset(); // Clear the form
        productIdInput.value = ''; // Clear product ID

        modalMaterialTypeSelect.disabled = true; // Disable until material group is chosen
        modalMaterialModelSelect.disabled = true; // Disable until material type is chosen

        // Populate modal brands and categories always
        const brands = await fetchData(BRANDS_API_URL);
        populateSelect(modalBrandSelect, brands, 'Select Brand');
        const categories = await fetchData(CATEGORIES_API_URL);
        populateSelect(modalMaterialGrpSelect, categories, 'Select Material Group');

        if (productId) {
            modalTitle.textContent = 'Edit Product';
            try {
                const product = await fetchData(`${API_URL}${productId}/`);
                if (product) {
                    productIdInput.value = product.id;
                    nameInput.value = product.name;
                    modalBrandSelect.value = product.brand ? product.brand.id : '';
                    modalMaterialGrpSelect.value = product.material_grp ? product.material_grp.id : '';

                    // Load dependent dropdowns with existing values
                    if (product.material_grp && product.material_grp.id) {
                        await loadModalMaterialTypes(product.material_grp.id, product.material_type ? product.material_type.id : null);
                        if (product.material_type && product.material_type.id) {
                            await loadModalMaterialModels(product.material_type.id, product.material_model ? product.material_model.id : null);
                        }
                    }

                    colorInput.value = product.color;
                    lengthInput.value = product.length;
                    lengthUnitSelect.value = product.length_unit;
                    widthInput.value = product.width;
                    widthUnitSelect.value = product.width_unit;
                    thicknessInput.value = product.thickness;
                    thicknessUnitSelect.value = product.thickness_unit;
                    costPriceInput.value = product.cost_price;
                    costPriceTypeSelect.value = product.costprice_type;
                    sellPriceInput.value = product.sell_price;
                    sellPriceTypeSelect.value = product.sellprice_type;
                    grainSelect.value = product.grain;
                }
            } catch (error) {
                console.error('Error fetching product for edit:', error);
                alert('Failed to load product for editing.');
                return;
            }
        } else {
            modalTitle.textContent = 'Add New Product';
        }

        productModal.show(); // Show the Bootstrap modal
    };

    // Function to close the product modal
    window.closeProductModal = function() {
        productModal.hide(); // Hide the Bootstrap modal
    };

    // Event listener for product form submission (Add/Edit)
    productForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData(productForm);
        const data = Object.fromEntries(formData.entries());

        // Convert number fields that are expected to be numbers
        data.length = parseFloat(data.length);
        data.width = parseFloat(data.width);
        data.thickness = parseFloat(data.thickness);
        data.cost_price = parseFloat(data.cost_price);
        data.sell_price = parseFloat(data.sell_price);
        data.grain = parseInt(data.grain); // Assuming grain is an integer ID

        const productId = productIdInput.value;
        const method = productId ? 'PUT' : 'POST';
        const url = productId ? `${API_URL}${productId}/` : API_URL;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify(data),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API error: ${JSON.stringify(errorData)}`);
            }

            alert(`Product ${productId ? 'updated' : 'added'} successfully!`);
            productModal.hide(); // Hide the modal
            fetchAndRenderProducts({}); // Refresh product list
        } catch (error) {
            console.error(`Error ${productId ? 'updating' : 'adding'} product:`, error);
            alert(`Failed to ${productId ? 'update' : 'add'} product: ${error.message}`);
        }
    });

    // Global function for deleting products
    window.deleteProduct = async function(productId) {
        if (confirm('Are you sure you want to delete this product?')) {
            try {
                const response = await fetch(`${API_URL}${productId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                    },
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete product: ${response.status} ${response.statusText}`);
                }

                alert('Product deleted successfully!');
                fetchAndRenderProducts({}); // Refresh product list
            } catch (error) {
                console.error('Error deleting product:', error);
                alert(`Error deleting product: ${error.message}`);
            }
        }
    };

    // --- Initial Load on Page Load ---
    populateFilters(); // Populate filter bar dropdowns
    fetchAndRenderProducts(); // Initial fetch of all products
});
 </script>
{% endblock content %}