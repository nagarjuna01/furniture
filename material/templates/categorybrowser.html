{% extends 'base_b.html'%}
{% block content %}

<div class="container mt-5">
  <h1>Panel Material</h1>

 <!-- Dropdowns inside a box -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Material Selector</h5>
    </div>
    <div class="card-body">
      <div class="row align-items-end g-3">
        <!-- Category -->
        <div class="col-md-4">
  <button id="add-category-btn" class="btn btn-sm btn-success">Add</button>
  
  <label for="categories-select" class="form-label">Category</label>
  <select id="categories-select" class="form-select"></select>
  <div class="crud-buttons mt-2">
    <button id="edit-category-btn" class="btn btn-sm btn-warning">Edit</button>
    <button id="delete-category-btn" class="btn btn-sm btn-danger">Delete</button>
  </div>
</div>

        <!-- Type -->
        <div class="col-md-4">
        <button id="add-type-btn" class="btn btn-sm btn-success">Add</button>  
        <label for="types-select" class="form-label">Type</label>
        <select id="types-select" class="form-select"></select>
        <div class="crud-buttons mt-2">
        <button id="edit-type-btn" class="btn btn-sm btn-warning">Edit</button>
      <button id="delete-type-btn" class="btn btn-sm btn-danger">Delete</button>
        </div>
        </div>

        <!-- Model -->
        <div class="col-md-4">
          <button id="add-model-btn" class="btn btn-sm btn-success">Add</button>
          <label for="models-select" class="form-label">Model</label>
          <select id="models-select" class="form-select"></select>
        <div class="crud-buttons mt-2">
          <button id="edit-model-btn" class="btn btn-sm btn-warning">Edit </button>
      <button id="delete-model-btn" class="btn btn-sm btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>
  </div>
<!-- Add button placeholder -->
<div id="add-wooden-container" class="mb-3"></div>
  <!-- Wooden section below the dropdowns -->
  <div class="mt-4">
    <h4>Wooden Options</h4>
    <div id="add-wooden-container" class="mb-3"></div>
    <div id="wooden-list" class="row g-3"></div>

    <!-- Pagination Controls -->
    <nav class="mt-4">
      <ul class="pagination justify-content-center" id="wooden-pagination"></ul>
    </nav>
  </div>
</div>

<div class="modal fade" id="woodenModal" tabindex="-1" aria-labelledby="woodenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="wooden-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="woodenModalLabel">Add Wooden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="wooden-id"> <input type="hidden" id="wooden-category-hidden">
                    <input type="hidden" id="wooden-type-hidden">
                    <input type="hidden" id="wooden-model-hidden">

                    <ul class="nav nav-tabs mb-3" id="woodenTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-details-tab" data-bs-toggle="tab" data-bs-target="#basic-details" type="button" role="tab" aria-controls="basic-details" aria-selected="true">Basic Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pricing-other-tab" data-bs-toggle="tab" data-bs-target="#pricing-other" type="button" role="tab" aria-controls="pricing-other" aria-selected="false">Pricing & Other</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="woodenTabContent">

                        <div class="tab-pane fade show active" id="basic-details" role="tabpanel" aria-labelledby="basic-details-tab">
                            <div class="form-group mb-3">
                                <label for="wooden-brand">Brand</label>
                                <select id="wooden-brand" class="form-control" required></select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-name">Name</label>
                                <input type="text" id="wooden-name" class="form-control" required>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-grain">Grain</label>
                                <select id="wooden-grain" class="form-control">
                                    <option value="0">Horizontal</option>
                                    <option value="1">None</option>
                                    <option value="2">Vertical</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-length">Length</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" id="wooden-length" class="form-control" required>
                                    <select id="wooden-length-unit" class="form-select">
                                        <option value="mm">mm</option>
                                        <option value="cm">cm</option>
                                        <option value="m">m</option>
                                        <option value="inch">inch</option>
                                        <option value="ft">ft</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-width">Width</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" id="wooden-width" class="form-control" required>
                                    <select id="wooden-width-unit" class="form-select">
                                        <option value="mm">mm</option>
                                        <option value="cm">cm</option>
                                        <option value="m">m</option>
                                        <option value="inch">inch</option>
                                        <option value="ft">ft</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-thickness">Thickness</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" id="wooden-thickness" class="form-control" required>
                                    <select id="wooden-thickness-unit" class="form-select">
                                        <option value="mm">mm</option>
                                        <option value="cm">cm</option>
                                        <option value="m">m</option>
                                        <option value="inch">inch</option>
                                        <option value="ft">ft</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-color">Color</label>
                                <input type="text" id="wooden-color" class="form-control">
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="pricing-other" role="tabpanel" aria-labelledby="pricing-other-tab">
                            <div class="form-group mb-3">
                                <label for="wooden-compatible-edgebands">Compatible EdgeBands</label>
                                <select id="wooden-compatible-edgebands" class="form-control" multiple></select>
                            </div>
                            <div class="form-group mb-3">
                            <label for="wooden-primary-edgeband">Primary EdgeBand (Default)</label>
                            <select id="wooden-primary-edgeband" class="form-control">
                                <option value="">-- None --</option>
                            </select>
                        </div>
                            <div class="form-group mb-3">
                                <label for="wooden-cost-price">Cost Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" step="0.01" id="wooden-cost-price" class="form-control" required>
                                    <select id="wooden-costprice-type" class="form-select">
                                        <option value="panel">per Panel</option>
                                        <option value="sft">per Sqft</option>
                                        <option value="sqm">per SqM</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="wooden-sell-price">Sell Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" step="0.01" id="wooden-sell-price" class="form-control" required>
                                    <select id="wooden-sellprice-type" class="form-select">
                                        <option value="panel">per Panel</option>
                                        <option value="sft">per Sqft</option>
                                        <option value="sqm">per SqM</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="save-wooden-btn">Save Wooden</button>
                    <button type="button" class="btn btn-outline-primary" id="save-add-another-btn">Save and Add Another</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Entity Modal for Category/Type/Model -->
<div class="modal fade" id="entityModal" tabindex="-1" aria-labelledby="entityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="entity-form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entityModalLabel">Add Entity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="entity-type" />
        <input type="hidden" id="entity-id" />
        <div class="mb-3">
          <label for="entity-name" class="form-label">Name</label>
          <input type="text" class="form-control" id="entity-name" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
<!-- Bootstrap JS Bundle -->
{% block extra_js %}
<script>
// GET CSRF TOKEN FROM META TAG
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = $('meta[name="csrf-token"]').attr('content'); // Get it from the meta tag

// Setup AJAX for Django CSRF token
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// API URLs
const categoriesApi = 'http://127.0.0.1:8000/material/v1/categories/';
const typesApi = 'http://127.0.0.1:8000/material/v1/category-types/';
const modelsApi = 'http://127.0.0.1:8000/material/v1/category-models/';
const woodenApi = 'http://127.0.0.1:8000/material/v1/woodens/';

let currentPage = 1;
const itemsPerPage = 12;
let allWoodenData = []; // Stores ALL wooden items fetched from API
let filteredWoodenData = []; // Stores wooden items after applying filters

// Global variable to store all edgeband data for easy lookup - moved to top for clarity
window.allEdgebands = [];

function showAlert(msg) {
    alert(msg);
}

function setupEnableDisable(selectId, editBtnId, deleteBtnId) {
    const select = document.getElementById(selectId);
    const editBtn = document.getElementById(editBtnId);
    const deleteBtn = document.getElementById(deleteBtnId);

    editBtn.disabled = true;
    deleteBtn.disabled = true;
    editBtn.classList.remove('active');
    deleteBtn.classList.remove('active');

    select.addEventListener('change', () => {
        if (select.value) {
            editBtn.disabled = false;
            deleteBtn.disabled = false;
            editBtn.classList.add('active');
            deleteBtn.classList.add('active');
        } else {
            editBtn.disabled = true;
            deleteBtn.disabled = true;
            editBtn.classList.remove('active');
            deleteBtn.classList.remove('active');
        }
    });
}

setupEnableDisable('categories-select', 'edit-category-btn', 'delete-category-btn');
setupEnableDisable('types-select', 'edit-type-btn', 'delete-type-btn');
setupEnableDisable('models-select', 'edit-model-btn', 'delete-model-btn');

function renderWoodensPage(page) {
    console.log("Rendering woodens page. Filtered data length:", filteredWoodenData.length);
    const $woodenList = $('#wooden-list');
    $woodenList.empty();

    if (filteredWoodenData.length === 0) {
        $woodenList.append('<div class="col-12"><div class="alert alert-warning">No wooden items found matching the current filters.</div></div>');
        $('#wooden-pagination').empty();
        return;
    }

    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = filteredWoodenData.slice(start, end);

    pageItems.forEach((item, index) => {
        const size = `${item.length || '-'} ${item.length_unit || ''} × ${item.width || '-'} ${item.width_unit || ''}`;
        const price = `₹${item.sell_price} (${item.sellprice_type})`;
        const thickness = `${item.thickness} ${item.thickness_unit || 'mm'}`;
        const brand = item.brand?.name || 'Unknown';

        let grainText = 'N/A';
        console.log('item.grain raw:', item.grain);
        switch (String(item.grain)) {
    case '0':
        grainText = 'Horizontal';
        break;
    case '1':
        grainText = 'None';
        break;
    case '2':
        grainText = 'Vertical';
        break;
}

        const color = item.color && item.color !== "none" ? item.color : "N/A";

        const compatibleEdgebandsNames = (item.compatible_edgebands || [])
    .map(eb => `${eb.edge_depth}x${eb.e_thickness}`)
    .join(', ');

        $woodenList.append(`
    <div class="col-md-4">
        <div class="card h-100 shadow-sm wooden-card" data-id="${item.id}">
            <div class="card-body">
                <h5 class="card-title">${item.name}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${brand}</h6>
                <p class="card-text">
                    <strong>Thickness:</strong> ${thickness}<br>
                    <strong>Size:</strong> ${size}<br>
                    <strong>Grain:</strong> ${grainText}<br>
                    <strong>Color:</strong> ${color}<br>
                    <strong>Price:</strong> ${price}<br>
                    <strong>Compatible Edgebands:</strong> ${compatibleEdgebandsNames || 'None'}
                </p>
                <button class="btn btn-sm btn-primary edit-wooden-btn" data-id="${item.id}">Edit</button>
                <button class="btn btn-sm btn-danger delete-wooden-btn" data-id="${item.id}">Delete</button>
            </div>
        </div>
    </div>
`);
    });

    renderPaginationControls();
}

function renderPaginationControls() {
    const $pagination = $('#wooden-pagination');
    $pagination.empty();

    const totalPages = Math.ceil(filteredWoodenData.length / itemsPerPage);
    if (totalPages <= 1) return;

    $pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>
    `);

    for (let i = 1; i <= totalPages; i++) {
        $pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
    }

    $pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>
    `);
}

function loadBrands() {
    $.get('http://127.0.0.1:8000/material/v1/brands/')
        .done(data => {
            const brands = Array.isArray(data) ? data : data.results || [];
            const $brandSelect = $('#wooden-brand');
            $brandSelect.empty().append('<option value="">Select Brand</option>');
            brands.forEach(brand => {
                $brandSelect.append(new Option(brand.name, brand.id));
            });
            $brandSelect.select2({
                placeholder: 'Select a brand',
                allowClear: true,
                width: '100%',
                dropdownParent: $('#woodenModal')
            });
        })
        .fail(() => {
            showAlert('Failed to load brands');
            console.error('Failed to load brands API call');
        });
}

function loadEdgebands() {
    $.get('/material/v1/edgebands/')
        .done(data => {
            window.allEdgebands = data.results;

            const $compatibleSelect = $('#wooden-compatible-edgebands');
            const $primarySelect = $('#wooden-primary-edgeband');

            // Clear existing options from both dropdowns
            $compatibleSelect.empty();
            $primarySelect.empty();
            
            // Add a default "None" option to the primary select dropdown
            $primarySelect.append(new Option('-- None --', ''));

            window.allEdgebands.forEach(edgeband => {
                const optionText = `${edgeband.edge_depth}mm / ${edgeband.e_thickness}mm (${edgeband.brand?.name || 'No Brand'})`;
                const newOption = new Option(optionText, edgeband.id);

                // Clone the option and append to both dropdowns
                $compatibleSelect.append($(newOption).clone());
                $primarySelect.append(newOption);
            });

            // Re-initialize select2 for the compatible edgebands dropdown
            $compatibleSelect.select2({
                placeholder: 'Select compatible edgebands',
                allowClear: true,
                width: '100%',
                multiple: true,
                dropdownParent: $('#woodenModal')
            });
            
            // Initialize select2 for the primary edgeband dropdown
            $primarySelect.select2({
                placeholder: 'Select a primary edgeband',
                allowClear: true,
                width: '100%',
                dropdownParent: $('#woodenModal')
            });
        })
        .fail(error => {
            console.error('Error fetching or processing edgeband data:', error);
            showAlert('Failed to load compatible edgebands.');
        });
}

function loadCategories() {
    $.get(categoriesApi)
        .done(data => {
            const categories = Array.isArray(data) ? data : data.results || [];
            const $catSelect = $('#categories-select');
            $catSelect.empty().append('<option value="">All Categories</option>');
            categories.forEach(cat => {
                $catSelect.append(new Option(cat.name, cat.id));
            });
            $('#types-select').empty().append('<option value="">All Types</option>');
            $('#models-select').empty().append('<option value="">All Models</option>');
            $('#add-wooden-container').empty();
            // Important: call applyFiltersAndRenderWoodens after all initial dropdowns are setup
            applyFiltersAndRenderWoodens();
        })
        .fail(() => showAlert('Failed to load categories'));
}

function loadTypes(categoryId) {
    if (!categoryId) {
        $('#types-select').empty().append('<option value="">All Types</option>');
        $('#models-select').empty().append('<option value="">All Models</option>');
        $('#add-wooden-container').empty();
        applyFiltersAndRenderWoodens(); // Trigger filter when category changes to 'All'
        return;
    }

    $.get(`${typesApi}?category=${categoryId}`)
        .done(data => {
            const types = Array.isArray(data) ? data : data.results || [];
            const $typeSelect = $('#types-select');
            $typeSelect.empty().append('<option value="">All Types</option>');
            types.forEach(type => {
                $typeSelect.append(new Option(type.name, type.id));
            });
            $('#models-select').empty().append('<option value="">All Models</option>');
            $('#add-wooden-container').empty();
            applyFiltersAndRenderWoodens(); // Trigger filter when types are loaded
        })
        .fail(() => showAlert('Failed to load types'));
}

function loadModels(type_id) {
    if (!type_id) {
        $('#models-select').empty().append('<option value="">All Models</option>');
        $('#add-wooden-container').empty();
        applyFiltersAndRenderWoodens(); // Trigger filter when type changes to 'All'
        return;
    }

    $.get(`${modelsApi}?model_category=${type_id}`)
        .done(data => {
            const models = Array.isArray(data) ? data : data.results || [];
            const $modelSelect = $('#models-select');
            $modelSelect.empty().append('<option value="">All Models</option>');
            models.forEach(model => {
                $modelSelect.append(new Option(model.name, model.id));
            });
            $('#add-wooden-container').empty();
            applyFiltersAndRenderWoodens(); // Trigger filter when models are loaded
        })
        .fail(() => showAlert('Failed to load models'));
}

function loadAllWoodensAndFilter() {
    console.log("Fetching all wooden data...");
    $.get(woodenApi)
        .done(data => {
            allWoodenData = Array.isArray(data.results) ? data.results : [];
            console.log("All wooden data loaded:", allWoodenData);
            applyFiltersAndRenderWoodens(); // Apply filters after initial load
        })
        .fail(xhr => {
            showAlert('Failed to load all wooden options. ' + (xhr.responseJSON ? JSON.stringify(xhr.responseJSON) : xhr.statusText));
            console.error('Failed to load all wooden options:', xhr);
        });
}

// Inside applyFiltersAndRenderWoodens()
function applyFiltersAndRenderWoodens() {
    // Get values as strings from dropdowns
    const selectedCategoryId = $('#categories-select').val();
    const selectedTypeId = $('#types-select').val();
    const selectedModelId = $('#models-select').val();

    console.group("--- APPLYING FILTERS ---");
    console.log("Selected Filter Values (from dropdowns):");
    console.log("  Category:", selectedCategoryId, " (Type:", typeof selectedCategoryId, ")");
    console.log("  Type:", selectedTypeId, " (Type:", typeof selectedTypeId, ")");
    console.log("  Model:", selectedModelId, " (Type:", typeof selectedModelId, ")");
    console.log("Total All Wooden Data items:", allWoodenData.length);

    filteredWoodenData = allWoodenData.filter(item => {
        let matches = true;

        // NEW: Get the actual ID from the nested object, handling potential null/undefined
        const itemMaterialGrpId = item.material_grp ? String(item.material_grp.id) : null;
        const itemMaterialTypeId = item.material_type ? String(item.material_type.id) : null;
        const itemMaterialModelId = item.material_model ? String(item.material_model.id) : null;


        console.log(`  Evaluating item ID: ${item.id} - Name: ${item.name}`);
        console.log(`    Item material_grp.id: ${itemMaterialGrpId} (Type: ${typeof itemMaterialGrpId})`);
        console.log(`    Item material_type.id: ${itemMaterialTypeId} (Type: ${typeof itemMaterialTypeId})`);
        console.log(`    Item material_model.id: ${itemMaterialModelId} (Type: ${typeof itemMaterialModelId})`);

        // Compare the string version of the selected ID with the item's nested object ID
        // Note: selectedCategoryId/TypeId/ModelId are already strings from .val()
        if (selectedCategoryId && itemMaterialGrpId !== selectedCategoryId) {
            matches = false;
            console.log(`    Category Mismatch: ${itemMaterialGrpId} (string) !== ${selectedCategoryId} (string)`);
        }
        if (selectedTypeId && itemMaterialTypeId !== selectedTypeId) {
            matches = false;
            console.log(`    Type Mismatch: ${itemMaterialTypeId} (string) !== ${selectedTypeId} (string)`);
        }
        if (selectedModelId && itemMaterialModelId !== selectedModelId) {
            matches = false;
            console.log(`    Model Mismatch: ${itemMaterialModelId} (string) !== ${selectedModelId} (string)`);
        }
        console.log(`    Result for item ${item.id}: ${matches ? 'MATCH' : 'NO MATCH'}`);
        return matches;
    });

    console.log("Filtered wooden data count:", filteredWoodenData.length);
    console.groupEnd();

    currentPage = 1;
    renderWoodensPage(currentPage);

    const $addWoodenContainer = $('#add-wooden-container');
    $addWoodenContainer.empty();
    if (selectedModelId && selectedModelId !== '') {
        $addWoodenContainer.append(`
            <button class="btn btn-primary" id="add-wooden-btn">
                + Add Wooden
            </button>
        `);
    }
}

$('#woodenTab button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
    const targetTabId = $(e.target).attr('data-bs-target'); // e.g. #basic-details or #pricing-other

    if (targetTabId === '#pricing-other') {
        $('.modal-footer').show(); // Show footer only in Pricing tab
    } else {
        $('.modal-footer').hide(); // Hide it on Basic Details
    }
});
function openEntityModal(type, id = '', name = '') {
    $('#entity-type').val(type);
    $('#entity-id').val(id);
    $('#entity-name').val(name);
    $('#entityModalLabel').text(id ? `Edit ${capitalize(type)}` : `Add ${capitalize(type)}`);
    const modal = new bootstrap.Modal(document.getElementById('entityModal'));
    modal.show();
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function saveEntity(type, id, name) {
    const method = id ? 'PUT' : 'POST';
    let url = '';
    const data = { name };

    if (type === 'category') {
        url = id ? `${categoriesApi}${id}/` : categoriesApi;
    } else if (type === 'type') {
        const categoryId = $('#categories-select').val();
        if (!categoryId || categoryId === '') return showAlert('Category is required to add or edit a type.');
        data.category_id = categoryId;
        url = id ? `${typesApi}${id}/` : typesApi;
    } else if (type === 'model') {
        const typeId = $('#types-select').val();
        if (!typeId || typeId === '') return showAlert('Type is required to add or edit a model.');
        data.model_category_id = typeId;
        url = id ? `${modelsApi}${id}/` : modelsApi;
    }

    $.ajax({
        url,
        method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: () => {
            $('#entityModal').modal('hide');
            showAlert(`${capitalize(type)} saved successfully.`);
            // Reload all relevant data
            loadCategories(); // This will trigger cascade loading and filtering
            loadAllWoodensAndFilter(); // Ensure all woodens are refreshed
        },
        error: (xhr) => {
             console.error(`Failed to save ${type}:`, xhr.responseJSON);
             showAlert(`Failed to save ${type}. Error: ${xhr.responseJSON ? JSON.stringify(xhr.responseJSON) : xhr.statusText}`);
        }
    });
}

function deleteEntity(type, id) {
    if (!confirm(`Are you sure you want to delete this ${type}? This will also delete all associated types, models, and wooden materials.`)) return;

    const apiMap = {
        category: categoriesApi,
        type: typesApi,
        model: modelsApi
    };

    $.ajax({
        url: `${apiMap[type]}${id}/`,
        method: 'DELETE',
        success: () => {
            showAlert(`${capitalize(type)} deleted successfully.`);
            // Reload all relevant data
            loadCategories(); // This will trigger cascade loading and filtering
            loadAllWoodensAndFilter(); // Ensure all woodens are refreshed
        },
        error: (xhr) => {
            console.error(`Failed to delete ${type}:`, xhr.responseJSON);
            showAlert(`Failed to delete ${type}. Error: ${xhr.responseJSON ? JSON.stringify(xhr.responseJSON) : xhr.statusText}`);
        }
    });
}

$(function () {
    setupEnableDisable('categories-select', 'edit-category-btn', 'delete-category-btn');
    setupEnableDisable('types-select', 'edit-type-btn', 'delete-type-btn');
    setupEnableDisable('models-select', 'edit-model-btn', 'delete-model-btn');

    loadCategories(); // Initial load, which will trigger applyFiltersAndRenderWoodens
    loadBrands();
    loadEdgebands();
    loadAllWoodensAndFilter(); // Load all wooden materials initially

    $('#categories-select').on('change', function () {
        const categoryId = $(this).val();
        loadTypes(categoryId); // This will subsequently call applyFiltersAndRenderWoodens()
    });

    $('#types-select').on('change', function () {
        const typeId = $(this).val();
        loadModels(typeId); // This will subsequently call applyFiltersAndRenderWoodens()
    });

    $('#models-select').on('change', function () {
        applyFiltersAndRenderWoodens(); // Directly call filter when model changes
    });

    $(document).on('click', '#add-wooden-btn', function () {
      console.log("'+ Add Wooden' button clicked!");
        const selectedModelId = $('#models-select').val();
        if (!selectedModelId || selectedModelId === '') {
            showAlert('Please select a specific Model to add a Wooden Material.');
            return;
        }

        $('#wooden-id').val('');
        $('#wooden-form')[0].reset();
        $('#woodenModalLabel').text('Add Wooden');
        loadBrands();
        loadEdgebands();

        $('#wooden-brand').val(null).trigger('change');
        $('#wooden-compatible-edgebands').val(null).trigger('change');
// Set the hidden fields from the currently selected dropdowns for the payload
    const catVal = $('#categories-select').val(); // <--- Capture values first
    const typeVal = $('#types-select').val();
    const modelVal = $('#models-select').val();

    console.log("Values from dropdowns BEFORE assigning to hidden fields:"); // <--- ADD THIS
    console.log("  Category dropdown val:", catVal);
    console.log("  Type dropdown val:", typeVal);
    console.log("  Model dropdown val:", modelVal);

        // Set the hidden fields from the currently selected dropdowns for the payload
      $('#wooden-category-hidden').val(catVal); // <--- Assign
    $('#wooden-type-hidden').val(typeVal);
    $('#wooden-model-hidden').val(modelVal);

        const modal = new bootstrap.Modal(document.getElementById('woodenModal'));
        modal.show();
    });

    let saveAndAddAnother = false;
    $('#save-add-another-btn').on('click', function () {
        saveAndAddAnother = true;
        $('#wooden-form').submit();
    });

    $('#wooden-form').on('submit', function (e) {
        e.preventDefault();

        const woodenId = $('#wooden-id').val();
        // Check for required fields more robustly
        if (!$('#wooden-name').val().trim() || !$('#wooden-brand').val() || !$('#wooden-length').val() || !$('#wooden-width').val() || !$('#wooden-thickness').val() || !$('#wooden-cost-price').val() || !$('#wooden-sell-price').val()) {
            showAlert('Please fill in all required fields (Name, Brand, Length, Width, Thickness, Cost Price, Sell Price).');
            return;
        }
const materialGrpId = $('#wooden-category-hidden').val();
const materialTypeId = $('#wooden-type-hidden').val();
const materialModelId = $('#wooden-model-hidden').val(); // Make sure this is also included
const primaryEdgebandId = $('#wooden-primary-edgeband').val() || null;

// Add console logs here to double-check the values right before sending
console.log("Payload values for wooden material submission:");
console.log("  material_grp:", materialGrpId);
console.log("  material_type:", materialTypeId);
console.log("  material_model:", materialModelId); // Check this one too!
        const payload = {
            material_grp_id: materialGrpId,
            material_type_id: materialTypeId,
            material_model_id: materialModelId,
            brand_id: $('#wooden-brand').val(), 
            name: $('#wooden-name').val().trim(),
            grain: $('#wooden-grain').val(),
            length: parseFloat($('#wooden-length').val()),
            length_unit: $('#wooden-length-unit').val(),
            width: parseFloat($('#wooden-width').val()),
            width_unit: $('#wooden-width-unit').val(),
            thickness: parseFloat($('#wooden-thickness').val()),
            thickness_unit: $('#wooden-thickness-unit').val(),
            compatible_edgebands_ids: $('#wooden-compatible-edgebands').val() || [],
            primary_edgeband: primaryEdgebandId,
            cost_price: parseFloat($('#wooden-cost-price').val()),
            costprice_type: $('#wooden-costprice-type').val(),
            sell_price: parseFloat($('#wooden-sell-price').val()),
            sellprice_type: $('#wooden-sellprice-type').val(),
            color: $('#wooden-color').val() || 'no color',
        };
            console.log("Final payload to be sent:");
            console.log(JSON.stringify(payload, null, 2));
        const method = woodenId ? 'PUT' : 'POST';
        const url = woodenId ? `${woodenApi}${woodenId}/` : woodenApi;

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function () {
                showAlert('Wooden saved successfully!');
                loadAllWoodensAndFilter(); // Re-fetch all and re-apply filters
                if (saveAndAddAnother) {
                    $('#wooden-form')[0].reset();
                    $('#wooden-id').val('');
                    $('#wooden-brand').val(null).trigger('change');
                    $('#wooden-compatible-edgebands').val(null).trigger('change');
                } else {
                    $('#woodenModal').modal('hide');
                }
                saveAndAddAnother = false;
            },
            error: function (xhr) {
                console.error('Error saving wooden:', xhr.responseJSON);
                showAlert('Failed to save wooden. ' + (xhr.responseJSON ? JSON.stringify(xhr.responseJSON) : xhr.statusText));
                saveAndAddAnother = false;
            }
        });
    });

    $(document).on('click', '.edit-wooden-btn', function (e) {
        e.stopPropagation();
        const id = $(this).data('id');
        const item = allWoodenData.find(w => w.id === id);
        if (!item) {
            showAlert('Wooden item not found for editing.');
            return;
        }
        $('#wooden-brand').val(item.brand?.id).trigger('change');
        $('#wooden-material-grp').val(item.material_grp?.id).trigger('change');
        $('#wooden-material-type').val(item.material_type?.id).trigger('change');
        $('#wooden-material-model').val(item.material_model?.id).trigger('change');
        $('#wooden-compatible-edgebands').val(item.compatible_edgebands?.map(e => e.id)).trigger('change');
        $('#wooden-id').val(item.id);
        $('#wooden-name').val(item.name);
        $('#wooden-thickness').val(item.thickness);
        $('#wooden-color').val(item.color || 'no color');
        $('#wooden-grain').val(item.grain);
        $('#wooden-length').val(item.length);
        $('#wooden-length-unit').val(item.length_unit);
        $('#wooden-width').val(item.width);
        $('#wooden-width-unit').val(item.width_unit);
        $('#wooden-thickness-unit').val(item.thickness_unit);
        $('#wooden-cost-price').val(item.cost_price);
        $('#wooden-costprice-type').val(item.costprice_type);
        $('#wooden-sell-price').val(item.sell_price);
        $('#wooden-sellprice-type').val(item.sellprice_type);

        
        
        const brandIdToSet = item.brand && typeof item.brand === 'object' ? item.brand.id : item.brand;
        $('#wooden-brand').val(brandIdToSet).trigger('change');
        $('#wooden-compatible-edgebands').val(item.compatible_edgebands || []).trigger('change');
        $('#wooden-primary-edgeband').val(item.primary_edgeband?.id).trigger('change');
        $('#wooden-category-hidden').val(item.material_grp?.id || item.material_grp);
        $('#wooden-type-hidden').val(item.material_type?.id || item.material_type);
        $('#wooden-model-hidden').val(item.material_model?.id || item.material_model);

        $('#woodenModalLabel').text('Edit Wooden');
        const modal = new bootstrap.Modal(document.getElementById('woodenModal'));
        modal.show();
    });

    $(document).on('click', '.delete-wooden-btn', function (e) {
        e.stopPropagation();
        const id = $(this).data('id');
        const item = allWoodenData.find(w => w.id === id);
        if (!item) {
            showAlert('Wooden item not found for deletion.');
            return;
        }

        if (confirm(`Are you sure you want to delete "${item.name}"?`)) {
            $.ajax({
                url: `${woodenApi}${item.id}/`,
                method: 'DELETE',
                success() {
                    showAlert('Wooden item deleted successfully.');
                    loadAllWoodensAndFilter();
                },
                error(xhr) {
                    console.error('Error deleting wooden item:', xhr.responseJSON);
                    showAlert('Failed to delete wooden item. ' + (xhr.responseJSON ? JSON.stringify(xhr.responseJSON) : xhr.statusText));
                }
            });
        }
    });

    $('#entity-form').on('submit', function (e) {
        e.preventDefault();
        const id = $('#entity-id').val();
        const type = $('#entity-type').val();
        const name = $('#entity-name').val().trim();
        if (!name) {
            showAlert('Name is required.');
            return;
        }
        if (type === 'type') {
            const categoryId = $('#categories-select').val();
            if (!categoryId || categoryId === '') {
                showAlert('Please select a specific category to add or edit a type.');
                return;
            }
            saveEntity('type', id, name);
        } else if (type === 'model') {
            const typeId = $('#types-select').val();
            if (!typeId || typeId === '') {
                showAlert('Please select a specific type to add or edit a model.');
                return;
            }
            saveEntity('model', id, name);
        } else {
            saveEntity('category', id, name);
        }
    });

    $('#add-category-btn').on('click', () => openEntityModal('category'));
    $('#edit-category-btn').on('click', () => {
        const id = $('#categories-select').val();
        const name = $('#categories-select option:selected').text();
        if (!id || name === 'All Categories') { showAlert('Select a specific category to edit'); return; }
        openEntityModal('category', id, name);
    });
    $('#delete-category-btn').on('click', () => {
        const id = $('#categories-select').val();
        if (!id || id === '') { showAlert('Select a specific category to delete'); return; }
        deleteEntity('category', id);
    });

    $('#add-type-btn').on('click', () => {
        const categoryId = $('#categories-select').val();
        if (!categoryId || categoryId === '') { showAlert('Please select a specific category first to add a Type.'); return; }
        openEntityModal('type');
    });
    $('#edit-type-btn').on('click', () => {
        const id = $('#types-select').val();
        const name = $('#types-select option:selected').text();
        if (!id || name === 'All Types') { showAlert('Select a specific type to edit'); return; }
        openEntityModal('type', id, name);
    });
    $('#delete-type-btn').on('click', () => {
        const id = $('#types-select').val();
        if (!id || id === '') { showAlert('Select a specific type to delete'); return; }
        deleteEntity('type', id);
    });

    $('#add-model-btn').on('click', () => {
        const typeId = $('#types-select').val();
        if (!typeId || typeId === '') { showAlert('Please select a specific type first to add a Model.'); return; }
        openEntityModal('model');
    });
    $('#edit-model-btn').on('click', () => {
        const id = $('#models-select').val();
        const name = $('#models-select option:selected').text();
        if (!id || name === 'All Models') { showAlert('Select a specific model to edit'); return; }
        openEntityModal('model', id, name);
    });
    $('#delete-model-btn').on('click', () => {
        const id = $('#models-select').val();
        if (!id || id === '') { showAlert('Select a specific model to delete'); return; }
        deleteEntity('model', id);
    });

    $(document).on('click', '#wooden-pagination a.page-link', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('page'));
        if (!isNaN(page) && !$(this).parent().hasClass('disabled')) {
            currentPage = page;
            renderWoodensPage(currentPage);
        }
    });
});
</script>
{%endblock%}