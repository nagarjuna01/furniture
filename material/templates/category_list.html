<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <!-- Sidebar (Category Filter Selection) -->
            <div class="col-md-3">
                <div class="list-group">
                    <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addCategoryModal">Add Category</button>
                    <h5>Filter by Select:</h5>
                    <ul id="filter-list" class="list-unstyled">
                        <!-- Filter options will be dynamically rendered here -->
                    </ul>
                    <!-- Add Category Button -->
                    
                </div>
            </div>

            <!-- Main Content Area (Category List) -->
            <div class="col-md-9">
                <h4 class="mb-4">Categories</h4>
                <div id="category-list" class="row">
                    <!-- Categories will be dynamically rendered here -->
                    
                    <nav aria-label="Page navigation example">
                        <ul id="pagination-controls" class="pagination justify-content-center">
                            <!-- Pagination buttons will be dynamically rendered here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="add-category-form">
                        <div class="form-group">
                            <label for="newCategoryName">Category Name</label>
                            <input type="text" class="form-control" id="newCategoryName" required>
                        </div>
                        <div class="form-group">
                            <label for="newCategoryType">Category Type</label>
                            <select class="form-control" id="newCategoryType" required>
                                <option value="Panel">Panel</option>
                                <option value="Metal">Metal</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal" id="editCategoryModal" tabindex="-1" role="dialog" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-category-form">
                        <div class="form-group">
                            <label for="categoryName">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="form-group">
                            <label for="categoryType">Category Type</label>
                            <input type="text" class="form-control" id="categoryType" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteCategoryModal" tabindex="-1" role="dialog" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCategoryModalLabel">Delete Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this category?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script>

        
        // API URL
        const apiUrl = '/material/categories/';

        $(document).ready(function() {
            // Fetch categories and dynamically render the filter options on page load
            $.ajax({
                url: apiUrl,
                method: 'GET',
                success: function(response) {
                    // Get unique 'select' options from categories to create filters
                    const selectOptions = [...new Set(response.map(category => category.select))];
                    renderFilterOptions(selectOptions);  // Render filter options dynamically
                    fetchCategories();  // Load all categories initially
                },
                error: function() {
                    alert('Error fetching categories.');
                }
            });

            // Handle Edit button click - Fetch and display category details in modal
            $('#category-list').on('click', '.edit-category-btn', function() {
                const categoryId = $(this).data('id');

                // Fetch category details for editing
                $.ajax({
                    url: `${apiUrl}${categoryId}/`,
                    method: 'GET',
                    success: function(category) {
                        // Populate modal with category details for editing
                        $('#categoryName').val(category.name);
                        $('#categoryType').val(category.select);
                        $('#editCategoryModal').data('categoryId', category.id).modal('show');
                    },
                    error: function() {
                        alert('Error fetching category details.');
                    }
                });
            });

            // Handle Save changes (Edit category)
            $('#edit-category-form').on('submit', function(event) {
                event.preventDefault();

                const categoryId = $('#editCategoryModal').data('categoryId');
                const categoryName = $('#categoryName').val();
                const categoryType = $('#categoryType').val();

                $.ajax({
                    url: `${apiUrl}${categoryId}/`,
                    method: 'PUT',
                    data: { name: categoryName, select: categoryType },
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function() {
                        $('#editCategoryModal').modal('hide');
                        fetchCategories();  // Reload categories after editing
                    },
                    error: function() {
                        alert('Error updating category.');
                    }
                });
            });

            // Handle Delete button click - Show confirmation modal
            $('#category-list').on('click', '.delete-category-btn', function() {
                const categoryId = $(this).data('id');
                $('#deleteCategoryModal').data('categoryId', categoryId).modal('show');
            });

            // Handle Delete confirmation
            $('#confirmDeleteBtn').on('click', function() {
                const categoryId = $('#deleteCategoryModal').data('categoryId');

                $.ajax({
                    url: `${apiUrl}${categoryId}/`,
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function() {
                        alert('Category deleted successfully');
                        fetchCategories();  // Reload categories after deletion
                    },
                    error: function() {
                        alert('Error deleting category.');
                    }
                });
            });

            // Handle Add Category form submission
            $('#add-category-form').on('submit', function(event) {
                event.preventDefault();

                const newCategoryName = $('#newCategoryName').val();
                const newCategoryType = $('#newCategoryType').val();

                $.ajax({
                    url: apiUrl,
                    method: 'POST',
                    data: { name: newCategoryName, select: newCategoryType },
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function() {
                        $('#addCategoryModal').modal('hide');
                        fetchCategories();  // Reload categories after adding
                        updateFilterOptions();  // Update filter options
                    },
                    error: function() {
                        alert('Error adding category.');
                    }
                });
            });
        });

        // Utility function to fetch categories and render them dynamically
        function fetchCategories(selectFilter = '') {
            const filter = (selectFilter === 'all') ? '' : selectFilter;

            $.ajax({
                url: apiUrl,
                method: 'GET',
                data: { select: filter },
                success: function(response) {
                    renderCategories(response);
                },
                error: function() {
                    alert('Error fetching categories.');
                }
            });
        }

        // Render the categories list dynamically
        function renderCategories(categories) {
            const categoryListContainer = $('#category-list');
            categoryListContainer.empty();

            if (categories.length > 0) {
                categories.forEach(category => {
                    categoryListContainer.append(`
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">${category.name}</h5>
                                    <p class="card-text"><strong>Type:</strong> ${category.select}</p>
                                    
                                    <a href="#" class="btn btn-warning edit-category-btn" data-id="${category.id}">Edit</a>
                                    <a href="#" class="btn btn-danger delete-category-btn" data-id="${category.id}">Delete</a>
                                </div>
                            </div>
                        </div>
                    `);
                });
            } else {
                categoryListContainer.append('<p>No categories found for this filter.</p>');
            }
        }

        // Render filter options dynamically
        function renderFilterOptions(selectOptions) {
            const filterList = $('#filter-list');
            filterList.empty();

            filterList.append(`<li><a href="#" class="btn btn-link active" data-filter="all">All</a></li>`);

            selectOptions.forEach(option => {
                filterList.append(`<li><a href="#" class="btn btn-link" data-filter="${option}">${option}</a></li>`);
            });

            filterList.on('click', 'a', function(event) {
                event.preventDefault();
                const filter = $(this).data('filter');
                fetchCategories(filter);  // Fetch categories based on the selected filter
            });
        }

        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Update the filter options after adding a category
        function updateFilterOptions() {
            $.ajax({
                url: apiUrl,
                method: 'GET',
                success: function(response) {
                    const selectOptions = [...new Set(response.map(category => category.select))];
                    renderFilterOptions(selectOptions);
                },
                error: function() {
                    alert('Error fetching filter options.');
                }
            });
        }
    </script>
</body>
</html>
