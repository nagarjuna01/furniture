{% extends "base_b.html" %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">Brand Management</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#brandModal">
            <i class="fas fa-plus"></i> Add Brand
        </button>
    </div>

    <!-- Search Bar -->
    <div class="mb-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search brands..." oninput="fetchBrands()">
    </div>

    <!-- Brand Cards -->
    <div class="row" id="brandCards">
        <!-- AJAX will populate cards here -->
    </div>

    <!-- No Brands Placeholder -->
    <div id="noBrandsPlaceholder" class="text-center text-muted mt-5 d-none">
        <i class="fas fa-box-open fa-3x mb-2"></i>
        <p class="lead">No brands found. Click "Add Brand" to create one.</p>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="brandModalLabel">Create / Edit Brand</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="brandForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Brand Name</label>
                            <input type="text" class="form-control" id="brandName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Brand Description</label>
                            <textarea class="form-control" id="brandDescription" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="fas fa-save"></i> Save Brand
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    
    let currentBrandId = null;

    // Fetch brands and render SaaS-style cards
    window.fetchBrands = function() {
        const searchQuery = $('#searchInput').val();
        const url = searchQuery ? `/material/v1/brands/?search=${searchQuery}` : '/material/v1/brands/';

        $('#brandCards').html('<div class="text-center text-muted w-100 py-5">Loading brands...</div>');

        $.ajax({
            url: url,
            method: 'GET',
            success: function(data) {
                const brands = Array.isArray(data.results) ? data.results : data;
                const brandCards = $('#brandCards');
                brandCards.empty();

                if (brands.length === 0) {
                    $('#noBrandsPlaceholder').removeClass('d-none');
                    return;
                } else {
                    $('#noBrandsPlaceholder').addClass('d-none');
                }

                brands.forEach(brand => {
                    const card = `
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm h-100">
                            <div class="card-body d-flex flex-column justify-content-between">
                                <div>
                                    <h5 class="card-title fw-bold">${brand.name}</h5>
                                    <p class="card-text text-muted">${brand.description || ""}</p>
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editBrand(${brand.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteBrand(${brand.id})">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    brandCards.append(card);
                });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching brands:", textStatus, errorThrown);
                $('#brandCards').html('<div class="text-center text-danger py-5">Error loading brands. Please try again.</div>');
            }
        });
    }

    // Create/Update Brand
    $('#brandForm').on('submit', function(e) {
        e.preventDefault();

        const name = $('#brandName').val().trim();
        const description = $('#brandDescription').val().trim();
        const id = currentBrandId;

        if (!name) {
            showToast("Brand name is required.");
            return;
        }

        $.get('/material/v1/brands/', { search: name }, function(res) {
            const duplicate = res.results.find(b => b.name.toLowerCase() === name.toLowerCase() && b.id != id);
            if (duplicate) {
                showToast("Brand name already exists.","warning");
                return;
            }

            const method = id ? "PUT" : "POST";
            const url = id ? `/material/v1/brands/${id}/` : '/material/v1/brands/';
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify({ name, description }),
                headers: { "X-CSRFToken": window.CSRF_TOKEN },
                success: function() {
                    showToast("Brand Created","success")
                    fetchBrands();
                    resetForm();
                    bootstrap.Modal.getInstance(document.getElementById('brandModal')).hide();
                },
                error: function(jqXHR) {
                    showToast(jqXHR.responseJSON?.detail || "Failed to save brand.");
                }
            });
        });
    });

    // Edit Brand
    window.editBrand = function(id) {
        $.get(`/material/v1/brands/${id}/`, function(brand) {
            $('#brandName').val(brand.name);
            $('#brandDescription').val(brand.description);
            currentBrandId = brand.id;
            $('#submitBtn').html('<i class="fas fa-save"></i> Update Brand');
            new bootstrap.Modal(document.getElementById('brandModal')).show();
        });
    }

    // Delete Brand
    window.deleteBrand = function(id) {
        if (!confirm("Are you sure you want to delete this brand?")) return;
        $.ajax({
            url: `/material/v1/brands/${id}/`,
            method: 'DELETE',
            headers: { "X-CSRFToken": window.CSRF_TOKEN },
            success: function() {
                showToast("Brand deleted!");
                fetchBrands();
            }
        });
    }

    // Reset Form
    window.resetForm = function() {
        $('#brandForm')[0].reset();
        $('#submitBtn').html('<i class="fas fa-save"></i> Save Brand');
        currentBrandId = null;
    }

    // Reset when modal closes
    $('#brandModal').on('hidden.bs.modal', resetForm);

    

    // Initial load
    fetchBrands();
});
</script>
{% endblock %}
