<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Batch Add Metals</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .metal-entry {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f8f9fa;
      position: relative;
    }
    .remove-entry {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-100">
<div class="container mx-auto mt-5 p-4 bg-white rounded-lg shadow-md">
  <h2 class="text-2xl font-semibold text-center mb-6">Metals Form</h2>

  <!-- Shared Fields -->
  <div class="p-4 mb-4 bg-gray-50 border rounded-lg">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Material Group</label>
        <select class="form-select mt-1 block w-full" id="material_grp" required></select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Material Type</label>
        <select class="form-select mt-1 block w-full" id="material_type" required></select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Metal Shape</label>
        <select class="form-select mt-1 block w-full" id="metal_shape" required></select>
      </div>
    </div>
  </div>

  <!-- Metal Rows Container -->
  <form id="metalBatchForm" enctype="multipart/form-data">
    <div id="metalRowsContainer"></div>
    <div class="flex justify-between mt-6">
      <button type="button" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded" onclick="addMetalRow()">Add Metal</button>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">Submit All</button>
    </div>
  </form>
</div>

<script>
const UNIT_OPTIONS = [
  { id: 'mm', name: 'Millimeter' },
  { id: 'cm', name: 'Centimeter' },
  { id: 'm', name: 'Meter' },
  { id: 'in', name: 'Inch' },
  { id: 'ft', name: 'Foot' },
  { id: 'yd', name: 'Yard' }
];

const PRICE_UNIT_OPTIONS = [
  'EACH', 'PAIR', 'DOZEN', 'SET', 'BOX', 'BUNDLE',
  'm2', 'ft2', 'yd2', 'm3', 'ft3', 'l', 'gallon',
  'kg', 'lb', 'm2_price', 'm3_price', 'kg_price'
].map(unit => ({ id: unit, name: unit }));

let metalIndex = 0;

function createSelectOptions(options) {
  return options.map(opt => `<option value="${opt.id}">${opt.name}</option>`).join('');
}

async function loadOptions(url, selectId) {
  try {
    const response = await fetch(url);
    const data = await response.json();
    const options = data.results || [];
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = createSelectOptions(options);
    }
  } catch (err) {
    console.error(`Error loading ${selectId}:`, err);
  }
}

async function loadBrandOptions(selectElement) {
  try {
    const response = await fetch('http://127.0.0.1:8000/material/brands/');
    const data = await response.json();
    const options = data.results || [];
    selectElement.innerHTML = createSelectOptions(options);
  } catch (err) {
    console.error('Error loading brands:', err);
  }
}

function addMetalRow() {
  const container = document.getElementById('metalRowsContainer');
  const div = document.createElement('div');
  div.className = 'metal-entry';
  div.dataset.index = metalIndex;

  div.innerHTML = `
    <span class="remove-entry" onclick="removeMetalRow(this)">×</span>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" class="form-input mt-1 block w-full" name="name_${metalIndex}" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Section</label>
        <select class="form-select mt-1 block w-full" name="section_${metalIndex}">
          <option value="DESKING">DESKING</option>
          <option value="PARTITION">PARTITION</option>
          <option value="COMBO">COMBO</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Brand</label>
        <select class="form-select mt-1 block w-full" name="metal_brand_${metalIndex}"></select>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Length</label>
        <input type="number" class="form-input mt-1 block w-full" name="length_${metalIndex}">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Width</label>
        <input type="number" class="form-input mt-1 block w-full" name="width_${metalIndex}">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Height</label>
        <input type="number" class="form-input mt-1 block w-full" name="height_${metalIndex}">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Dimension Unit</label>
        <select class="form-select mt-1 block w-full" name="dunit_${metalIndex}">
          ${createSelectOptions(UNIT_OPTIONS)}
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Price Unit</label>
        <select class="form-select mt-1 block w-full" name="p_unit_${metalIndex}">
          ${createSelectOptions(PRICE_UNIT_OPTIONS)}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Primary Price</label>
        <input type="number" step="0.01" class="form-input mt-1 block w-full" name="p_price_${metalIndex}" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Selling Price</label>
        <input type="number" step="0.01" class="form-input mt-1 block w-full" name="s_price_${metalIndex}" required>
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Image</label>
      <input type="file" class="form-input mt-1 block w-full" name="image_${metalIndex}">
    </div>
  `;

  container.appendChild(div);

  // Load brand options for this row
  const brandSelect = div.querySelector(`select[name="metal_brand_${metalIndex}"]`);
  loadBrandOptions(brandSelect);

  metalIndex++;
}

function removeMetalRow(button) {
  button.closest('.metal-entry').remove();
}

loadOptions('http://127.0.0.1:8000/material/categories/', 'material_grp');
loadOptions('http://127.0.0.1:8000/material/categorytypes/', 'material_type');
loadOptions('http://127.0.0.1:8000/material/category-models/', 'metal_shape');

document.getElementById('metalBatchForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const shared = {
    material_grp: document.getElementById('material_grp').value,
    material_type: document.getElementById('material_type').value,
    metal_shape: document.getElementById('metal_shape').value
  };

  const entries = document.querySelectorAll('.metal-entry');
  let successCount = 0, failCount = 0;

  for (let entry of entries) {
    const index = entry.dataset.index;
    const formData = new FormData();

    formData.append('material_grp', shared.material_grp);
    formData.append('material_type', shared.material_type);
    formData.append('metal_shape', shared.metal_shape);

    formData.append('name', entry.querySelector(`[name="name_${index}"]`).value.toUpperCase());
    formData.append('metal_brand', entry.querySelector(`[name="metal_brand_${index}"]`).value);
    formData.append('section', entry.querySelector(`[name="section_${index}"]`).value);
    formData.append('length', entry.querySelector(`[name="length_${index}"]`).value || '');
    formData.append('width', entry.querySelector(`[name="width_${index}"]`).value || '');
    formData.append('height', entry.querySelector(`[name="height_${index}"]`).value || '');
    formData.append('dunit', entry.querySelector(`[name="dunit_${index}"]`).value);
    formData.append('p_unit', entry.querySelector(`[name="p_unit_${index}"]`).value);
    formData.append('p_price', entry.querySelector(`[name="p_price_${index}"]`).value || '0');
    formData.append('s_price', entry.querySelector(`[name="s_price_${index}"]`).value || '0');

    const imageInput = entry.querySelector(`[name="image_${index}"]`);
    if (imageInput.files.length > 0) {
      formData.append('image', imageInput.files[0]);
    }

    try {
      const res = await fetch('http://127.0.0.1:8000/material/metals/', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        successCount++;
      } else {
        const err = await res.json();
        console.error(`Row ${index} failed:`, err);
        failCount++;
      }
    } catch (err) {
      console.error(`Row ${index} failed:`, err);
      failCount++;
    }
  }

  alert(`✅ ${successCount} submitted.\n❌ ${failCount} failed.`);

  if (failCount === 0) {
    document.getElementById('metalBatchForm').reset();
    document.getElementById('metalRowsContainer').innerHTML = '';
    metalIndex = 0;
  }
});
</script>
</body>
</html>
