{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'CSS/autocomplete.css' %}">

<style>
    .sticky-top { position: sticky; top: 0; z-index: 1020; background: white; }
    .table-responsive { position: relative; }
    .font-monospace { font-family: 'Courier New', Courier, monospace; }
</style>

<div class="container my-3" style="max-width: 1200px;">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h3 class="fw-bold" id="editor-title">Add Modular Product</h3>
    <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-secondary" onclick="window.location.href='/modularcalc/mproduct/'">â¬… Back</button>
        
        <button class="btn btn-info" id="save-draft-btn" onclick="DraftManager.save()">
    ðŸ’¾ Save Draft
</button>

<button class="btn btn-warning" id="load-draft-btn" 
        onclick="DraftManager.renderManagerTable()" 
        data-bs-toggle="modal" 
        data-bs-target="#draftManagerModal">
    ðŸ“„ Manage Library
</button>
        
        <button id="submit-product-btn" class="btn btn-success" onclick="window.submitProduct()">
            <i class="bi bi-cloud-arrow-up"></i> âœ… Submit Product
        </button>
    </div>
</div>

    <div class="accordion" id="productEditorAccordion">

        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingProductInfo">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProductInfo">
                    Product Info
                </button>
            </h2>
            <div id="collapseProductInfo" class="accordion-collapse collapse show">
                <div class="accordion-body row gx-2 gy-2">
                    <div class="col-md-3"><label class="small fw-bold">Category</label><select id="categoryselect" class="form-select form-select-sm"></select></div>
                    <div class="col-md-3"><label class="small fw-bold">Type</label><select id="type-select" class="form-select form-select-sm" disabled></select></div>
                    <div class="col-md-3"><label class="small fw-bold">Model</label><select id="model-select" class="form-select form-select-sm" disabled></select></div>
                    <div class="col-md-3"><label class="small fw-bold">Name</label><input id="product-name" class="form-control form-control-sm" placeholder="Product Name"></div>
                    <div class="col-md-9 mt-2">
        <label class="small fw-bold text-primary">Global Validation Expression</label>
        <textarea id="validation-expr" class="form-control font-monospace" rows="2" placeholder="e.g. product_width > 300 and product_height < 2400"></textarea>
    </div>
    <div class="col-md-3 mt-2 d-flex align-items-end">
        <div class="form-check form-switch mb-2">
            <label class="form-check-label small fw-bold" for="is-public-check">Publish in Marketplace</label>
            <input class="form-check-input" type="checkbox" id="is-public-check">
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingParameters">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseParameters">
                    Parameters
                </button>
            </h2>
            <div id="collapseParameters" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <table class="table table-sm table-bordered mb-1">
                        <thead class="table-light">
                            <tr class="small">
        <th>Name</th>
        <th>Abbr</th>
        <th>Default</th>
        <th>Description</th>
        <th >Action</th> </tr>
                        </thead>
                        <tbody id="parameter-body"></tbody>
                        <tfoot>
                            <tr>
                                <td><input id="param-name" class="form-control form-control-sm" placeholder="Height"></td>
                                <td><input id="param-abbr" class="form-control form-control-sm" placeholder="H"></td>
                                <td><input id="param-default" class="form-control form-control-sm" type="number" placeholder="720"></td>
                                <td><input id="param-desc" class="form-control form-control-sm" placeholder="Cabinet Height"></td>
                                <td><button class="btn btn-sm btn-success" id="save-param-btn">âœ“</button></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="accordion-item mb-2">
    <h2 class="accordion-header" id="headingParts">
        <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseParts">
            Part Templates (<span id="part-count">0</span>)
        </button>
    </h2>
    <div id="collapseParts" class="accordion-collapse collapse">
        <div class="accordion-body">
            <div class="input-group input-group-sm mb-3" style="max-width: 500px;">
                <span class="input-group-text bg-primary text-white">New Part</span>
                <input id="part-name" class="form-control" placeholder="Enter Part Name (e.g., Side Panel)">
                <button id="open-part-template-btn" class="btn btn-primary" >
                    <i class="bi bi-plus-lg"></i> Configure Details
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-hover table-bordered mt-2 align-middle">
                    <thead class="table-light">
                        <tr class="small text-uppercase" style="font-size: 0.75rem;">
                            <th>Part Name</th>
                            <th>Geometry (LÃ—W)</th>
                            <th>Material Whitelist</th>
                            <th>Edgebands</th>
                            <th>Hardware</th>
                            <th class="text-center" style="width:120px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="part-templates-body">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3 italic">
                                No parts added yet. Enter a name above to start.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingProductHardware">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProductHardware">
                    Product Hardware <span id="prod-hw-badge" class="badge bg-primary ms-2 d-none">0</span>
                </button>
            </h2>
            <div id="collapseProductHardware" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="prod-hw-search" class="form-control" placeholder="Search Hardware..." oninput="renderProductHardwareTable()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select id="prod-hw-filter-group" class="form-select form-select-sm" onchange="renderProductHardwareTable()">
                                <option value="">All Hardware Groups</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive" style="max-height: 400px; border: 1px solid #dee2e6; border-radius: 4px;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr class="small text-uppercase">
                                    <th style="width: 45px" class="text-center">Sel</th>
                                    <th>Hardware Description</th>
                                    <th style="width: 180px">Qty Expression</th>
                                    <th style="width: 200px">Condition</th>
                                </tr>
                            </thead>
                            <tbody id="product-hardware-body">
                                </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-2 px-1">
                        <small class="text-muted" id="prod-hw-count">0 items selected</small>
                        <button class="btn btn-link btn-sm text-decoration-none text-danger" onclick="clearProductHardware()">Clear All Selections</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingAssets">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAssets">
                    Assets (SVG & 3D)
                </button>
            </h2>
            <div id="collapseAssets" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div class="mb-2">
                        <label class="small fw-bold">2D SVG Template</label>
                        <textarea id="two-d-svg-input" class="form-control font-monospace" rows="3" placeholder="Paste SVG code here..."></textarea>
                    </div>
                    <div>
                        <label class="small fw-bold">3D Model Path / GLB URL</label>
                        <input id="three-d-asset-input" class="form-control form-control-sm" placeholder="/media/models/cabinet.glb">
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingSummary">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary">
                    Production Summary
                </button>
            </h2>
            <div id="collapseSummary" class="accordion-collapse collapse">
                <div class="accordion-body bg-light">
                    <div class="row g-3"> <div class="col-md-6">
                            <h6>Hardware Summary</h6>
                            <div id="product-hardware-summary" class="bg-white border p-2 rounded small"></div>
                            <div id="hardware-summary-list" class="mt-3"></div>
                        </div>

                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                                    <h6 class="mb-0 px-2"><i class="bi bi-cpu-fill me-2"></i>Global Engine Summary</h6>
                                    <button class="btn btn-sm btn-success fw-bold" onclick="runProductionDryRun()">
                                        <i class="bi bi-play-circle-fill me-1"></i> RUN PREVIEW
                                    </button>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="p-3 bg-white border rounded mb-3 shadow-sm">
                                        <p class="x-small text-uppercase fw-bold text-muted mb-2">Test Dimensions (mm)</p>
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light">L</span>
                                                    <input type="number" id="test-product-length" class="form-control" value="1000">
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light">W</span>
                                                    <input type="number" id="test-product-width" class="form-control" value="600">
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light">H</span>
                                                    <input type="number" id="test-product-height" class="form-control" value="800">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="cutlist-container" class="preview-scroll-area border rounded bg-white shadow-inner" style="min-height: 350px; overflow-y: auto;">
                                        <div class="text-center py-5">
                                            <div class="spinner-grow text-light mb-3" role="status"></div>
                                            <p class="text-muted small">Enter your equations and click <strong>Run Preview</strong> to simulate production.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> </div> </div> </div> </div> </div> </div> 

                        <div class="modal fade" id="draftManagerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Global Engine: Draft Library</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Product Identity</th>
                            <th>Complexity</th>
                            <th>Last Modified</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="draft-manager-list">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% include "modular_ui_b.html" %}

{% endblock %}



{% block extra_js %}
<script src="{% static 'JS/part_template_modal_copy.js' %}"></script>
<script src="{% static 'JS/parameters.js' %}"></script>
<script src ="{% static 'JS/expressionAutocomplete.js' %}"></script>
<script src ="{% static 'JS/expressionValidator.js' %}"></script>
<script src="{% static 'JS/mp_parts_productshardware.js' %}"></script>
<script src="{% static 'JS/reference_data.js' %}"></script>
<script src = "{% static 'JS/assests.js' %}"></script>
<script src = "{% static 'JS/product_submission.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('edit_id');

    if (productId) {
        console.log("Edit Mode Detected. Fetching ID:", productId);
        loadProductDataForEditing(productId);
    }
});

async function loadProductDataForEditing(productId) {
    try {
        const response = await fetch(`/modularcalc/api/products/${productId}/`);
        const data = await response.json();

        // 1. Populate Product Info
        document.getElementById('product-name').value = data.name;
        document.getElementById('validation-expr').value = data.product_validation_expression;
        document.getElementById('categoryselect').value = data.category;
        
        // 2. Hydrate Parameters (Assuming parameters.js has a render function)
        if (typeof renderParameters === 'function') {
            // If your parameters.js stores them in a global array:
            window.productParameters = data.parameters || [];
            renderParameters();
        }

        // 3. Hydrate Part Templates (mp_parts_productshardware.js)
        if (typeof renderPartTemplates === 'function') {
            window.partTemplates = data.part_templates || [];
            renderPartTemplates();
        }

        // 4. Update UI Title
        document.getElementById('editor-title').innerText = "Edit Modular Product: " + data.name;

    } catch (error) {
        console.error("Hydration Error:", error);
        showToast("Failed to load product details", "danger");
    }
}
</script>
{% endblock %}
