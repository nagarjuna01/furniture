<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Configurator (Architecture A - Nested)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api/a/products/';
        let productId = null; // Stored ID for update operations

        // Helper to get CSRF token from Django's cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const CSRF_TOKEN = getCookie('csrftoken');

        // --- CORE LOGIC: DATA MAPPING AND SINGLE SAVE (NESTED) ---

        function serializeFormToNestedJSON() {
            // Simplified serialization: collect data from form fields and arrays
            const data = {
                // 1. ModularProduct fields
                name: $('#product-name').val(),
                product_validation_expression: $('#validation-expr').val(),
                
                // 2. ProductParameter array (Simplified stub)
                parameters: [
                    { id: null, name: 'product_length', default_value: 1200 },
                    { id: null, name: 'product_width', default_value: 600 }
                ],
                
                // 3. PartTemplates array (The complex part)
                part_templates: [
                    // Example PartTemplate 1: 'Side Panel'
                    {
                        // id: 'a1b2c3d4-...', // Include ID if updating
                        name: 'Side Panel',
                        part_length_equation: 'product_height',
                        part_width_equation: 'product_depth',
                        part_qty_equation: '2',
                        part_thickness_mm: 18.0,
                        edgeband_top: 1, // PK of EdgeBand
                        edgeband_bottom: null, 
                        // Nested lists for PartTemplate
                        material_whitelist: [
                            { id: null, material: 1, is_default: true }, // PK of WoodEn
                            { id: null, material: 2, is_default: false }
                        ],
                        edgeband_whitelist: [
                            { id: null, edgeband: 1, is_default: true }
                        ],
                        hardware_rules: [
                            { id: null, hardware: 5, quantity_equation: '2' }
                        ]
                    }
                    // Add more part templates from a dynamic table here...
                ],
                
                // 4. Product Hardware Rules (Simplified stub)
                hardware_rules: [
                    { id: null, hardware: 10, quantity: 4 }
                ]
            };
            
            // In a real app, you would dynamically build these nested arrays 
            // by iterating over tables/repeater fields on the page.
            
            return JSON.stringify(data);
        }

        function handleSave() {
            const data = serializeFormToNestedJSON();
            const method = productId ? 'PUT' : 'POST';
            const url = productId ? `${API_BASE_URL}${productId}/` : API_BASE_URL;

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: data,
                headers: { 'X-CSRFToken': CSRF_TOKEN },
                success: function(response) {
                    productId = response.id;
                    alert(`Product ${response.name} saved successfully via Architecture A (${method}). New ID: ${productId}`);
                    // Optionally, update the UI with the saved data
                },
                error: function(xhr, status, error) {
                    console.error("Save Error:", xhr.responseText);
                    alert('Save failed. Check console for details.');
                }
            });
        }
        
        // --- UI Initialization ---
        $(document).ready(function() {
            $('#save-btn-a').on('click', handleSave);
            // Function to load material options would go here:
            // loadMaterialOptions(); 
        });

    </script>
</head>
<body>
    <div class="container my-5">
        <h1>Modular Product Configuration (Architecture A: Nested Save)</h1>
        <p class="text-muted">One API call saves all product details, parts, and rules.</p>

        <div class="card mb-3">
            <div class="card-header">Product Details</div>
            <div class="card-body">
                <input type="text" id="product-name" class="form-control mb-2" placeholder="Product Name (e.g., Base Unit)">
                <textarea id="validation-expr" class="form-control" placeholder="Validation Expression (e.g., '600 <= product_width <= 2400')"></textarea>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Part Templates (Simulated)</div>
            <div class="card-body">
                <p>This UI represents a complex nested form (Part Templates, Whitelists, Hardware Rules). Saving will send all data in one large JSON payload.</p>
                <div class="alert alert-info">
                    See the JavaScript code to review the simulated complex JSON payload being constructed for save.
                </div>
            </div>
        </div>
        
        <button id="save-btn-a" class="btn btn-primary btn-lg">Save All Config (Single API Call)</button>
    </div>
</body>
</html>