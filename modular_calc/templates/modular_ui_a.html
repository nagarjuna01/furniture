{% extends "base_b.html" %}
{% load static %}
{% block content %}

<div class="container my-3" style="max-width: 1200px;">

    <!-- ========= HEADER ========= -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h3 class="fw-bold" id="editor-title">Add Modular Product</h3>
        <button class="btn btn-secondary mt-2" onclick="window.location.href='/modularcalc/mproduct/'">
            ‚¨Ö Back to Products
        </button>
    </div>

    <!-- ========= PRODUCT INFO ========= -->
    <div class="border rounded p-2 mb-3 bg-light">
        <h5 class="fw-bold border-bottom pb-1 mb-2">Product Info</h5>

        <div class="row gx-2 gy-2">
            <div class="col-12 col-md-3">
                <label class="form-label">Category</label>
                <select id="categoryselect" class="form-select"></select>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label">Type</label>
                <select id="type-select" class="form-select" disabled></select>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label">Model</label>
                <select id="model-select" class="form-select" disabled></select>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label">Product Name</label>
                <input id="product-name" class="form-control" placeholder="Product name">
            </div>

            <div class="col-12">
                <label class="form-label">Validation Expression</label>
                <textarea id="validation-expr" class="form-control" rows="2" placeholder="Validation expression"></textarea>
            </div>
        </div>
    </div>

    <div class="row gx-2 gy-2">

        <!-- ========= LEFT COLUMN ========= -->
        <div class="col-12 col-md-3">

            <!-- PARAMETERS -->
            <div class="border rounded p-2 mb-2 bg-light">
                <h6 class="fw-bold mb-1">Parameters</h6>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-1" id="parameter-input-table">
                        <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Abbr</th>
                            <th>Default</th>
                            <th>Description</th>
                            <th style="width:35px"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><input id="param-name" class="form-control form-control-sm" placeholder="Name"></td>
                            <td><input id="param-abbr" class="form-control form-control-sm" placeholder="A"></td>
                            <td><input id="param-default" type="number" step="0.01" class="form-control form-control-sm" placeholder="0"></td>
                            <td><input id="param-desc" class="form-control form-control-sm" placeholder="Description"></td>
                            <td><button class="btn btn-sm btn-success" id="save-param-btn">‚úì</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-1" id="parameter-saved-table">
                        <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Abbr</th>
                            <th>Default</th>
                            <th>Description</th>
                            <th style="width:35px"></th>
                        </tr>
                        </thead>
                        <tbody id="parameter-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ASSETS -->
            <div class="border rounded p-2 bg-light mb-2">
                <h6 class="fw-bold pb-1">Assets</h6>

                <label class="form-label">2D SVG</label>
                <textarea id="two-d-svg-input" class="form-control mb-1" rows="2" placeholder="<svg>...</svg>"></textarea>

                <label class="form-label">3D Model Path</label>
                <input id="three-d-asset-input" class="form-control" placeholder="/static/models/example.glb">
            </div>
        </div>

        <!-- ========= MIDDLE COLUMN ========= -->
        <div class="col-12 col-md-6">

            <!-- PART TEMPLATES -->
            <div class="border rounded p-2 mb-2 bg-light">
                <h5 class="fw-bold mb-2">Part Templates</h5>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-1">
                        <thead class="table-light">
                        <tr>
                            <th>Part Name</th>
                            <th>Geometry</th>
                            <th>Materials</th>
                            <th>Edgebands</th>
                            <th>Hardware</th>
                            <th style="width:35px"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><input id="part-name" class="form-control form-control-sm" placeholder="Part Name"></td>
                            <td><button id="edit-geometry-btn" class="btn btn-sm btn-outline-secondary w-100">Edit</button></td>
                            <td><button id="select-material-btn" class="btn btn-sm btn-outline-warning w-100">Select</button></td>
                            <td><button id="set-edgebands-btn" class="btn btn-sm btn-outline-info w-100">Set</button></td>
                            <td><button id="rules-hardware-btn" class="btn btn-sm btn-outline-dark w-100">Rules</button></td>
                            <td><button id="save-part-btn" class="btn btn-sm btn-success">‚úì</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-1">
                        <thead class="table-light">
                        <tr>
                            <th>Part Name</th>
                            <th>Geometry</th>
                            <th>Materials</th>
                            <th>Edgebands</th>
                            <th>Hardware</th>
                            <th style="width:35px"></th>
                        </tr>
                        </thead>
                        <tbody id="part-templates-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========= RIGHT COLUMN ========= -->
        <div class="col-12 col-md-3">

            <!-- Summary -->
            <div class="border rounded p-2 mb-2 bg-light">
                <div class="d-flex justify-content-between mb-1">
                    <h6 class="fw-bold mb-0">Product Hardware</h6>
                    <button id="open-product-hardware-modal-btn" class="btn btn-sm btn-primary w-100 mb-1">
                        + Add
                    </button>
                </div>
                <div id="product-hardware-summary"></div>
            </div>

            <div class="border rounded p-2 mb-2 bg-light">
                <h6 class="fw-bold mb-1">Material Calculation</h6>
                <div id="material-calc-summary"></div>
            </div>

            <div class="border rounded p-2 mb-2 bg-light">
                <h6 class="fw-bold mb-1">CNC / Cutlist</h6>
                <div id="cutlist-container"></div>
            </div>

            <!-- Buttons -->
            <div class="border rounded p-2 bg-light">
                <h6 class="fw-bold mb-1">Quotation</h6>
                <button id="save-product-btn" class="btn btn-success w-100 mb-1">üíæ Save Product</button>
                <button id="open-quotation-modal-btn" class="btn btn-primary w-100">üìÑ Generate Quote</button>
            </div>
        </div>

    </div>

</div>

<!-- ===== MODALS (EDGEBAND, MATERIAL, HARDWARE, GEOMETRY, ETC.) ===== -->
{% include "modular_ui_b.html" %}

{% endblock %}


{% block extra_js %}


<script src="{% static 'JS/intitalfill.js' %}"></script>
<!-- <script src="{% static 'JS/dataloader.js' %}"></script> -->
<script src="{% static 'JS/geometry.js' %}"></script>
<script src="{% static 'JS/mproductmaterial.js' %}"></script>
<script src="{% static 'JS/mproductedgeband.js' %}"></script>
<script src="{% static 'JS/mp_parts_productshardware.js' %}"></script>
<script scr="{% static 'JS/reference_data.js' %}"></script>




<script>
    
/* ============================================================
   1. MODAL UTILITIES
   ============================================================ */
window._modalDebug = true;

// function logModal(...msg) {
//     if (window._modalDebug) {
//         console.log("%c[MODAL]", "color:#0a7;font-weight:bold;", ...msg);
//     }
// }
// const DRAFT_KEY = "product_draft_v1";
window.showModal = function (id) {
    const el = document.getElementById(id);
    if (!el) return console.error("Modal not found:", id);

    let modal = bootstrap.Modal.getInstance(el);
    if (!modal) modal = new bootstrap.Modal(el);

    modal.show();
};

window.hideModal = function (id) {
    const el = document.getElementById(id);
    bootstrap.Modal.getInstance(el)?.hide();
};

function safeFetch(url, options = {}) {
    return fetch(url, {
        credentials: "same-origin",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": window.CSRF_TOKEN,
            ...(options.headers || {})
        },
        ...options
    }).then(async res => {
        if (!res.ok) {
            const txt = await res.text();
            console.error("[API ERROR]", res.status, txt);
            throw new Error(txt);
        }
        return res.status === 204 ? null : res.json();
    });
}
/* ============================================================
   2. MAIN LOGIC
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {

    /* ---------------------------
       GLOBAL PRODUCT STATE
       --------------------------- */
    window.productState = { parts: [], hardware_rules:[] };
    console.log("üß† Product state initialized", window.productState);
    let editingPartId = null;

    const blankPartState = () => ({
        geometry: {},
        materials: { whitelist: [], defaultMaterialId: null },
        edgebands: { top:{}, right:{}, bottom:{}, left:{} },
        partHardware: {}
    });

    window.currentPartState = blankPartState();

    const partTable = document.getElementById("part-templates-body");

document.getElementById("save-geometry-btn")?.addEventListener("click", () => {
    currentPartState.geometry = {
            lengthEq: document.getElementById("geom-length-eq")?.value || "",
            widthEq: document.getElementById("geom-width-eq")?.value || "",
            qtyEq: document.getElementById("geom-qty-eq")?.value || "",
            svg: window._uploadedSVG || ""
        };
        console.log("[GEOMETRY]", currentPartState.geometry);
        hideModal("geometryModal");
    });

    // MATERIALS
     document.getElementById("save-material-btn")?.addEventListener("click", () => {
        currentPartState.materials = JSON.parse(JSON.stringify(
            window.currentPartState.materials
        ));
        console.log("ü™µ Materials saved", currentPartState.materials);
        hideModal("materialModal");
    });

    // EDGEBANDS
    document.getElementById("save-edgeband-btn")?.addEventListener("click", () => {
        const eb = { top:{}, right:{}, bottom:{}, left:{} };
        document.querySelectorAll(".edgeband-whitelist:checked").forEach(cb => {
            if (eb[cb.dataset.side]) eb[cb.dataset.side].default = cb.dataset.id;
        });
        currentPartState.edgebands = eb;
        console.log("Edgeband Saved", currentPartState.edgebands);
        hideModal("edgebandModal");
    });

    // PART HARDWARE
    document.getElementById("save-part-hardware-btn")?.addEventListener("click", () => {
        const hw = {};
        document.querySelectorAll(".part-select:checked").forEach(cb => {
            const row = cb.closest("tr");
            hw[cb.dataset.id] = {
                qty:  row?.querySelector(".part-qty")?.value || "1",
                cond: row?.querySelector(".part-cond")?.value || ""
            };
        });
        currentPartState.partHardware = hw;
        console.log("part hardware saved",currentPartState.partHardware);
        hideModal("hardwareModal");
    });


    /* ============================================================
       SAVE / UPDATE PART
       ============================================================ */
    document.getElementById("save-part-btn")?.addEventListener("click", () => {

        const name = document.getElementById("part-name").value.trim();
        if (!name) return alert("Part name required");
        if (!currentPartState.geometry.lengthEq) {
            return alert("Geometry must be defined");
        }

        const payload = {
            id: editingPartId || Date.now(),
            name,
            ...JSON.parse(JSON.stringify(currentPartState))
        };

        // UPDATE
        if (editingPartId) {
            const idx = productState.parts.findIndex(p => p.id === editingPartId);
            productState.parts[idx] = payload;

            partTable.querySelector(`tr[data-id="${editingPartId}"]`)?.remove();
            renderPartRow(payload);

            console.log("[PART UPDATED]", payload);
            editingPartId = null;
        }
        // CREATE
        else {
            productState.parts.push(payload);
            console.log("[PART CREATED]", payload);
        }
        renderPartRow(payload);
        resetPartState();
    });


    /* ============================================================
       PART TABLE RENDERING
       ============================================================ */
    function renderPartRow(part) {

        const tr = document.createElement("tr");
        tr.dataset.id = part.id;

        const mat = part.materials.whitelist.length
            ? part.materials.whitelist.map(m =>
                `<span class="badge bg-secondary me-1">${m.display_name}</span>`
              ).join("")
            : "-";

        const eb = Object.entries(part.edgebands)
            .map(([side, obj]) => {
                if (!obj || !obj.whitelist?.length) return null;
                return `<span class="badge bg-info me-1">${side}</span>`;
            })
            .filter(Boolean)
            .join("") || "-";

        const hw = Object.keys(part.partHardware || {}).length
            ? Object.values(part.partHardware).map(h =>
                `<span class="badge bg-dark me-1">${h.qty || 1}</span>`
              ).join("")
            : "-";

        tr.innerHTML = `
            <td>${part.name}</td>
            <td class="small">${part.geometry.lengthEq} √ó ${part.geometry.widthEq}</td>
            <td>${mat}</td>
            <td>${eb}</td>
            <td>${hw}</td>
            <td class="text-center">
                <button class="btn btn-warning btn-sm edit-part">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm remove-part">üóë</button>
            </td>
        `;

        partTable.appendChild(tr);
    }

    partTable?.addEventListener("click", e => {
        const tr = e.target.closest("tr");
        if (!tr) return;

        const id = Number(tr.dataset.id);
        const part = productState.parts.find(p => p.id === id);

        // EDIT
        if (e.target.classList.contains("edit-part")) {
            editingPartId = id;
            window.currentPartState = JSON.parse(JSON.stringify(part));
            document.getElementById("part-name").value = part.name;
            // showModal("geometryModal");
        }

        // DELETE
        if (e.target.classList.contains("remove-part")) {
            if (!confirm("Remove this part?")) return;
            productState.parts = productState.parts.filter(p => p.id !== id);
            tr.remove();
        }
    });


    /* ============================================================
       RESET PART STATE
       ============================================================ */
    function resetPartState() {
        window.currentPartState = blankPartState();
        document.getElementById("part-name").value = "";

        document.querySelectorAll(".modal input, .modal select").forEach(el => el.value = "");
        document.querySelectorAll(".modal input[type=checkbox], .modal input[type=radio]")
            .forEach(el => el.checked = false);
    }


    /* ============================================================
       MODAL OPEN BUTTONS
       ============================================================ */
    const btn = document.getElementById("edit-geometry-btn");
        if (btn) {
    btn.addEventListener("click", () => showModal("geometryModal"));
}
    const materialBtn = document.getElementById("select-material-btn");
if (materialBtn) {
    materialBtn.addEventListener("click", () => showModal("materialModal"));
}

const edgebandBtn = document.getElementById("set-edgebands-btn");
if (edgebandBtn) {
    edgebandBtn.addEventListener("click", () => showModal("edgebandModal"));
}

const hardwareBtn = document.getElementById("rules-hardware-btn");
if (hardwareBtn) {
    hardwareBtn.addEventListener("click", () => {
        console.log("üü¢ Opening PART hardware modal");
        openHardwareModal();   // ‚úÖ IMPORTANT
    });
}

const productHwBtn = document.getElementById("open-product-hardware-modal-btn");
if (productHwBtn) {
    productHwBtn.addEventListener("click", () => {
        console.log("üü¢ Opening PRODUCT hardware modal");
        openProductHardwareModal(); // ‚úÖ IMPORTANT
    });
}



    /* ============================================================
       PARAMETERS
       ============================================================ */
    const parameterBody = document.getElementById("parameter-body");

    document.getElementById("save-param-btn")?.addEventListener("click", () => {
        const name = document.getElementById("param-name").value.trim();
        if (!name) return alert("Parameter name required");
        const abbr    = document.getElementById("param-abbr").value;
        const defVal  = document.getElementById("param-default").value;
        const desc    = document.getElementById("param-desc").value;
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${name}</td>
            <td>${abbr}</td>
            <td>${defVal} </td>
            <td>${desc}</td>
            <td><button class="btn btn-danger btn-sm remove-param-btn">üóë</button></td>
        `;
        parameterBody.appendChild(tr);
        document.getElementById("param-name").value = "";
        document.getElementById("param-abbr").value = "";
        document.getElementById("param-default").value = "";
        document.getElementById("param-desc").value = "";
    });

    parameterBody?.addEventListener("click", e => {
        if (e.target.classList.contains("remove-param-btn")) {
            e.target.closest("tr").remove();
        }
    });


    /* ============================================================
       FINAL SAVE PRODUCT
       ============================================================ */
    document.getElementById("save-product-btn")?.addEventListener("click", async function () {

        const payload = {
            product_name: document.getElementById("product-name").value.trim(),
            category: document.getElementById("categoryselect").value,
            type: document.getElementById("type-select").value,
            model: document.getElementById("model-select").value,
            parameters: collectParameters(),
            parts: productState.parts,
            hardware_rules: []
        };

        console.log("[PRODUCT PAYLOAD]", payload);

        try {
            const productId = this.dataset.productId;
            const res = await fetch(
                productId
                    ? `/modularcalc/api/products/${productId}/`
                    : `/modularcalc/api/products/`,
                {
                    method: productId ? "PUT" : "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": window.CSRF_TOKEN
                    },
                    body: JSON.stringify(payload)
                }
            );

            if (!res.ok) throw new Error("Save failed");
            alert("Product saved");
            if (!productId) location.reload();

        } catch (err) {
            console.error(err);
            alert("Failed to save product");
        }
    });

    function collectParameters() {
        return [...document.querySelectorAll("#parameter-body tr")].map(tr => {
            const td = tr.querySelectorAll("td");
            return {
                name: td[0].innerText,
                abbr: td[1].innerText,
                default: td[2].innerText,
                description: td[3].innerText
            };
        });
    }

});
/* ============================================================
   HARDWARE EVENT BRIDGES
   ============================================================ */

document.addEventListener("partHardwareSaved", e => {
    
    currentPartState.partHardware = e.detail;
});

document.addEventListener("productHardwareSaved", e => {
    
    productState.hardware_rules = e.detail;
});

</script>

{% endblock %}


