{% extends "base_b.html" %}
{% load static %}
{% block content %}

<div class="container my-4" style="max-width: 1400px;">

    <!-- ========= HEADER ========= -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold" id="editor-title">Add Modular Product</h3>
        <button class="btn btn-secondary" onclick="window.location.href='/modularcalc/mproduct/'">
    ‚¨Ö Back to Products
</button>
    </div>

    <!-- ========= PRODUCT INFO ========= -->
    <div class="border rounded p-3 mb-4 bg-light">
        <h5 class="fw-bold border-bottom pb-2 mb-3">Product Info</h5>

        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select id="categoryselect" class="form-select"></select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Type</label>
                <select id="type-select" class="form-select" disabled></select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Model</label>
                <select id="model-select" class="form-select" disabled></select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Product Name</label>
                <input id="product-name" class="form-control" placeholder="Product name">
            </div>

            <div class="col-md-12">
                <label class="form-label">Validation Expression</label>
                <textarea id="validation-expr" class="form-control" rows="2" placeholder="Validation expression"></textarea>
            </div>
        </div>
    </div>

    <div class="row g-3">

        <!-- ========= LEFT COLUMN ========= -->
        <div class="col-3">

            <!-- PARAMETERS -->
            <div class="border rounded p-3 mb-3 bg-light">
                <h6 class="fw-bold mb-2">Parameters</h6>

                <!-- New row -->
                <table class="table table-sm table-bordered mb-2" id="parameter-input-table">
                    <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Abbr</th>
                        <th>Default</th>
                        <th>Description</th>
                        <th style="width:40px"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input id="param-name" class="form-control form-control-sm" placeholder="Name"></td>
                        <td><input id="param-abbr" class="form-control form-control-sm" placeholder="A"></td>
                        <td><input id="param-default" type="number" step="0.01" class="form-control form-control-sm" placeholder="0"></td>
                        <td><input id="param-desc" class="form-control form-control-sm" placeholder="Description"></td>
                        <td><button class="btn btn-sm btn-success" id="save-param-btn">‚úì</button></td>
                    </tr>
                    </tbody>
                </table>

                <!-- Saved -->
                <table class="table table-sm table-bordered" id="parameter-saved-table">
                    <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Abbr</th>
                        <th>Default</th>
                        <th>Description</th>
                        <th style="width:40px"></th>
                    </tr>
                    </thead>
                    <tbody id="parameter-body"></tbody>
                </table>

                               
            </div>

            <!-- ASSETS -->
            <div class="border rounded p-3 bg-light">
                <h6 class="fw-bold pb-2">Assets</h6>

                <label class="form-label">2D SVG</label>
                <textarea id="two-d-svg-input" class="form-control mb-2" rows="2" placeholder="<svg>...</svg>"></textarea>

                <label class="form-label">3D Model Path</label>
                <input id="three-d-asset-input" class="form-control" placeholder="/static/models/example.glb">
            </div>
        </div>


        <!-- ========= MIDDLE COLUMN ========= -->
        <div class="col-6">

            <!-- PART TEMPLATES -->
            <div class="border rounded p-3 mb-3 bg-light">
                <h5 class="fw-bold mb-3">Part Templates</h5>

                <!-- New row -->
                <table class="table table-sm table-bordered mb-2">
                    <thead class="table-light">
                    <tr>
                        <th>Part Name</th>
                        <th>Geometry</th>
                        <th>Materials</th>
                        <th>Edgebands</th>
                        <th>Hardware</th>
                        <th style="width:40px"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input id="part-name" class="form-control form-control-sm" placeholder="Part Name"></td>
                        <td><button id="edit-geometry-btn" class="btn btn-sm btn-outline-secondary w-100">Edit</button></td>
                        <td><button id="select-material-btn" class="btn btn-sm btn-outline-warning w-100">Select</button></td>
                        <td><button id="set-edgebands-btn" class="btn btn-sm btn-outline-info w-100">Set</button></td>
                        <td><button id="rules-hardware-btn" class="btn btn-sm btn-outline-dark w-100">Rules</button></td>
                        <td><button id="save-part-btn" class="btn btn-sm btn-success">‚úì</button></td>
                    </tr>
                    </tbody>
                </table>

                <!-- Saved parts -->
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th>Part Name</th>
                        <th>Geometry</th>
                        <th>Materials</th>
                        <th>Edgebands</th>
                        
                        <th>Hardware</th>
                        <th style="width:40px"></th>
                    </tr>
                    </thead>
                    <tbody id="part-templates-body"></tbody>
                </table>
            </div>

            

        </div>


        <!-- ========= RIGHT COLUMN ========= -->
        <div class="col-3">

            <!-- Summary -->
            <div class="border rounded p-3 mb-3 bg-light">
    <div class="d-flex justify-content-between mb-2">
        <h6 class="fw-bold mb-0">Product Hardware</h6>
        <button id="open-product-hardware-modal-btn" class="btn btn-sm btn-primary w-100 mb-2">
    + Add 
</button>
    </div>
    <div id="product-hardware-summary"></div>
</div>

            <div class="border rounded p-3 mb-3 bg-light">
                <h6 class="fw-bold">Material Calculation</h6>
                <div id="material-calc-summary"></div>
            </div>

            <div class="border rounded p-3 mb-3 bg-light">
                <h6 class="fw-bold">CNC / Cutlist</h6>
                <div id="cutlist-container"></div>
            </div>

            <!-- Buttons -->
            <div class="border rounded p-3 bg-light">
                <h6 class="fw-bold">Quotation</h6>
                <button id="save-product-btn" class="btn btn-success w-100 mb-2">üíæ Save Product</button>
                <button id="open-quotation-modal-btn" class="btn btn-primary w-100">üìÑ Generate Quote</button>
            </div>
        </div>

    </div>

</div>

<!-- ===== MODALS (EDGEBAND, MATERIAL, HARDWARE, GEOMETRY, ETC.) ===== -->
{% include "modular_ui_b.html" %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'JS/intitalfill.js' %}"></script>
<script src="{% static 'JS/dataloader.js' %}"></script>
<script src="{% static 'JS/geometry.js' %}"></script>
<script src="{% static 'JS/mproductmaterial.js' %}"></script>
<script src="{% static 'JS/mproductedgeband.js' %}"></script>
<script src="{% static 'JS/mp_parts&productshardware.js' %}"></script>

<script>
/* =====================================================================
   1. MODAL UTILITIES (Must be defined before usage)
   ===================================================================== */
window._modalDebug = true; 

function logModal(...msg) {
    if (window._modalDebug) console.log("%c[MODAL-DEBUG]", "color:#0a7;font-weight:bold;", ...msg);
}

// Unified Show Modal Function
window.showModal = function (id) {
    logModal("showModal() called for:", id);
    const el = document.getElementById(id);
    if (!el) {
        console.error("‚ùå ERROR ‚Äî Modal element not found:", id);
        return null;
    }

    let modal = bootstrap.Modal.getInstance(el);
    if (!modal) {
        modal = new bootstrap.Modal(el);
    }

    modal.show();
    
    // Accessibility Enhancements
    el.setAttribute('aria-hidden', 'false');
    el.removeAttribute('inert');
    
    // Auto-focus first input
    const focusable = el.querySelector('button, input, select, textarea');
    if (focusable) focusable.focus();

    return modal;
};

// Unified Hide Modal Function
window.hideModal = function (id) {
    const el = document.getElementById(id);
    if (!el) return;

    const modal = bootstrap.Modal.getInstance(el);
    if (modal) modal.hide();

    // Accessibility Reset
    el.setAttribute('aria-hidden', 'true');
    el.setAttribute('inert', 'true');
};

/* =====================================================================
   2. MAIN LOGIC
   ===================================================================== */
document.addEventListener("DOMContentLoaded", function () {

    // --- GLOBAL STATE ---
    const currentProduct = { parts: [] };
    
    // Temporary bucket for the part currently being edited
    window.currentPartState = {
        geometry: {},
        materials: { whitelist: [], defaultMaterialId: null },
        edgebands: {}, 
        partHardware: {}
    };

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    /* ---------------------------------------------------------------------
       DATA BRIDGES: Capture data when "Save" is clicked INSIDE Modals
       --------------------------------------------------------------------- */
    
    // 1. GEOMETRY BRIDGE
    const geomSaveBtn = document.getElementById("save-geometry-btn");
    if (geomSaveBtn) {
        geomSaveBtn.addEventListener("click", function() {
            window.currentPartState.geometry = {
                lengthEq: document.getElementById("geom-length-eq")?.value || "",
                widthEq: document.getElementById("geom-width-eq")?.value || "",
                qtyEq: document.getElementById("geom-qty-eq")?.value || "",
                svg: window._uploadedSVG || "" 
            };
            console.log("[BRIDGE] Geometry captured:", window.currentPartState.geometry);
            // geometry.js usually handles closing, but we ensure it here if needed:
            // window.hideModal('geometryModal');
        });
    }

    // 2. MATERIALS BRIDGE
    const matSaveBtn = document.getElementById("save-material-btn");
    if (matSaveBtn) {
        matSaveBtn.addEventListener("click", function() {
            const whitelist = [];
            // Scrape checked boxes
            document.querySelectorAll('.material-whitelist:checked').forEach(cb => {
                const row = cb.closest('tr');
                const name = row ? row.cells[0].innerText.trim() : "Material " + cb.dataset.id;
                whitelist.push({ id: cb.dataset.id, display_name: name });
            });

            window.currentPartState.materials.whitelist = whitelist;
            // Add default logic here if you have a default selector radio
            
            console.log("[BRIDGE] Materials captured:", window.currentPartState.materials);
            window.hideModal('materialModal');
        });
    }

    // 3. EDGEBANDS BRIDGE
    const ebSaveBtn = document.getElementById("save-edgeband-btn");
    if (ebSaveBtn) {
        ebSaveBtn.addEventListener("click", function() {
            const ebData = { top: {}, right: {}, bottom: {}, left: {} };
            
            document.querySelectorAll('.edgeband-whitelist:checked').forEach(cb => {
                const side = cb.dataset.side; 
                const id = cb.dataset.id;
                if (side && ebData[side]) {
                    ebData[side].default = id; // simplistic approach: last checked is default
                }
            });

            window.currentPartState.edgebands = ebData;
            console.log("[BRIDGE] Edgebands captured:", window.currentPartState.edgebands);
            window.hideModal('edgebandModal');
        });
    }

    // 4. HARDWARE BRIDGE
    const hwSaveBtn = document.getElementById("save-part-hardware-btn");
    if (hwSaveBtn) {
        hwSaveBtn.addEventListener("click", function() {
            const hwData = {};
            document.querySelectorAll('.part-select:checked').forEach(cb => {
                const id = cb.dataset.id;
                const row = cb.closest('tr');
                const qty = row.querySelector('.part-qty')?.value || "1";
                const cond = row.querySelector('.part-cond')?.value || "";
                
                hwData[id] = { qty, cond };
            });

            window.currentPartState.partHardware = hwData;
            console.log("[BRIDGE] Hardware captured:", window.currentPartState.partHardware);
            window.hideModal('hardwareModal');
        });
    }

    /* ---------------------------------------------------------------------
       SAVE PART TEMPLATE (Main "Checkmark" Button)
       --------------------------------------------------------------------- */
    const partTemplatesBody = document.getElementById("part-templates-body");
    const savePartBtn = document.getElementById("save-part-btn");

    savePartBtn.addEventListener("click", () => {
        const partName = document.getElementById("part-name").value.trim();
        if (!partName) return alert("Part name is required");

        // Simple validation: Ensure Geometry was captured
        if (!window.currentPartState.geometry.lengthEq && !window.currentPartState.geometry.widthEq) {
            return alert("Please define and save Geometry (Edit) before saving the part.");
        }

        // Create Part Object using the captured state
        const part = {
            id: Date.now(),
            name: partName,
            geometry: { ...window.currentPartState.geometry },
            materials: { ...window.currentPartState.materials },
            edgebands: { ...window.currentPartState.edgebands },
            partHardware: { ...window.currentPartState.partHardware }
        };

        // Add to global product object
        currentProduct.parts.push(part);
        addPartRow(part);

        // Reset State for next part
        resetPartState();

        console.log("[MAIN] Part Saved:", part);
    });

    function resetPartState() {

    // 1. RESET JS STATE OBJECT
    window.currentPartState = {
        geometry: {},
        materials: { whitelist: [], defaultMaterialId: null },
        edgebands: { top:{}, right:{}, bottom:{}, left:{} },
        partHardware: {}
    };

    // 2. CLEAR PART NAME
    document.getElementById("part-name").value = "";

    // =====================================
    // 3. CLEAR GEOMETRY MODAL UI
    // =====================================
    document.getElementById("geom-length-eq").value = "";
    document.getElementById("geom-width-eq").value = "";
    document.getElementById("geom-qty-eq").value = "";

    window._uploadedSVG = null;
    const svgPreview = document.getElementById("svg-preview");
    if (svgPreview) svgPreview.innerHTML = "";

    // =====================================
    // 4. CLEAR MATERIAL MODAL UI
    // =====================================
    document.querySelectorAll('.material-whitelist').forEach(cb => cb.checked = false);
    document.querySelectorAll('.material-default').forEach(rb => rb.checked = false);

    // internal module state
    if (window.materialSelectedWhitelist) window.materialSelectedWhitelist = [];
    if (window.renderMaterialTable) window.renderMaterialTable();

    // =====================================
    // 5. CLEAR EDGEBAND MODAL UI
    // =====================================
    document.querySelectorAll('.edgeband-whitelist').forEach(cb => cb.checked = false);

    if (window.selectedEdgebands)
        window.selectedEdgebands = { top:{}, right:{}, bottom:{}, left:{} };

    if (window.renderEdgebandTable) window.renderEdgebandTable();

    // =====================================
    // 6. CLEAR HARDWARE MODAL UI
    // =====================================
    document.querySelectorAll('.part-select').forEach(cb => cb.checked = false);
    document.querySelectorAll('.part-qty').forEach(i => i.value = "");
    document.querySelectorAll('.part-cond').forEach(i => i.value = "");

    if (window.selectedHardware) window.selectedHardware = {};

    if (window.renderHardwareTable) window.renderHardwareTable();

    // =====================================
    // 7. CLEAR SEARCH FIELDS IN MODALS
    // =====================================
    document.querySelectorAll('.modal input[type="search"]').forEach(e => e.value = "");

    console.log("[RESET] All modals and state reset completely.");
}

    function addPartRow(part) {
        const tr = document.createElement("tr");
        tr.dataset.id = part.id;
        
        // Display helpers
        const matText = part.materials.whitelist.map(m => m.display_name).join(", ") || "-";
        
        // Simple Edgeband Text
        const renderEb = (s) => (part.edgebands[s]?.default ? "Yes" : "-");
        const ebText = `T:${renderEb('top')} R:${renderEb('right')} B:${renderEb('bottom')} L:${renderEb('left')}`;
        
        // Hardware Text
        const hwText = Object.keys(part.partHardware).length > 0 ? `${Object.keys(part.partHardware).length} items` : "-";

        tr.innerHTML = `
            <td>${part.name}</td>
            <td class="text-center small">${part.geometry.lengthEq} x ${part.geometry.widthEq}</td>
            <td class="text-center small">${matText}</td>
            <td class="text-center small">${ebText}</td>
            <td class="text-center small">${hwText}</td>
            <td class="text-center"><button class="btn btn-danger btn-sm remove-part-btn">üóëÔ∏è</button></td>
        `;
        partTemplatesBody.appendChild(tr);
    }

    partTemplatesBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-part-btn")) {
            const tr = e.target.closest("tr");
            const id = parseInt(tr.dataset.id);
            currentProduct.parts = currentProduct.parts.filter(p => p.id !== id);
            tr.remove();
        }
    });

    /* ---------------------------------------------------------------------
       BUTTON LISTENERS (Opening Modals)
       --------------------------------------------------------------------- */
    document.getElementById("edit-geometry-btn").addEventListener("click", () => window.showModal("geometryModal"));
    document.getElementById("select-material-btn").addEventListener("click", () => window.showModal("materialModal"));
    document.getElementById("set-edgebands-btn").addEventListener("click", () => window.showModal("edgebandModal"));
    document.getElementById("rules-hardware-btn").addEventListener("click", () => window.showModal("hardwareModal"));
    
    const prodHwBtn = document.getElementById("open-product-hardware-modal-btn");
    if(prodHwBtn) prodHwBtn.addEventListener("click", () => window.showModal("productHardwareModal"));

    /* ---------------------------------------------------------------------
       PARAMETERS (Existing Logic)
       --------------------------------------------------------------------- */
    const parameterBody = document.getElementById("parameter-body");
    document.getElementById("save-param-btn").addEventListener("click", function () {
        const name = document.getElementById("param-name").value.trim();
        if (!name) return alert("Parameter name is required");
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td>
                        <td>${document.getElementById("param-abbr").value}</td>
                        <td>${document.getElementById("param-default").value}</td>
                        <td>${document.getElementById("param-desc").value}</td>
                        <td class="text-center"><button class="btn btn-danger btn-sm remove-param-btn">üóëÔ∏è</button></td>`;
        parameterBody.appendChild(tr);
        document.getElementById("param-name").value = "";
    });
    parameterBody.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-param-btn")) e.target.closest("tr").remove();
    });

    /* ---------------------------------------------------------------------
       FINAL SAVE PRODUCT
       --------------------------------------------------------------------- */
    document.getElementById("save-product-btn").addEventListener("click", async function () {
        const productName = document.getElementById("product-name").value.trim();
        if (!productName) return alert("Product name is required");

        // Collect Parameters
        const parameters = [];
        parameterBody.querySelectorAll("tr").forEach(tr => {
            const tds = tr.querySelectorAll("td");
            parameters.push({
                name: tds[0].innerText,
                abbr: tds[1].innerText,
                default: tds[2].innerText,
                description: tds[3].innerText
            });
        });

        // Collect Product Hardware Rules
        const hwRules = []; // Add logic here if you have a container for general hw rules

        const data = {
            product_name: productName,
            category: document.getElementById("categoryselect").value,
            type: document.getElementById("type-select").value,
            model: document.getElementById("model-select").value,
            parameters,
            parts: currentProduct.parts, // The main payload!
            hardware_rules: hwRules
        };

        // Network Request
        try {
            const productId = this.dataset.productId;
            const method = productId ? "PUT" : "POST";
            const url = productId ? `/modularcalc/api/products/${productId}/` : "/modularcalc/api/products/";

            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Failed to save product");
            alert("Product saved successfully!");
            if (!productId) {
                 location.reload(); // Simple reset
            }
        } catch (err) {
            console.error(err);
            alert("Error saving product.");
        }
    });

    // Initialize dropdowns (if you have this function)
    if(typeof preloadAllData === 'function') preloadAllData();

});
</script>


{% endblock %}


