<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Configurator (Architecture B - Sequential)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/modularcalc/api/b/';
        const API_PRODUCTS = API_BASE + 'products/';
        const API_PARAMS = API_BASE + 'parameters/';
        const API_PARTS = API_BASE + 'part_templates/';
        const API_PART_MATERIALS = API_BASE + 'part_materials/';
        
        let productId = null; 

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const CSRF_TOKEN = getCookie('csrftoken');
        
        // --- CORE LOGIC: SEQUENTIAL SAVE (MULTIPLE CALLS) ---

        // Step 1: Save/Update the ModularProduct metadata
        async function saveProductMetadata() {
            const data = {
                name: $('#product-name-b').val(),
                product_validation_expression: $('#validation-expr-b').val(),
            };
            const method = productId ? 'PUT' : 'POST';
            const url = productId ? `${API_PRODUCTS}${productId}/` : API_PRODUCTS;

            const response = await $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: { 'X-CSRFToken': CSRF_TOKEN },
            });
            return response.id;
        }

        // Step 2: Save Product Parameters (requires productId)
        async function saveProductParameters(prodId) {
            // In a real app, this would iterate over a table of parameters
            const params = [
                { product: prodId, name: 'product_length', default_value: 1200 },
                { product: prodId, name: 'product_width', default_value: 600 }
            ];
            
            // This would involve a series of POST/PUT calls for each parameter
            // For simplicity, we just save the first one here:
            await $.ajax({
                url: API_PARAMS,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(params[0]),
                headers: { 'X-CSRFToken': CSRF_TOKEN },
            });
            console.log("Saved Product Parameters.");
        }

        // Step 3: Save a PartTemplate (requires productId)
        async function savePartTemplate(prodId) {
            const partData = {
                product: prodId,
                name: 'Side Panel',
                part_length_equation: 'product_height',
                part_width_equation: 'product_depth',
                part_qty_equation: '2',
                part_thickness_mm: 18.0,
                edgeband_top: 1, // Must be a valid EdgeBand PK
                // ... other PartTemplate fields
            };
            
            const response = await $.ajax({
                url: API_PARTS,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(partData),
                headers: { 'X-CSRFToken': CSRF_TOKEN },
            });
            return response.id; // Return the new part ID
        }

        // Step 4: Save Part Material Whitelist (requires partId)
        async function savePartWhitelists(partId) {
            const whitelistData = {
                part_template: partId,
                material: 1, // Must be a valid WoodEn PK
                is_default: true
            };
            
            await $.ajax({
                url: API_PART_MATERIALS,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(whitelistData),
                headers: { 'X-CSRFToken': CSRF_TOKEN },
            });
            console.log("Saved Part Whitelist.");
        }


        async function handleSequentialSave() {
            try {
                // 1. Save Product Metadata
                const newProdId = await saveProductMetadata();
                productId = newProdId;
                
                // 2. Save Child 1: Parameters
                await saveProductParameters(productId);
                
                // 3. Save Child 2: Part Template (and get its new ID)
                const newPartId = await savePartTemplate(productId);
                
                // 4. Save Grandchild: Part Whitelist (requires the new part ID)
                await savePartWhitelists(newPartId);
                
                alert(`Product and all children saved successfully via Architecture B. Product ID: ${productId}`);

            } catch (error) {
                console.error("Sequential Save Failed at a step:", error);
                alert('Sequential save failed. Check console for details.');
            }
        }
        
        // --- UI Initialization ---
        $(document).ready(function() {
            $('#save-btn-b').on('click', handleSequentialSave);
        });

    </script>
</head>
<body>
    <div class="container my-5">
        <h1>Modular Product Configuration (Architecture B: Sequential Save)</h1>
        <p class="text-muted">Multiple API calls needed to save metadata, then parts, then whitelists.</p>

        <div class="card mb-3">
            <div class="card-header">Product Details</div>
            <div class="card-body">
                <input type="text" id="product-name-b" class="form-control mb-2" placeholder="Product Name (e.g., Wall Unit)">
                <textarea id="validation-expr-b" class="form-control" placeholder="Validation Expression"></textarea>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Sequential Data Entry</div>
            <div class="card-body">
                <p>This UI represents a multi-step process. Each save action (Product, Part, Whitelist) requires a separate successful API call, often dependent on the ID generated in the previous step.</p>
                <div class="alert alert-warning">
                    See the JavaScript code for the 4 sequential `async/await` steps required to fully save the configuration.
                </div>
            </div>
        </div>
        
        <button id="save-btn-b" class="btn btn-warning btn-lg">Execute Sequential Save</button>
    </div>
</body>
</html>