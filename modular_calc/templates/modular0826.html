{% extends "base_b.html" %}
{% load static %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Modular Products</h4>
    <div>
      <input id="searchProducts" class="form-control form-control-sm d-inline-block" style="width:260px" placeholder="Search products by name">
      <button id="btnNewProduct" class="btn btn-primary btn-sm ms-2">
        <i class="bi bi-plus"></i> New Product
      </button>
    </div>
  </div>

  <div id="productsList" class="row g-3"></div>
  <nav><ul id="productsPagination" class="pagination pagination-sm mt-3"></ul></nav>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="productForm" class="modal-content" novalidate>
      <div class="modal-header">
        <h5 class="modal-title">Product</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <input type="hidden" id="product_id">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input type="text" id="product_name" class="form-control" required>
        </div>
        <div class="col-12">
          <label class="form-label">Validation Expression</label>
          <input type="text" id="product_validation_expression" class="form-control" placeholder="e.g., 600 <= product_width <= 2400 and quantity >= 1">
          <div class="form-text">Vars: product_length, product_width, product_height, product_depth, quantity</div>
        </div>
        <div class="col-12">
          <label class="form-label">2D Template SVG (optional)</label>
          <textarea id="two_d_template_svg" class="form-control" rows="3"></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">3D Asset (GLB/GLTF)</label>
          <input type="file" id="three_d_asset" class="form-control" accept=".glb,.gltf">
          <div class="form-text">Leave empty to keep existing.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Part Modal -->
<div class="modal fade" id="partModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="partForm" class="modal-content" novalidate>
      <div class="modal-header">
        <h5 class="modal-title">Part Template</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <input type="hidden" id="part_id">
        <input type="hidden" id="part_product">
        <div class="col-md-6">
          <label class="form-label">Part Name</label>
          <input type="text" id="part_name" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Thickness (mm)</label>
          <select id="part_thickness_mm" class="form-select" required>
            <option value="">Loading...</option> <!-- Temporary loading message -->
          </select>
        </div>
        <div class="col-md-12">
          <label class="form-label">Length Equation</label>
          <input type="text" id="part_length_equation" class="form-control" placeholder="e.g., product_height" required>
        </div>
        <div class="col-md-12">
          <label class="form-label">Width Equation</label>
          <input type="text" id="part_width_equation" class="form-control" placeholder="e.g., product_depth - part_thickness" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Quantity Equation</label>
          <input type="text" id="part_qty_equation" class="form-control" value="1" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Wastage Multiplier</label>
          <input type="number" step="0.01" id="shape_wastage_multiplier" class="form-control" value="1.00">
        </div>
        <div class="col-md-6">
          <label class="form-label">EdgeBand Top</label>
          <select id="edgeband_top" class="form-select select2-edgeband"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">EdgeBand Bottom</label>
          <select id="edgeband_bottom" class="form-select select2-edgeband"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">EdgeBand Left</label>
          <select id="edgeband_left" class="form-select select2-edgeband"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">EdgeBand Right</label>
          <select id="edgeband_right" class="form-select select2-edgeband"></select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>
<!-- Parameters Modal -->
<div class="modal fade" id="parametersModal" tabindex="-1" aria-labelledby="parametersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manage Parameters</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Add Parameter Form -->
        <div class="row mb-3">
          <div class="col">
            <input type="text" id="paramName" class="form-control" placeholder="Name">
          </div>
          <div class="col">
            <input type="text" id="paramAbr" class="form-control" placeholder="Abbreviation (e.g. h)">
          </div>
          <div class="col">
            <input type="number" id="paramValue" class="form-control" placeholder="Value">
          </div>
          <div class="col-auto">
            <button class="btn btn-success" id="addParameterBtn">Add</button>
          </div>
        </div>

        <!-- Parameters Table -->
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Name</th>
              <th>Abbreviation</th>
              <th>Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="parametersTableBody">
            <!-- Parameters will be added here dynamically -->
          </tbody>
        </table>

      </div>
    </div>
  </div>
</div>
 <!-- Hardware Configurations Modal -->
<div class="modal fade" id="hardwareModal" tabindex="-1" aria-labelledby="hardwareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Hardware Configurations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Container for dynamic hardware fields -->
        <div id="hardwareGroupsContainer" class="row"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" id="saveHardwareConfigBtn">Save Configuration</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="appToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Error</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
<script>
(function () {
  // ---- CONFIG ----
  const API = {
    products: "/modularcalc/api/products/",
    parts: (pid, partId = "") => `/modularcalc/api/products/${pid}/parts/${partId ? partId + "/" : ""}`,
    edgebands: "/material/v1/edgebands/", // adjust to your edgeband listing
  };

  // ---- CSRF ----
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");
  $.ajaxSetup({
    headers: {"X-CSRFToken": csrftoken},
    error: function (xhr) {
      const msg = xhr.responseJSON && xhr.responseJSON.detail ? xhr.responseJSON.detail : xhr.responseText || "Request failed";
      console.error("[AJAX ERROR]", xhr.status, msg);
      showToast(`Error ${xhr.status}: ${msg}`);
    }
  });

  // ---- Toast ----
  let toast;
  function showToast(msg, ok=false) {
    const el = $("#appToast");
    $("#toastBody").text(msg);
    el.removeClass("text-bg-danger text-bg-success").addClass(ok ? "text-bg-success" : "text-bg-danger");
    toast = toast || new bootstrap.Toast(el[0], {delay: 3000});
    toast.show();
  }

  // ---- State ----
  let productPage = 1;
  let productSearch = "";
  let lastProductsResp = null;

  // ---- Helpers ----
  function queryString(params) {
    const usp = new URLSearchParams(params);
    return "?" + usp.toString();
  }

  function paginate(container, resp, onClick) {
    const ul = $(container);
    ul.empty();
    if (!resp || resp.count <= resp.results.length) return;

    const pageSize = resp.results.length;
    const total = resp.count;
    const pages = Math.ceil(total / pageSize);
    const current = getPageFromUrl(resp.next, resp.previous, pages);

    function li(p, label, disabled=false, active=false) {
      return `<li class="page-item ${disabled ? "disabled" : ""} ${active ? "active" : ""}">
        <a class="page-link" href="#" data-page="${p}">${label}</a></li>`;
    }

    ul.append(li(current - 1, "&laquo;", current <= 1));
    for (let p = 1; p <= pages; p++) {
      ul.append(li(p, p, false, p === current));
    }
    ul.append(li(current + 1, "&raquo;", current >= pages));

    ul.off("click").on("click", "a.page-link", function (e) {
      e.preventDefault();
      const p = Number($(this).data("page"));
      if (!p || p < 1 || p > pages) return;
      onClick(p);
    });
  }

  function getPageFromUrl(next, prev, pages) {
    // derive current page from next/prev URLs
    const parse = (url) => {
      if (!url) return null;
      const u = new URL(url, window.location.origin);
      return Number(u.searchParams.get("page"));
    };
    const n = parse(next);
    const p = parse(prev);
    if (!n && !p) return 1;
    if (!n && p) return pages;
    return n - 1;
  }
// Fetch Wooden Model Thicknesses and populate the dropdown
function fetchWoodenModelThickness() {
  $.get("http://127.0.0.1:8000/material/v1/woodens/")  // Fetch data from API
    .done((response) => {
      console.log('API Response:', response);  // Log the whole response

      const woodModels = response.results || [];
      const thicknessSelect = $("#part_thickness_mm");

      // Clear the existing options and reset Select2
      thicknessSelect.empty();

      // Add a placeholder option
      thicknessSelect.append('<option value="">Select Thickness</option>');

      // Check if woodModels has any items
      if (woodModels.length === 0) {
        console.log('No wooden models found.');
        return; // Exit early if no models are found
      }

      // Populate the thickness dropdown with available thicknesses from the wooden models
      woodModels.forEach((wood, index) => {
        console.log(`Wood Model ${index + 1}:`, wood); // Log each wood model to check its structure

        const thickness = parseFloat(wood.thickness);  // Convert to float

        if (!isNaN(thickness) && thickness > 0) {
          console.log(`Thickness for Wood Model ${index + 1}:`, thickness);  // Log the thickness value

          // Create the option for the dropdown
          const option = new Option(`${thickness} mm`, thickness);

          // Append the option to the select element
          thicknessSelect.append(option);
        } else {
          console.warn(`Invalid thickness for Wood Model ${index + 1}: ${wood.thickness}`);
        }
      });

      // Destroy and reinitialize Select2 to ensure it's refreshed
      thicknessSelect.select2('destroy').select2();

      // After setting up the thickness, you should trigger the initEdgebandSelects function with the chosen thickness
      const selectedThickness = thicknessSelect.val(); // Get selected thickness
      console.log("Selected Thickness: ", selectedThickness); // Debugging: Log the selected thickness

      // Ensure the selected thickness is passed correctly to the initEdgebandSelects function
      if (!isNaN(selectedThickness) && selectedThickness !== "") {
        initEdgebandSelects({}, selectedThickness); // Pass the selected thickness to the function
      } else {
        console.error("Invalid selected thickness value: ", selectedThickness);
      }

    })
    .fail((xhr) => {
      console.error("Error fetching wooden models:", xhr.responseText);
      showToast("Failed to load wooden models", false);
    });
}
function initEdgebandSelects(defaults = {}, panelThickness) {
  console.log("Received Panel Thickness: ", panelThickness);

  // Ensure panelThickness is a number
  panelThickness = parseFloat(panelThickness);

  if (isNaN(panelThickness)) {
    console.error("Invalid panel thickness value:", panelThickness);
    showToast("Invalid panel thickness value.", false);
    return;
  }

  console.log("Panel Thickness: ", panelThickness);

  $(".select2-edgeband").select2({
    dropdownParent: $("#partModal"),
    width: "100%",
    allowClear: true,
    placeholder: "Select EdgeBand (optional)",
    ajax: {
      url: API.edgebands,
      delay: 150,
      data: (params) => {
        return {
          search: params.term || "",
          page: params.page || 1,
        };
      },
      processResults: (data) => {
        console.log("API Response for Edgebands: ", data);

        const filteredResults = data.results.filter(edgeband => {
          const depth = parseFloat(edgeband.edgeband_name.depth);
          console.log(`Checking Edgeband Depth: ${depth} <= Panel Thickness: ${panelThickness}`);
          return depth >= panelThickness && depth <= (panelThickness + 5);
        });

        console.log("Filtered Edgebands: ", filteredResults);

        const results = filteredResults.map(e => ({
          id: e.id,
          text: `${e.edgeband_name.name || e.display_name} (${e.e_thickness}mm)`,
          depth: e.edgeband_name.depth,
          thickness: e.e_thickness
        }));

        return {
          results: results,
          pagination: { more: !!data.next }
        };
      }
    }
  });

  // Set defaults if provided
  for (const key of ["edgeband_top", "edgeband_bottom", "edgeband_left", "edgeband_right"]) {
    if (defaults[key]) {
      const $sel = $("#" + key);
      const opt = new Option(defaults[key].text || defaults[key].label || defaults[key].id, defaults[key].id, true, true);
      $sel.append(opt).trigger("change");
    }
  }
}
$("#part_thickness_mm").on("change", function () {
  const selectedThickness = parseFloat($(this).val());
  console.log("Selected thickness from dropdown:", selectedThickness);

  if (!isNaN(selectedThickness)) {
    // Call the init with correct thickness
    initEdgebandSelects({}, selectedThickness);
  } else {
    console.warn("Invalid thickness selected.");
  }
});


  // ---- Products ----
  function fetchProducts(page=1) {
    const params = {page};
    if (productSearch) params.search = productSearch;
    return $.get(API.products + queryString(params))
      .done((resp) => {
        lastProductsResp = resp;
        renderProducts(resp.results);
        paginate("#productsPagination", resp, (p) => { productPage = p; fetchProducts(p); });
      });
  }

  function renderProducts(items) {
    const wrap = $("#productsList");
    wrap.empty();

    if (!items || !items.length) {
      wrap.html(`<div class="col-12"><div class="alert alert-info">No products found.</div></div>`);
      return;
    }

    for (const p of items) {
      wrap.append(`
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="mb-0">${escapeHtml(p.name)}</h5>
                  <small class="text-muted">Updated: ${new Date(p.updated_at).toLocaleString()}</small>
                  <div class="mt-2"><code>${escapeHtml(p.product_validation_expression || "")}</code></div>
                </div>
                <div>
                  
                  <button class="btn btn-sm btn-success btn-add-part" data-id="${p.id}">Add Part</button><br>
                  <button class="btn btn-sm btn-info me-1 btn-parameters" data-id="${p.id}">Parameters</button><br>
                  <button class="btn btn-sm btn-warning me-1 btn-hardware-configurations" data-id="${p.id}">Hardware Configurations</button>
                  <hr>
                  <button class="btn btn-sm btn-outline-primary me-1 btn-edit-product" data-id="${p.id}">Edit</button>
                  <button class="btn btn-sm btn-outline-danger me-1 btn-delete-product" data-id="${p.id}">Delete</button>
                  </div>
              </div>
              <hr>
              <div class="mt-2">
                <h6 class="d-flex justify-content-between align-items-center">
                  <span>Parts</span>
                  <a href="#" class="small btn-refresh-parts" data-id="${p.id}">Refresh</a>
                </h6>
                <div id="parts-${p.id}" class="table-responsive"></div>
              </div>
            </div>
          </div>
        </div>
      `);
      fetchPartsTable(p.id);
    }
  }

  function fetchPartsTable(productId) {
  $.get(`${API.products}${productId}/parts/`)
    .done((resp) => {
      const rows = resp.results || resp; // Handle paginated or non-paginated responses

      // Create HTML table
      const html = `
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Eq (L × W)</th>
              <th>Qty Eq</th>
              
              <th>Wastage</th>
              <th>Edges (T/B/L/R)</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(pt => `
              <tr>
                <td>${escapeHtml(pt.name) || '-'}</td> <!-- Default if name is missing -->
                <td><code>${escapeHtml(pt.part_length_equation || '-')} × ${escapeHtml(pt.part_width_equation || '-')}</code></td>
                <td><code>${escapeHtml(pt.part_qty_equation || '-')}</code></td>
                
                <td>${pt.shape_wastage_multiplier || '-'}</td>
                <td>
                  ${formatEdgeband(pt.edgeband_top)} /
                  ${formatEdgeband(pt.edgeband_bottom)} /
                  ${formatEdgeband(pt.edgeband_left)} /
                  ${formatEdgeband(pt.edgeband_right)}
                </td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-secondary btn-edit-part" data-id="${pt.id}" data-pid="${productId}">Edit</button>
                  <button class="btn btn-sm btn-outline-danger btn-delete-part" data-id="${pt.id}" data-pid="${productId}">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;

      // Update the DOM with the table HTML
      $(`#parts-${productId}`).html(html);
    })
    .fail((xhr, status, error) => {
      console.error("Error fetching parts:", error);
      // Display an error message to the user
      showToast("Failed to load parts. Please try again later.", false);
    });
}

// Function to format the Edgeband as "16X2"
function formatEdgeband(edgeband) {
  if (edgeband && edgeband.display_name) {
    // Updated regular expression to handle potential spaces or different formats
    const match = edgeband.display_name.match(/(\d+(\.\d+)?)\s*\(\s*Thickness\s*(\d+\.\d+)mm\)/);
    if (match) {
      const depth = Math.floor(parseFloat(match[1]));  // Remove decimals for depth
      const thickness = Math.floor(parseFloat(match[3]));  // Remove decimals for thickness
      return `${depth}X${thickness}`;  // Format as "16X2"
    }
  }
  return "-";  // Return "-" if edgeband is missing or format doesn't match
}




  // ---- Product Handlers ----
  $("#btnNewProduct").on("click", () => {
    $("#productForm")[0].reset();
    $("#product_id").val("");
    $("#productModal").modal("show");
  });

  $("#productsList").on("click", ".btn-edit-product", function () {
    const id = $(this).data("id");
    $.get(API.products + id + "/").done((p) => {
      $("#product_id").val(p.id);
      $("#product_name").val(p.name);
      $("#product_validation_expression").val(p.product_validation_expression || "");
      $("#two_d_template_svg").val(p.two_d_template_svg || "");
      // file input is not set programmatically for security; leave it blank
      $("#productModal").modal("show");
    });
  });

  $("#productsList").on("click", ".btn-delete-product", function () {
    const id = $(this).data("id");
    if (!confirm("Delete this product? This will remove its parts too.")) return;
    $.ajax({url: API.products + id + "/", method: "DELETE"})
      .done(() => { showToast("Product deleted", true); fetchProducts(productPage); });
  });

  $("#productsList").on("click", ".btn-refresh-parts", function (e) {
    e.preventDefault();
    const pid = $(this).data("id");
    fetchPartsTable(pid);
  });

  $("#productForm").on("submit", function (e) {
    e.preventDefault();
    const id = $("#product_id").val();
    const formData = new FormData();
    formData.append("name", $("#product_name").val());
    formData.append("product_validation_expression", $("#product_validation_expression").val());
    formData.append("two_d_template_svg", $("#two_d_template_svg").val());
    const file = $("#three_d_asset")[0].files[0];
    if (file) formData.append("three_d_asset", file);

    $.ajax({
      url: API.products + (id ? id + "/" : ""),
      method: id ? "PATCH" : "POST",
      data: formData,
      processData: false,
      contentType: false
    })
    .done(() => { $("#productModal").modal("hide"); showToast("Product saved", true); fetchProducts(productPage); });
  });

  // ---- Part Handlers ----
  $("#productsList").on("click", ".btn-add-part", function () {
    const productId = $(this).data("id");
    $("#partForm")[0].reset();
    $("#part_id").val("");
    $("#part_product").val(productId);
    // init Select2 each time (ensures dropdownParent works)
    initEdgebandSelects();
    fetchWoodenModelThickness();
    $("#partModal").modal("show");
  });

  $("#productsList").on("click", ".btn-edit-part", function () {
    const id = $(this).data("id");
    const pid = $(this).data("pid");
    $.get(API.parts(pid, id)).done((pt) => {
      $("#part_id").val(pt.id);
      $("#part_product").val(pid);
      $("#part_name").val(pt.name);
      $("#part_thickness_mm").val(pt.part_thickness_mm);
      $("#part_length_equation").val(pt.part_length_equation);
      $("#part_width_equation").val(pt.part_width_equation);
      $("#part_qty_equation").val(pt.part_qty_equation);
      $("#shape_wastage_multiplier").val(pt.shape_wastage_multiplier);

      initEdgebandSelects({
        edgeband_top: pt.edgeband_top ? {id: pt.edgeband_top, text: String(pt.edgeband_top)} : null,
        edgeband_bottom: pt.edgeband_bottom ? {id: pt.edgeband_bottom, text: String(pt.edgeband_bottom)} : null,
        edgeband_left: pt.edgeband_left ? {id: pt.edgeband_left, text: String(pt.edgeband_left)} : null,
        edgeband_right: pt.edgeband_right ? {id: pt.edgeband_right, text: String(pt.edgeband_right)} : null,
      });

      $("#partModal").modal("show");
    });
  });

  $("#productsList").on("click", ".btn-delete-part", function () {
    const id = $(this).data("id");
    const pid = $(this).data("pid");
    if (!confirm("Delete this part template?")) return;
    $.ajax({url: API.parts(pid, id), method: "DELETE"})

      .done(() => { showToast("Part deleted", true); fetchPartsTable(pid); });
  });

  $("#partForm").on("submit", function (e) {
    e.preventDefault();

    const pid = $("#part_product").val();   // product id from hidden/select field
    const id = $("#part_id").val();         // part id for edit
    console.log("Submitting part for product id:", pid, "part id:", id);

    const payload = {
      name: $("#part_name").val(),
      part_thickness_mm: $("#part_thickness_mm").val(),
      part_length_equation: $("#part_length_equation").val(),
      part_width_equation: $("#part_width_equation").val(),
      part_qty_equation: $("#part_qty_equation").val(),
      shape_wastage_multiplier: $("#shape_wastage_multiplier").val(),
      edgeband_top: $("#edgeband_top").val() || null,
      edgeband_bottom: $("#edgeband_bottom").val() || null,
      edgeband_left: $("#edgeband_left").val() || null,
      edgeband_right: $("#edgeband_right").val() || null,
    };

    $.ajax({
      url: id ? API.parts(pid, id) : API.parts(pid),  // e.g. /products/{pid}/parts/ or /products/{pid}/parts/{id}/
      method: id ? "PATCH" : "POST",
      contentType: "application/json",
      data: JSON.stringify(payload)
    })
    .done(() => {
      $("#partModal").modal("hide");
      showToast("✅ Part saved", true);
      fetchPartsTable(pid);   // refresh part list for this product
    })
    .fail((xhr) => {
      console.error("❌ Failed to save part:", xhr.responseText);
      showToast("Error saving part", false);
    });
});



  // ---- Search ----
  let searchTimer;
  $("#searchProducts").on("input", function () {
    clearTimeout(searchTimer);
    productSearch = $(this).val();
    searchTimer = setTimeout(() => {
      productPage = 1;
      fetchProducts(productPage);
    }, 250);
  });

  // ---- Escape HTML (avoid XSS from expressions) ----
  function escapeHtml(s) {
    if (s == null) return "";
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---- Init ----
  $(document).ready(() => {
    fetchProducts(productPage).fail((e) => console.error(e));
  });
})();


  let parameters = [];

  // Show modal on "Parameters" button click
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('btn-parameters')) {
      const itemId = e.target.dataset.id;
      // You can filter parameters by itemId if needed
      refreshParameterTable();
      const modal = new bootstrap.Modal(document.getElementById('parametersModal'));
      modal.show();
    }
  });

  // Add parameter
  document.getElementById('addParameterBtn').addEventListener('click', function () {
    const name = document.getElementById('paramName').value.trim();
    const abr = document.getElementById('paramAbr').value.trim();
    const value = parseFloat(document.getElementById('paramValue').value.trim());

    if (!name || !abr || isNaN(value)) {
      alert("Please fill all fields correctly.");
      return;
    }

    parameters.push({ name, abr, value });
    refreshParameterTable();

    // Clear inputs
    document.getElementById('paramName').value = '';
    document.getElementById('paramAbr').value = '';
    document.getElementById('paramValue').value = '';
  });

  // Refresh table
  function refreshParameterTable() {
    const tbody = document.getElementById('parametersTableBody');
    tbody.innerHTML = '';
    parameters.forEach((param, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${param.name}</td>
        <td>${param.abr}</td>
        <td>${param.value}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteParameter(${index})">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // Delete parameter
  function deleteParameter(index) {
    parameters.splice(index, 1);
    refreshParameterTable();
  }


  const API_BASE = "http://127.0.0.1:8000/material/v1";

  let allHardware = [];
  let hardwareGroups = [];

  // Store per-product configuration
  let hardwareConfigs = {}; // productId => { groupId: { hardwareId, quantity } }

  let currentProductId = null;

  // Open modal when button is clicked
  document.addEventListener('click', async function (e) {
    if (e.target.classList.contains('btn-hardware-configurations')) {
      currentProductId = e.target.dataset.id;

      await fetchHardwareData(); // fetch if not already fetched
      renderHardwareModal();
      const modal = new bootstrap.Modal(document.getElementById('hardwareModal'));
      modal.show();
    }
  });

  // Fetch hardware data from API
  async function fetchHardwareData() {
  if (hardwareGroups.length && allHardware.length) return;

  const [groupRes, hwRes] = await Promise.all([
    fetch(`${API_BASE}/hardware-groups/`),
    fetch(`${API_BASE}/hardware/`)
  ]);

  const groupData = await groupRes.json();
  const hardwareData = await hwRes.json();

  hardwareGroups = Array.isArray(groupData) ? groupData : groupData.results;
  allHardware = Array.isArray(hardwareData) ? hardwareData : hardwareData.results;
}


  // Render modal content
  function renderHardwareModal() {
    const container = document.getElementById('hardwareGroupsContainer');
    container.innerHTML = '';

    const config = hardwareConfigs[currentProductId] || {};

    hardwareGroups.forEach(group => {
      const items = allHardware.filter(hw => hw.group === group.id);

      const selectedHardwareId = config[group.id]?.hardwareId || '';
      const selectedQuantity = config[group.id]?.quantity || 1;

      const optionsHTML = items.map(item => `
        <option value="${item.id}" ${item.id == selectedHardwareId ? 'selected' : ''}>
          ${item.name}
        </option>
      `).join('');

      container.innerHTML += `
        <div class="col-md-6 mb-4">
          <h6>${group.name}</h6>
          <div class="input-group">
            <select class="form-select hardware-select" data-group-id="${group.id}">
              <option value="">-- Select ${group.name} --</option>
              ${optionsHTML}
            </select>
            <input type="number" class="form-control hardware-qty" min="1" value="${selectedQuantity}" data-group-id="${group.id}">
          </div>
        </div>
      `;
    });
  }

  // Save current selection on button click
  document.getElementById('saveHardwareConfigBtn').addEventListener('click', function () {
    const selects = document.querySelectorAll('.hardware-select');
    const qtyInputs = document.querySelectorAll('.hardware-qty');

    const config = {};

    selects.forEach(select => {
      const groupId = select.dataset.groupId;
      const hardwareId = select.value;
      const qtyInput = document.querySelector(`.hardware-qty[data-group-id="${groupId}"]`);
      const quantity = parseInt(qtyInput.value) || 1;

      if (hardwareId) {
        config[groupId] = {
          hardwareId,
          quantity
        };
      }
    });

    hardwareConfigs[currentProductId] = config;

    console.log("Saved config for product:", currentProductId);
    console.log(config);

    const modal = bootstrap.Modal.getInstance(document.getElementById('hardwareModal'));
    modal.hide();

    // Optionally POST to backend here
    // saveHardwareToBackend(currentProductId, config);
  });

  // Optional: Save to backend
  async function saveHardwareToBackend(productId, config) {
    try {
      const res = await fetch(`/your-api-endpoint/save-hardware/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          product_id: productId,
          hardware: config
        })
      });

      if (res.ok) {
        alert("Configuration saved!");
      } else {
        alert("Failed to save configuration.");
      }
    } catch (err) {
      console.error("Error saving config:", err);
      alert("Error occurred.");
    }
  }


</script>
{% endblock %}



