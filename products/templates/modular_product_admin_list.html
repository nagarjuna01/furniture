{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Product Admin List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}"> {# Your custom CSS #}
     <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Modular Products</h1>

        {% comment %} <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{% url 'custom-admin-modular-product-configurator' pk=0 %}" class="btn btn-success">Create New Modular Product</a>
            <input type="text" id="searchInput" class="form-control w-25" placeholder="Search products...">
        </div> {% endcomment %}

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Base Price</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productListTableBody">
                    <tr>
                        <td colspan="5" class="text-center">Loading products...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="paginationControls" class="d-flex justify-content-center mt-3">
            </div>

        <div id="statusMessage" class="alert d-none mt-3" role="alert"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const MODULAR_PRODUCTS_API_URL = '/products/api/modular-products/';
        let currentPage = 1;
        const productsPerPage = 10; // You can adjust this

        $(document).ready(function() {
            fetchProducts();

            $('#searchInput').on('keyup', function() {
                currentPage = 1; // Reset to first page on new search
                fetchProducts();
            });
        });

        function fetchProducts() {
    const searchQuery = $('#searchInput').val();
    const offset = (currentPage - 1) * productsPerPage;
    const limit = productsPerPage;

    let apiUrl = `${MODULAR_PRODUCTS_API_URL}?offset=${offset}&limit=${limit}`;
    if (searchQuery) {
        apiUrl += `&search=${encodeURIComponent(searchQuery)}`; // Assuming your API supports a 'search' parameter
    }

    $.ajax({
        url: apiUrl,
        method: 'GET',
        success: function(response) {
            let productsData = [];
            let totalCount = 0;

            // --- START OF ROBUST LOGIC ---
            if (response && typeof response === 'object' && Array.isArray(response.results)) {
                // Scenario 1: API returned expected paginated data (has 'results' array)
                productsData = response.results;
                totalCount = response.count;
            } else if (Array.isArray(response)) {
                // Scenario 2: API returned a direct array (pagination not applied or bypassed)
                productsData = response;
                totalCount = response.length;
            } else {
                // Scenario 3: Unexpected response format (e.g., empty object, error object, or undefined response)
                console.error("API response format unexpected for list view:", response);
                $('#statusMessage').removeClass('d-none alert-success').addClass('alert-danger').text('Error: Unexpected data from product list API. Check console.');
                $('#productListTableBody').html(`<tr><td colspan="5" class="text-center text-danger">Error: Could not parse product data.</td></tr>`);
                return; // Stop further execution
            }
            // --- END OF ROBUST LOGIC ---

            displayProducts(productsData); // Pass the validated and extracted productsData
            renderPagination(totalCount);   // Pass the validated totalCount
            $('#statusMessage').addClass('d-none');
        },
        error: function(xhr, status, error) {
            $('#productListTableBody').html(`<tr><td colspan="5" class="text-center text-danger">Error loading products: ${xhr.responseJSON ? xhr.responseJSON.detail : error}</td></tr>`);
            $('#statusMessage').removeClass('d-none alert-success').addClass('alert-danger').text('Failed to load products.');
        }
    });
}

    function displayProducts(products) {
    const $tableBody = $('#productListTableBody');
    $tableBody.empty();

    if (!Array.isArray(products) || products.length === 0) {
        $tableBody.append('<tr><td colspan="5" class="text-center">No modular products found.</td></tr>');
        return;
    }

    products.forEach(product => {
        const row = `
            <tr>
                <td>${product.id}</td>
                <td>${product.name || 'N/A'}</td>
                <td>${product.price ? parseFloat(product.price).toFixed(2) : 'N/A'}</td>
                <td>${product.category || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${product.id}">Delete</button>
                </td>
            </tr>
        `;
        $tableBody.append(row);
    });

    $('.delete-btn').on('click', function() {
        const productId = $(this).data('id');
        if (confirm(`Are you sure you want to delete product ID ${productId}?`)) {
            deleteProduct(productId);
        }
    });
}


        function renderPagination(totalCount) {
            const $paginationControls = $('#paginationControls');
            $paginationControls.empty();

            const totalPages = Math.ceil(totalCount / productsPerPage);

            if (totalPages <= 1) return; // No pagination needed for 1 or fewer pages

            let paginationHtml = '<nav aria-label="Product list navigation"><ul class="pagination">';
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            paginationHtml += '</ul></nav>';
            $paginationControls.append(paginationHtml);

            $paginationControls.find('.page-link').on('click', function(e) {
                e.preventDefault();
                currentPage = parseInt($(this).data('page'));
                fetchProducts();
            });
        }
const CSRF_TOKEN = $('meta[name="csrf-token"]').attr('content');
        function deleteProduct(productId) {
            $.ajax({
                url: `${MODULAR_PRODUCTS_API_URL}${productId}/`,
                method: 'DELETE',
                 headers: { 'X-CSRFToken': '{{ CSRF_TOKEN }}' }, // Uncomment if authentication is enabled
                success: function() {
                    $('#statusMessage').removeClass('d-none alert-danger').addClass('alert-success').text(`Product ID ${productId} deleted successfully.`);
                    fetchProducts(); // Refresh the list
                },
                error: function(xhr, status, error) {
                    $('#statusMessage').removeClass('d-none alert-success').addClass('alert-danger').text(`Error deleting product ID ${productId}: ${xhr.responseJSON ? xhr.responseJSON.detail : error}`);
                }
            });
        }

    </script>
</body>
</html>