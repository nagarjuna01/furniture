{% extends 'base.html' %}

{% block title %}Product Details{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'products:product_list' %}">Catalog</a></li>
        <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-product-name">Loading...</li>
    </ol>
</nav>

<div id="product-details-container" class="row">
    <div class="col-12 text-center text-muted py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading product details...</span>
        </div>
        <p class="mt-2">Loading product details...</p>
    </div>
</div>

<div class="mt-5">
    <h2>Customer Reviews (<span id="reviews-count">0</span>)</h2>
    <div id="product-reviews-container">
        <p class="text-muted text-center py-3">Loading reviews...</p>
    </div>

    {# Form to submit a new review #}
    {% if user.is_authenticated %}
        <div class="card mt-3">
            <div class="card-header">Leave a Review</div>
            <div class="card-body">
                <form id="reviewForm">
                    {% csrf_token %}
                    <input type="hidden" name="product" id="review-product-id" value="{{ product_pk }}">
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <select class="form-select" id="rating" name="rating" required>
                            <option value="">Select rating</option>
                            <option value="1">1 Star</option>
                            <option value="2">2 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="5">5 Stars</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comment</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            </div>
        </div>
    {% else %}
        <p class="mt-3">Please <a href="{% url 'admin:login' %}">log in</a> to leave a review.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const productSlug = '{{ product_slug }}';
    const productPk = '{{ product_pk }}';
    const productsApiUrl = `/products/api/products/?slug=${productSlug}`;
    const reviewsApiUrl = `/products/api/reviews/`;

    const productDetailsContainer = $('#product-details-container');
    const productReviewsContainer = $('#product-reviews-container');
    const reviewsCountSpan = $('#reviews-count');
    const reviewForm = $('#reviewForm');

    function fetchProductDetails() {
        productDetailsContainer.html(`
            <div class="col-12 text-center text-muted py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading product details...</span>
                </div>
                <p class="mt-2">Loading product details...</p>
            </div>
        `);

        $.ajax({
            url: productsApiUrl,
            method: 'GET',
            success: function(response) {
                productDetailsContainer.empty();
                if (response.results.length === 0) {
                    productDetailsContainer.html('<div class="col-12"><div class="alert alert-warning">Product not found.</div></div>');
                    return;
                }

                const product = response.results[0]; // Assuming slug ensures unique result

                $('#breadcrumb-product-name').text(product.name);
                document.title = `${product.name} - Details`; // Update page title

                let imageUrl = product.image ? product.image : 'https://via.placeholder.com/600x400?text=No+Image';
                let imagesCarousel = '';
                if (product.product_type === 'Standard' && product.images && product.images.length > 0) {
                    imagesCarousel = `
                        <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                ${product.images.map((img, index) => `
                                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                        <img src="${img.image}" class="d-block w-100 rounded" alt="${product.name} image ${index + 1}">
                                    </div>
                                `).join('')}
                            </div>
                            ${product.images.length > 1 ? `
                            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            ` : ''}
                        </div>
                    `;
                } else {
                    imagesCarousel = `<img src="${imageUrl}" class="img-fluid rounded shadow-sm mb-3" alt="${product.name}">`;
                }


                let productSpecificDetails = '';
                if (product.product_type === 'Standard') {
                    productSpecificDetails = `
                        <hr>
                        <h3>Standard Product Details</h3>
                        <p><strong>Section:</strong> ${product.section || 'N/A'}</p>
                        <p><strong>Material:</strong> ${product.material_description || 'N/A'}</p>
                        <p><strong>Color:</strong> ${product.color || 'N/A'}</p>
                        <p><strong>Dimensions:</strong> ${product.length_mm || 'N/A'}mm L x ${product.width_mm || 'N/A'}mm W x ${product.height_mm || 'N/A'}mm H</p>
                        <h4 class="mt-3">Price: <span class="text-success">$${parseFloat(product.sl_price || 0).toFixed(2)}</span></h4>
                        <p class="text-muted">Profit Status: ${product.formatted_break_even_status_standard || 'N/A'} (${product.formatted_profit_margin_standard || 'N/A'})</p>
                        <button class="btn btn-success btn-lg mt-3">Add to Cart</button>
                    `;
                } else if (product.product_type === 'Custom') {
                    productSpecificDetails = `
                        <hr>
                        <h3>Custom Product Details</h3>
                        <p><strong>Design Notes:</strong> ${product.design_notes || 'No specific design notes.'}</p>
                        <p><strong>Manual Purchase Cost:</strong> $${parseFloat(product.manual_purchase_cost || 0).toFixed(2)}</p>
                        <h4 class="mt-3">Manual Selling Price: <span class="text-info">$${parseFloat(product.manual_selling_price || 0).toFixed(2)}</span></h4>
                        <a href="#" class="btn btn-info btn-lg mt-3">Request a Quote</a>
                    `;
                } else if (product.product_type === 'Modular') {
                    productSpecificDetails = `
                        <hr>
                        <h3>Modular Product Base Details</h3>
                        <p>${product.description || 'No description provided for this modular product blueprint.'}</p>
                        <p><strong>Configurable Dimensions:</strong></p>
                        <ul>
                            <li>Length: ${product.length_mm_min || 'N/A'}mm - ${product.length_mm_max || 'N/A'}mm</li>
                            <li>Width: ${product.width_mm_min || 'N/A'}mm - ${product.width_mm_max || 'N/A'}mm</li>
                            <li>Height: ${product.height_mm_min || 'N/A'}mm - ${product.height_mm_max || 'N/A'}mm</li>
                        </ul>
                        <h4 class="mt-3">Base Price: <span class="text-warning">$${parseFloat(product.display_selling_price || 0).toFixed(2)}</span></h4>
                        <p class="text-muted">(This is the default or manually set price. Price varies with configuration.)</p>
                        <a href="/products/configurator/${product.id}/" class="btn btn-primary btn-lg mt-3">Configure This Product</a>
                    `;
                }

                const productHtml = `
                    <div class="col-md-6">
                        ${imagesCarousel}
                    </div>
                    <div class="col-md-6">
                        <h1>${product.name}</h1>
                        <p class="text-muted">${product.product_type}</p>
                        <p><strong>Category:</strong> ${product.category ? product.category.name : 'N/A'}</p>
                        <p><strong>Type:</strong> ${product.type ? product.type.name : 'N/A'}</p>
                        <p><strong>Model:</strong> ${product.model ? product.model.name : 'N/A'}</p>
                        <p><strong>Brand:</strong> ${product.brand ? product.brand.name : 'N/A'}</p>
                        ${productSpecificDetails}
                        <hr>
                        <h4>SEO Information</h4>
                        <p><strong>Slug:</strong> <code>${product.slug}</code></p>
                        <p><strong>Meta Title:</strong> <em>${product.meta_title || 'N/A'}</em></p>
                        <p><strong>Meta Description:</strong> <em>${product.meta_description || 'N/A'}</em></p>
                        <p><strong>Keywords:</strong> <em>${product.keywords || 'N/A'}</em></p>
                    </div>
                `;
                productDetailsContainer.html(productHtml);
                fetchReviews(product.id); // Fetch reviews after product details are loaded
            },
            error: function(xhr, status, error) {
                productDetailsContainer.html(`
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            Failed to load product details: ${xhr.statusText || error}. Please ensure the product slug is correct.
                        </div>
                    </div>
                `);
                console.error("Error fetching product details:", xhr.responseText);
            }
        });
    }

    function fetchReviews(productId) {
        productReviewsContainer.html('<p class="text-muted text-center py-3">Loading reviews...</p>');
        $.ajax({
            url: reviewsApiUrl,
            method: 'GET',
            data: { product: productId },
            success: function(response) {
                productReviewsContainer.empty();
                reviewsCountSpan.text(response.count);

                if (response.results.length === 0) {
                    productReviewsContainer.html('<p>No reviews yet for this product. Be the first to leave one!</p>');
                    return;
                }

                const reviewsHtml = `
                    <div class="list-group">
                        ${response.results.map(review => `
                            <div class="list-group-item list-group-item-action mb-2">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${review.user}</h5>
                                    <small class="text-muted">${new Date(review.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</small>
                                </div>
                                <p class="mb-1">
                                    ${Array(5).fill().map((_, i) =>
                                        i < review.rating ? '<i class="fas fa-star text-warning"></i>' : '<i class="far fa-star text-secondary"></i>'
                                    ).join('')}
                                </p>
                                <p class="mb-1">${review.comment}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                productReviewsContainer.html(reviewsHtml);
            },
            error: function(xhr, status, error) {
                productReviewsContainer.html(`
                    <div class="alert alert-danger" role="alert">
                        Failed to load reviews: ${xhr.statusText || error}.
                    </div>
                `);
                console.error("Error fetching reviews:", xhr.responseText);
            }
        });
    }

    reviewForm.on('submit', function(e) {
        e.preventDefault();
        const formData = {
            product: $('#review-product-id').val(),
            rating: $('#rating').val(),
            comment: $('#comment').val()
        };
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

        $.ajax({
            url: reviewsApiUrl,
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify(formData),
            success: function(response) {
                alert('Review submitted successfully!');
                reviewForm[0].reset(); // Clear the form
                fetchReviews(productPk); // Refresh reviews list
            },
            error: function(xhr, status, error) {
                let errorMessage = 'Error submitting review.';
                if (xhr.responseJSON) {
                    errorMessage = JSON.stringify(xhr.responseJSON);
                }
                alert(errorMessage);
                console.error("Error submitting review:", xhr.responseText);
            }
        });
    });

    // Initial fetch for product details and reviews
    fetchProductDetails();
});
</script>
{% endblock %}