{% extends "base.html" %}
{% block content %}
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Manage Orders</h1>

        <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#orderModal">
            Add Order
        </button>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Total Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="order-list"></tbody>
        </table>
    </div>

    <!-- Modal for Add/Edit Order -->
    <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderModalLabel">Add/Edit Order</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="order-form">
                        <input type="hidden" id="order-id">
                        <div class="form-group">
                            <label for="customer-name">Customer Name</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-email">Customer Email</label>
                            <input type="email" class="form-control" id="customer-email" required>
                        </div>
                        <div class="form-group">
                            <label for="total-price">Total Price</label>
                            <input type="number" class="form-control" id="total-price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="status-select">Status</label>
                            <select class="form-control" id="status-select">
                                <option value="pending">Pending</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="coupon-select">Coupon (optional)</label>
                            <select class="form-control" id="coupon-select"></select>
                        </div>
                        <button type="submit" class="btn btn-success">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = '/api/orders/'; // Adjust this to your API endpoint
        const couponApiUrl = '/api/coupons/'; // Adjust this to your API endpoint for coupons

        $(document).ready(function() {
            fetchOrders();
            fetchCoupons();

            // Fetch all orders
            function fetchOrders() {
                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    success: function(data) {
                        const orderList = $('#order-list');
                        orderList.empty();
                        data.forEach(order => {
                            orderList.append(`
                                <tr>
                                    <td>${order.customer_name}</td>
                                    <td>${order.customer_email}</td>
                                    <td>${order.total_price}</td>
                                    <td>${order.status}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editOrder(${order.id})">Edit</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">Delete</button>
                                    </td>
                                </tr>
                            `);
                        });
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error fetching orders:', textStatus, errorThrown);
                    }
                });
            }

            // Fetch all available coupons
            function fetchCoupons() {
                $.ajax({
                    url: couponApiUrl,
                    method: 'GET',
                    success: function(data) {
                        const couponSelect = $('#coupon-select');
                        couponSelect.empty();
                        couponSelect.append('<option value="">None</option>');
                        data.forEach(coupon => {
                            couponSelect.append(`<option value="${coupon.id}">${coupon.code}</option>`);
                        });
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error fetching coupons:', textStatus, errorThrown);
                    }
                });
            }

            // Handle form submission for adding/editing an order
            $('#order-form').on('submit', function(e) {
                e.preventDefault();
                const id = $('#order-id').val();
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${apiUrl}${id}/` : apiUrl;

                const orderData = {
                    customer_name: $('#customer-name').val(),
                    customer_email: $('#customer-email').val(),
                    total_price: $('#total-price').val(),
                    status: $('#status-select').val(),
                    coupon: $('#coupon-select').val() || null,
                };

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(orderData),
                    headers: {
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function() {
                        fetchOrders();
                        $('#orderModal').modal('hide');
                        $('#order-form')[0].reset();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error saving order:', textStatus, errorThrown);
                    }
                });
            });
        });

        // Edit order function
        window.editOrder = function(id) {
            $.ajax({
                url: `${apiUrl}${id}/`,
                method: 'GET',
                success: function(order) {
                    $('#order-id').val(order.id);
                    $('#customer-name').val(order.customer_name);
                    $('#customer-email').val(order.customer_email);
                    $('#total-price').val(order.total_price);
                    $('#status-select').val(order.status);
                    $('#coupon-select').val(order.coupon ? order.coupon.id : '');
                    $('#orderModal').modal('show');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching order for edit:', textStatus, errorThrown);
                }
            });
        };

        // Delete order function
        window.deleteOrder = function(id) {
            if (confirm('Are you sure you want to delete this order?')) {
                $.ajax({
                    url: `${apiUrl}${id}/`,
                    method: 'DELETE',
                    success: function() {
                        fetchOrders();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error deleting order:', textStatus, errorThrown);
                    }
                });
            }
        };
    </script>
</body>
{% endblock %}
